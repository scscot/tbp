<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Team Build Pro — Einladung einlösen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:0;display:grid;place-items:center;height:100vh}
  .card{max-width:520px;padding:24px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.12)}.btn{background:#0a66ff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  .muted{color:#555}.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:10px 16px;border-radius:8px;display:none}
  #tbp-claim-debug {
    position: fixed; top: 0; left: 0; right: 0; z-index: 10001;
    background: #1a3cff; color: #fff; padding: 8px 12px;
    font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    display: none; box-shadow: 0 2px 10px rgba(0,0,0,.15);
  }
  #tbp-claim-debug code { background: rgba(255,255,255,.12); padding: 2px 6px; border-radius: 6px }
  #tbp-claim-debug a { color: #fff; text-decoration: underline }</style>
</head>
<body>
  <script>
  // --- UNIVERSAL LINK FALLBACK ---
  // If app is installed, this page never loads (handoff happens before navigation).
  // If we're here, the Universal Link did NOT hand off (app likely not installed).
  (function () {
    var qs = location.search;
    var isDebug = /(?:[?&])debug=1(?:[&#]|$)/.test(qs);
    var fromUL = /(?:[?&])_?ul=1(?:[&#]|$)/.test(qs);
    var APP_STORE_URL = 'https://apps.apple.com/us/app/id6751211622';

    // Track if page became hidden (app opened)
    var wentHidden = false;
    document.addEventListener('visibilitychange', function () {
      if (document.hidden) wentHidden = true;
    }, { once: true });

    if (fromUL && !isDebug) {
      // App didn't open, redirect to App Store after brief delay
      setTimeout(function () {
        if (!wentHidden) {
          window.location.replace(APP_STORE_URL);
        }
      }, 1200);
    }
  })();
  </script>
  <div id="tbp-claim-debug">
    <strong>Interner Testmodus — Einlösepfad</strong>
    <span id="tbp-claim-values" style="margin-left:10px"></span>
    <span style="float:right"><a href="#" id="tbp-claim-exit">Beenden</a></span>
  </div>

  <div class="card">
    <h2>Ihre Einladung wird vorbereitet…</h2>
    <p class="muted">Wir kopieren Ihre Einladung und öffnen dann den App Store.</p>
    <p id="status" class="muted">Wird verarbeitet…</p>
    <button id="go" class="btn" style="display:none">Erneut versuchen</button>
  </div>
  <div id="toast" class="toast">Einladung kopiert. App Store wird geöffnet…</div>

<script>
  const APP_STORE_URL = 'https://apps.apple.com/us/app/id6751211622';
  const TBP_FN_BASE = 'https://us-central1-teambuilder-plus-fe74d.cloudfunctions.net';
  const QP = new URLSearchParams(location.search);
  const qp = k => QP.get(k) || '';
  const statusEl = document.getElementById('status');
  const toast = msg => { const el = document.getElementById('toast'); el.textContent = msg; el.style.display='block'; setTimeout(()=>el.style.display='none',2000); };

  // --- Debug banner for claim page ---
  (function(){
    const isDebug = (new URLSearchParams(location.search).get('debug') === '1');
    if (!isDebug) return;

    const token = QP.get('token') || QP.get('tkn') || '';
    const sponsor = QP.get('ref') || QP.get('new') || '';
    const t = QP.get('t') || '';

    const short = (s) => s ? (s.length > 10 ? s.slice(0,6) + '…' + s.slice(-4) : s) : '—';
    const el = document.getElementById('tbp-claim-debug');
    const vals = document.getElementById('tbp-claim-values');

    vals.innerHTML = `
      token: <code>${short(token)}</code>
      &nbsp;|&nbsp; sponsor: <code>${sponsor || '—'}</code>
      &nbsp;|&nbsp; t: <code>${t || '—'}</code>
    `;
    el.style.display = 'block';

    document.getElementById('tbp-claim-exit').onclick = (e)=>{
      e.preventDefault();
      const q = new URLSearchParams(location.search);
      q.delete('debug');
      const next = location.origin + location.pathname + (q.size ? '?' + q.toString() : '');
      history.replaceState(null, '', next);
      location.reload();
    };
  })();

  // Analytics function with sendBeacon (non-blocking UI)
  function tbpLog(event, payload = {}) {
    try {
      const url = `${TBP_FN_BASE}/tbpEventLog`;
      const body = JSON.stringify({
        e: event,
        ts: Date.now(),
        path: location.pathname,
        ref: (qp('ref') || qp('new') || ''),
        ...payload
      });
      navigator.sendBeacon(url, body);
    } catch(_) {}
  }


  // Legacy clipboard copy using execCommand (fallback for iOS)
  function legacyCopy(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand('copy');
    document.body.removeChild(ta);
    return ok;
  }

  async function run() {
    console.log('[claim] start', location.search);

    const sponsor = (qp('ref') || qp('new') || '').trim();
    const t = (qp('t') || '1').trim();
    let token = (qp('tkn') || qp('token') || '').trim();

    console.log('[claim] parsed params => ref:', sponsor, 'tkn:', token ? token.substring(0,8)+'...' : 'null', 't:', t);

    // Organic: no ref → go straight to store
    if (!sponsor && !token) {
      console.log('[claim] organic flow (no ref/token) => redirecting to App Store');
      statusEl.textContent = 'App Store wird geöffnet…';
      setTimeout(()=> location.replace(APP_STORE_URL), 600);
      return;
    }

    try {
      // If token missing but we have sponsor → mint one server-side
      if (!token && sponsor) {
        console.log('[claim] minting token for sponsor:', sponsor);
        const r = await fetch(`${TBP_FN_BASE}/issueReferralV2`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ sponsorCode: sponsor, t, source: 'claim_page' })
        });
        const j = await r.json();
        token = j && j.token ? j.token : '';
        console.log('[claim] token minted:', token ? token.substring(0,8)+'...' : 'failed');
      }

      // If we now have a token, copy TBP payload (clipboard backup)
      if (token) {
        const payload = `TBP_REF:${sponsor};TKN:${token};T:${t};V:2`;
        console.log('[claim] attempting clipboard copy:', payload);

        // Try to copy - with fallback handling for iOS gesture restrictions
        let copied = false;
        try {
          await navigator.clipboard.writeText(payload);
          copied = true;
          console.log('[claim] clipboard.writeText() succeeded');
          tbpLog('web_claim_autocopy');
        } catch (err) {
          console.log('[claim] clipboard.writeText() failed:', err);
          // Try legacy fallback
          try {
            copied = legacyCopy(payload);
            console.log('[claim] legacyCopy() result:', copied);
          } catch (err2) {
            console.log('[claim] legacyCopy() failed:', err2);
          }
        }

        // If both methods failed, show button and wait for user gesture
        if (!copied) {
          console.log('[claim] both clipboard methods failed => showing manual button');

          // Make button huge, primary, and unmissable
          const btn = document.getElementById('go');
          btn.textContent = 'Weiter';
          btn.style.display = 'inline-block';
          btn.style.fontSize = '20px';
          btn.style.padding = '16px 32px';
          btn.style.marginTop = '20px';
          btn.style.backgroundColor = '#0a66ff';
          btn.style.color = '#fff';
          btn.style.border = 'none';
          btn.style.borderRadius = '8px';
          btn.style.cursor = 'pointer';
          btn.style.fontWeight = 'bold';

          statusEl.textContent = 'Tippen Sie unten, um fortzufahren';
          statusEl.style.fontSize = '18px';
          statusEl.style.fontWeight = 'bold';

          document.title = 'Weiter zu Team Build Pro';

          // Auto-focus and scroll into view
          setTimeout(() => {
            btn.scrollIntoView({ behavior: 'smooth', block: 'center' });
            btn.focus();
          }, 100);

          btn.onclick = async () => {
            console.log('[claim] manual button clicked');
            try {
              await navigator.clipboard.writeText(payload);
              tbpLog('web_claim_manual_copy');
            } catch (_) {
              legacyCopy(payload);
            }
            location.replace(APP_STORE_URL);
          };

          // Delayed retry: some iOS versions allow clipboard writes after page settles
          setTimeout(async () => {
            if (!copied) {
              try {
                await navigator.clipboard.writeText(payload);
                copied = true;
                console.log('[claim] delayed retry succeeded - auto-proceeding');
                location.replace(APP_STORE_URL);
              } catch (_) {
                console.log('[claim] delayed retry also failed');
              }
            }
          }, 1500);

          return; // Wait for user to tap button (or delayed retry to succeed)
        }
      }

      // Successfully copied (or no token) - proceed to the App Store
      console.log('[claim] success => redirecting to App Store');
      statusEl.textContent = 'App Store wird geöffnet…';
      setTimeout(()=> location.replace(APP_STORE_URL), 600);
    } catch (e) {
      console.error('[claim] error:', e);
      // Fail-safe: still send them to the store
      statusEl.textContent = 'App Store wird geöffnet…';
      setTimeout(()=> location.replace(APP_STORE_URL), 600);
    }
  }
  run();
</script>
</body>
</html>
