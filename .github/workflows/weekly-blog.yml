name: Weekly Blog Automation

on:
  schedule:
    # Run at 10am PST (6pm UTC) on Monday and Thursday
    # PST = UTC-8 (standard) or UTC-7 (daylight saving)
    # Using 6pm UTC covers 10am PST during standard time
    - cron: '0 18 * * 1,4'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      notify_email:
        description: 'Email for notifications'
        required: false
        default: 'scscot@gmail.com'

env:
  NODE_VERSION: '20'

permissions:
  contents: write

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'scripts/package.json'

      - name: Install script dependencies
        working-directory: scripts
        run: |
          npm install axios form-data
          echo "Dependencies installed"

      - name: Install Firebase CLI
        run: |
          npm install -g firebase-tools
          echo "Firebase CLI installed"

      - name: Run full automation
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MAILGUN_API_KEY: ${{ secrets.MAILGUN_API_KEY }}
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # Set up Firebase credentials
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json

          # Get notification email from input or use default
          NOTIFY_EMAIL="${{ github.event.inputs.notify_email || 'scscot@gmail.com' }}"

          # Run the full automation script
          node scripts/generate-ai-blog.js --full-auto --notify-email="$NOTIFY_EMAIL"

      - name: Deploy to Firebase Hosting
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          # Set up Firebase credentials
          echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/firebase-key.json
          export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json

          # Create .firebaserc with target mappings (file is gitignored)
          cat > .firebaserc << 'EOF'
          {
            "projects": {
              "default": "teambuilder-plus-fe74d"
            },
            "targets": {
              "teambuilder-plus-fe74d": {
                "hosting": {
                  "main": ["teambuilder-plus-fe74d"],
                  "es": ["tbp-es"],
                  "pt": ["tbp-pt"],
                  "de": ["tbp-de"]
                }
              }
            }
          }
          EOF

          # Deploy all hosting targets (EN, ES, PT, DE)
          firebase deploy --only hosting:main,hosting:es,hosting:pt,hosting:de --project teambuilder-plus-fe74d

          echo "Firebase Hosting deployment complete"

      - name: Commit generated files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Add all generated blog files
          git add web/blog/*.html web-es/blog/*.html web-pt/blog/*.html web-de/blog/*.html
          git add web/blog.html web-es/blog.html web-pt/blog.html web-de/blog.html
          git add web/sitemap.xml web-es/sitemap.xml web-pt/sitemap.xml web-de/sitemap.xml
          git add scripts/generate-blog.js
          git add scripts/blog-response.json scripts/blog-recommendations.json || true
          git add scripts/spanish-translation.json scripts/portuguese-translation.json scripts/german-translation.json || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Auto-generated blog post $(date +%Y-%m-%d)

            Generated by Weekly Blog Automation workflow

            Co-Authored-By: Claude <noreply@anthropic.com>"
            git push
          fi

      - name: Clean up
        if: always()
        run: |
          rm -f /tmp/firebase-key.json
          echo "Cleanup complete"
