name: URL Pattern Discovery

on:
  schedule:
    # Run every 4 hours to make incremental progress
    - cron: '0 */4 * * *'

  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      limit:
        description: 'Number of companies to process per run'
        required: false
        default: '40'
        type: string
      skip_validation:
        description: 'Skip URL validation (faster but may include inactive sites)'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'

# Required for git push
permissions:
  contents: write

jobs:
  discover:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'scripts/package.json'

      - name: Install dependencies
        run: |
          cd scripts && npm ci && cd ..
          echo "Dependencies installed"

      - name: Run URL discovery
        run: |
          LIMIT="${{ github.event.inputs.limit || '40' }}"
          SKIP_VALIDATION="${{ github.event.inputs.skip_validation }}"

          echo "Starting URL Pattern Discovery..."
          echo "Limit: $LIMIT companies"

          ARGS="--all --limit=$LIMIT"

          if [ "$SKIP_VALIDATION" = "true" ]; then
            echo "URL Validation: DISABLED"
            ARGS="$ARGS --skip-validation"
          else
            echo "URL Validation: ENABLED"
          fi

          node scripts/base_url_discovery.js $ARGS

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet scripts/patterns.json; then
            echo "No changes to patterns.json"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected in patterns.json"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Count stats for commit message
            TOTAL=$(cat scripts/patterns.json | node -e "console.log(Object.keys(JSON.parse(require('fs').readFileSync(0,'utf8'))).length)")
            ACTIVE=$(cat scripts/patterns.json | node -e "console.log(Object.values(JSON.parse(require('fs').readFileSync(0,'utf8'))).filter(x=>x.urlCount>0).length)")
            INACTIVE=$(cat scripts/patterns.json | node -e "console.log(Object.values(JSON.parse(require('fs').readFileSync(0,'utf8'))).filter(x=>x.type==='inactive').length)")

            echo "total=$TOTAL" >> $GITHUB_OUTPUT
            echo "active=$ACTIVE" >> $GITHUB_OUTPUT
            echo "inactive=$INACTIVE" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated patterns
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add scripts/patterns.json
          git commit -m "Update patterns.json: ${{ steps.check_changes.outputs.total }} companies (${{ steps.check_changes.outputs.active }} active, ${{ steps.check_changes.outputs.inactive }} inactive)"
          git pull --rebase origin main
          git push
