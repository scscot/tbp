<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{PAGE_TITLE}}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: {{PRIMARY_DARK}};
            --primary-blue: {{PRIMARY_BLUE}};
            --accent-gold: {{ACCENT_COLOR}};
            --accent-gold-light: {{ACCENT_COLOR_LIGHT}};
            --text-light: #ffffff;
            --text-muted: #a0aec0;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --border-subtle: rgba(255, 255, 255, 0.1);
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --gradient-primary: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 50%, var(--primary-dark) 100%);
            --gradient-gold: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 50%, var(--accent-gold) 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(201, 169, 98, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-primary);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Hide sidebar CTA when embedded in modal */
        body.embed-mode .sidebar-cta {
            display: none;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: flex;
        }

        /* Landing Screen */
        #landing-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            background: var(--gradient-primary);
            position: relative;
            overflow: hidden;
        }

        #landing-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(201, 169, 98, 0.05) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .landing-content {
            position: relative;
            z-index: 1;
            max-width: 800px;
        }

        .logo-container {
            margin-bottom: 2rem;
        }

        .logo-image {
            max-height: 80px;
            max-width: 300px;
            object-fit: contain;
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-gold);
            letter-spacing: 2px;
        }

        .landing-headline {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .landing-subheadline {
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-bottom: 3rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-button {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1.25rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-dark);
            background: var(--gradient-gold);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-glow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 60px rgba(201, 169, 98, 0.5);
        }

        .cta-button svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .cta-button:hover svg {
            transform: translateX(5px);
        }

        .landing-features {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 4rem;
            padding-top: 3rem;
            border-top: 1px solid var(--border-subtle);
            flex-wrap: nowrap;
            width: 100%;
        }

        @media (max-width: 600px) {
            .landing-features {
                flex-direction: column;
                align-items: center;
                gap: 2rem;
            }
        }

        .feature {
            text-align: center;
            flex: 0 1 auto;
            min-width: 120px;
            max-width: 150px;
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 12px;
            color: var(--accent-gold);
        }

        .feature h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }

        .feature p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .disclaimer {
            margin: 3rem auto 0 auto;
            padding: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            max-width: 600px;
            text-align: center;
            opacity: 0.7;
        }

        /* Consent Screen */
        #consent-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .consent-content {
            max-width: 600px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
        }

        .consent-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--accent-gold);
            margin-bottom: 1.5rem;
        }

        .consent-items {
            text-align: left;
            margin-bottom: 2rem;
        }

        .consent-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            color: var(--text-light);
        }

        .consent-item svg {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            color: var(--accent-gold);
            margin-top: 2px;
        }

        .consent-checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin: 2rem 0;
            padding: 1rem;
            background: rgba(201, 169, 98, 0.1);
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: 8px;
            text-align: left;
        }

        .consent-checkbox {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            accent-color: var(--accent-gold);
            cursor: pointer;
        }

        .consent-checkbox-label {
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: pointer;
        }

        .consent-button {
            padding: 1rem 3rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            background: var(--gradient-gold);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .consent-button.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .consent-button.enabled:hover {
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        /* Chat Screen */
        #chat-screen {
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-subtle);
        }

        .chat-header-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--accent-gold);
        }

        .chat-header-disclosure {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
        }

        .chat-header-disclosure a {
            color: var(--accent-gold);
            text-decoration: none;
            opacity: 0.8;
        }

        .chat-header-disclosure a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .progress-sidebar {
            width: 280px;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
        }

        .progress-title {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: var(--bg-card);
        }

        .progress-step.completed .step-indicator {
            background: var(--success);
            border-color: var(--success);
        }

        .progress-step.completed .step-indicator svg {
            display: block;
        }

        .step-indicator {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-indicator {
            border-color: var(--accent-gold);
            background: var(--accent-gold);
            color: var(--primary-dark);
        }

        .step-indicator svg {
            display: none;
            width: 14px;
            height: 14px;
            color: white;
        }

        .step-text {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .progress-step.active .step-text,
        .progress-step.completed .step-text {
            color: var(--text-light);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 80%;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.assistant { align-self: flex-start; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message.assistant .message-avatar {
            background: var(--accent-gold);
            color: var(--primary-dark);
        }

        .message.user .message-avatar {
            background: var(--primary-blue);
            color: var(--text-light);
        }

        .message-content {
            padding: 1rem 1.25rem;
            border-radius: 16px;
            line-height: 1.6;
        }

        .message.assistant .message-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: var(--primary-blue);
            border-bottom-right-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem 1.25rem;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .response-options {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .response-button {
            padding: 0.625rem 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 25px;
            color: var(--text-light);
            font-size: 0.875rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .response-button:hover {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .response-button.selected {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            pointer-events: none;
        }

        .response-button.multi-select-btn.selected {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            pointer-events: auto;
        }

        .response-button.multi-select-btn.selected::before {
            content: "âœ“ ";
        }

        .response-button.done-button {
            width: 100%;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-help-button {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: none;
            color: #1a1f2e;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-family: Georgia, serif;
            font-size: 16px;
            font-weight: bold;
            font-style: italic;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .info-help-button:hover {
            background: var(--accent-gold);
            color: var(--primary-dark);
            transform: scale(1.1);
        }

        .chat-input-area {
            padding: 1rem 2rem 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border-subtle);
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 50px;
            color: var(--text-light);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: var(--accent-gold);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-gold);
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: var(--shadow-glow);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
        }

        .chat-confidentiality-notice {
            max-width: 800px;
            margin: 0.75rem auto 0;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Loading Screen */
        #loading-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .loading-content {
            text-align: center;
            max-width: 500px;
        }

        .loading-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 2rem;
        }

        .loading-stages {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .loading-stage {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .loading-stage.active {
            opacity: 1;
            border-color: var(--accent-gold);
        }

        .loading-stage.complete {
            opacity: 1;
            border-color: var(--success);
        }

        .loading-stage-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-gold);
        }

        .loading-stage.complete .loading-stage-icon {
            background: var(--success);
            color: white;
        }

        .loading-stage-text {
            text-align: left;
        }

        .loading-stage-text h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .loading-stage-text p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .loading-progress {
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--gradient-gold);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Results Screen - Green */
        #results-screen {
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .results-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .results-subtitle {
            color: var(--text-muted);
        }

        .results-content {
            max-width: 800px;
            width: 100%;
        }

        .routing-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .routing-badge.green {
            background: rgba(72, 187, 120, 0.2);
            border: 2px solid var(--success);
            color: var(--success);
        }

        .routing-badge.yellow {
            background: rgba(237, 137, 54, 0.2);
            border: 2px solid var(--warning);
            color: var(--warning);
        }

        .factors-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .factors-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--accent-gold);
        }

        .factors-list {
            list-style: none;
        }

        .factor-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .factor-item:last-child {
            border-bottom: none;
        }

        .factor-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .factor-icon.positive { color: var(--success); }
        .factor-icon.negative { color: var(--danger); }
        .factor-icon.neutral { color: var(--text-muted); }

        .next-steps-section {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(72, 187, 120, 0.05) 100%);
            border: 1px solid rgba(72, 187, 120, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .next-steps-title {
            font-size: 1.1rem;
            color: var(--success);
            margin-bottom: 1rem;
        }

        .next-steps-text {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .actions-section {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .action-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .action-button.primary {
            background: var(--gradient-gold);
            color: var(--primary-dark);
            border: none;
        }

        .action-button.primary:hover {
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        .action-button.secondary {
            background: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-subtle);
        }

        .action-button.secondary:hover {
            border-color: var(--accent-gold);
        }

        .action-button svg {
            width: 20px;
            height: 20px;
        }

        .results-disclaimer {
            max-width: 800px;
            margin: 2rem auto 0 auto;
            padding: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            opacity: 0.7;
        }

        /* Decline Screen - Red */
        #decline-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .decline-content {
            max-width: 600px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
        }

        .decline-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .decline-message {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .resources-section {
            text-align: left;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .resources-title {
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .resources-list {
            list-style: none;
        }

        .resources-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .resources-list li svg {
            width: 16px;
            height: 16px;
            color: var(--accent-gold);
            flex-shrink: 0;
            margin-top: 3px;
        }

        .decline-disclaimer {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 1rem;
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.2);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .decline-button {
            padding: 1rem 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 50px;
            color: var(--text-light);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .decline-button:hover {
            border-color: var(--accent-gold);
        }

        /* Additional Comments Screen */
        #additional-comments-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .additional-comments-container {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
        }

        #additional-comments-input:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(201, 169, 98, 0.1);
        }

        /* Help Modal */
        .help-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .help-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .help-modal {
            background: var(--primary-dark);
            border: 1px solid var(--accent-gold);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .help-modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-modal-content {
            color: var(--text-light);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .help-modal-close {
            margin-top: 1.5rem;
            padding: 0.75rem 2rem;
            background: var(--accent-gold);
            color: var(--primary-dark);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .help-modal-close:hover {
            box-shadow: var(--shadow-glow);
        }

        /* Responsive */
        /* Sidebar CTA */
        .sidebar-cta {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-subtle);
            text-align: center;
        }

        .sidebar-cta-title {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-gold);
            margin-bottom: 0.75rem;
        }

        .sidebar-cta-text {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .sidebar-cta-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
            padding: 0.875rem 1.25rem;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--primary-dark);
            background: var(--gradient-gold);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .sidebar-cta-button:hover {
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        .sidebar-cta-button svg {
            width: 18px;
            height: 18px;
        }

        .sidebar-return-link {
            display: block;
            margin-top: 1rem;
            font-size: 0.9rem !important;
            color: #c9a962 !important;
            text-decoration: underline !important;
            text-align: center;
        }

        .sidebar-return-link:hover {
            opacity: 0.8;
        }

        /* Results Screen PreIntake Promo */
        .preintake-promo {
            margin-top: 2.5rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-subtle);
            text-align: center;
        }

        .preintake-promo-text {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .preintake-promo-text strong {
            color: var(--accent-gold);
        }

        .preintake-promo-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.875rem 1.75rem;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--accent-gold);
            background: transparent;
            border: 2px solid var(--accent-gold);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .preintake-promo-button:hover {
            background: var(--accent-gold);
            color: var(--primary-dark);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        .preintake-promo-button svg {
            width: 18px;
            height: 18px;
        }

        @media (max-width: 768px) {
            .progress-sidebar {
                display: none;
            }

            .chat-header-disclosure {
                display: none;
            }

            .message {
                max-width: 95%;
            }

            .consent-content,
            .decline-content {
                padding: 1.5rem;
            }
        }

        /* Onboarding Modal */
        .onboarding-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .onboarding-modal.hidden {
            display: none;
        }

        .onboarding-modal-content {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 480px;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .onboarding-modal-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .onboarding-modal-logo span {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }

        .onboarding-modal-content h2 {
            font-family: 'Playfair Display', serif;
            color: var(--accent-gold);
            font-size: 1.75rem;
            margin-bottom: 1.25rem;
        }

        .onboarding-modal-content .firm-name {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.9);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 500;
            margin-bottom: 1.25rem;
        }

        .onboarding-modal-content .firm-name:empty {
            display: none;
        }

        .onboarding-modal-content p {
            color: var(--text-muted);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .onboarding-modal-button {
            background: var(--gradient-gold);
            color: var(--primary-dark);
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .onboarding-modal-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .onboarding-steps {
            text-align: left;
            margin: 1.5rem 0;
            padding: 0;
            list-style: none;
        }

        .onboarding-step {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.875rem;
            color: var(--text-light);
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .onboarding-step:last-child {
            margin-bottom: 0;
        }

        .onboarding-step-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            color: var(--accent-gold);
            margin-top: 2px;
        }

        .onboarding-step-email {
            color: var(--accent-gold);
            font-weight: 500;
        }

        .onboarding-divider {
            height: 1px;
            background: var(--border-subtle);
            margin: 1.5rem 0;
        }
    </style>
</head>
<body>
    <!-- Landing Screen -->
    <div id="landing-screen" class="screen active">
        <div class="landing-content">
            <div class="logo-container">
                {{LOGO_HTML}}
            </div>
            <h1 class="landing-headline">{{LANDING_HEADLINE}}</h1>
            <p class="landing-subheadline">
                {{LANDING_SUBHEADLINE}}
            </p>
            <button class="cta-button" onclick="showConsentScreen()">
                Start My Evaluation
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
            </button>
            <div class="landing-features">
                <div class="feature">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3>Quick & Easy</h3>
                    <p>Complete in under 5 minutes</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h3>Confidential</h3>
                    <p>Your information is secure</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3>No Obligation</h3>
                    <p>Free to complete</p>
                </div>
            </div>
            <p class="disclaimer">
                This evaluation is for informational purposes only and does not create an attorney-client relationship.
            </p>
        </div>
    </div>

    <!-- Consent Screen -->
    <div id="consent-screen" class="screen">
        <div class="consent-content">
            <h2 class="consent-title">Before We Begin</h2>
            <div class="consent-items">
                <div class="consent-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>This evaluation uses AI to help us understand your situation quickly</span>
                </div>
                <div class="consent-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <span>Your information is kept confidential and will only be reviewed by our legal team</span>
                </div>
                <div class="consent-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Information shared before representation is confidential but not privileged</span>
                </div>
            </div>
            <div class="consent-checkbox-container">
                <input type="checkbox" id="consent-checkbox" class="consent-checkbox" onchange="toggleConsentButton()">
                <label for="consent-checkbox" class="consent-checkbox-label">
                    <strong>I understand that no attorney-client relationship is formed by submitting this information.</strong>
                </label>
            </div>
            <button id="consent-button" class="consent-button" onclick="startAssessment()">
                Continue to Evaluation
            </button>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="screen">
        <header class="chat-header">
            <div class="chat-header-logo" id="chat-logo">{{FIRM_NAME}}</div>
            <div class="chat-header-disclosure">AI-assisted intake | No attorney-client relationship<br><a href="https://preintake.ai" target="_blank">Powered by PreIntake.ai</a></div>
        </header>
        <div class="chat-main">
            <aside class="progress-sidebar">
                <h3 class="progress-title">Evaluation Progress</h3>
                <div class="progress-steps">
                    {{PROGRESS_STEPS_HTML}}
                </div>
                <div class="sidebar-cta">
                    <h4 class="sidebar-cta-title">Ready to Go Live?</h4>
                    <p class="sidebar-cta-text">Like what you see? Add PreIntake.ai to your website today.</p>
                    <a href="https://preintake.ai/create-account.html?firm={{LEAD_ID}}" class="sidebar-cta-button" target="_blank">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Get Started
                    </a>
                    <a href="{{RETURN_URL}}" class="sidebar-return-link" target="_blank">Return to PreIntake.ai</a>
                </div>
            </aside>
            <div class="chat-area">
                <div id="chat-messages" class="chat-messages">
                    <!-- Messages will be inserted here -->
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Type your response..." onkeypress="handleKeyPress(event)">
                        <button id="send-button" class="send-button" onclick="sendMessage()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                    <p class="chat-confidentiality-notice">Your information is kept confidential. This tool uses AI to assist with your evaluation and does not constitute legal advice or create an attorney-client relationship.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="screen">
        <div class="loading-content">
            <h2 class="loading-title">Evaluating Your Case</h2>
            <div class="loading-stages">
                {{LOADING_STAGES_HTML}}
            </div>
            <div class="loading-progress">
                <div id="loading-progress-bar" class="loading-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Results Screen (Green/Yellow) -->
    <div id="results-screen" class="screen">
        <header class="results-header">
            <div class="results-logo" id="results-logo">{{FIRM_NAME}}</div>
            <h1 class="results-title">Your Case Evaluation</h1>
            <p class="results-subtitle">Thank you for completing your free case evaluation</p>
        </header>
        <div class="results-content">
            <div style="text-align: center;">
                <div id="routing-badge" class="routing-badge green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="routing-text">We'd Like to Speak With You</span>
                </div>
            </div>

            <div class="factors-section">
                <h3 class="factors-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    Key Factors in Your Case
                </h3>
                <ul id="factors-list" class="factors-list">
                    <!-- Factors will be inserted here -->
                </ul>
            </div>

            <div id="next-steps-section" class="next-steps-section">
                <h3 class="next-steps-title">What Happens Next</h3>
                <p id="next-steps-text" class="next-steps-text">
                    Based on the information you provided, we believe you may have a case worth discussing.
                    A member of our team will contact you within 24 hours to schedule a free consultation.
                </p>
            </div>

            <div id="bottom-actions" class="actions-section">
                <a href="#" id="schedule-button" class="action-button primary" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Schedule Consultation
                </a>
                <button class="action-button secondary" onclick="startOver()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Start Over
                </button>
            </div>

            <!-- PreIntake.ai Promo -->
            <div id="preintake-promo" class="preintake-promo">
                <p class="preintake-promo-text">Add <strong>PreIntake.ai</strong> to the <strong>{{FIRM_NAME}}</strong> website.</p>
                <a href="https://preintake.ai/create-account.html?firm={{LEAD_ID}}" class="preintake-promo-button" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Get Started
                </a>
            </div>

            <!-- Return to Firm (Live Mode only) -->
            <div id="return-to-firm" class="actions-section" style="display: none;">
                <a href="#" id="return-button" class="action-button primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Return to <span id="return-firm-name"></span>
                </a>
            </div>
        </div>
        <p class="results-disclaimer">
            This evaluation is provided for informational purposes only and does not constitute legal advice.
            Every case is unique, and you should consult with a qualified attorney for advice specific to your situation.
            Past results do not guarantee future outcomes.
        </p>
    </div>

    <!-- Decline Screen (Red) -->
    <div id="decline-screen" class="screen">
        <div class="decline-content">
            <h2 class="decline-title">Thank You for Your Submission</h2>
            <p class="decline-message">
                Based on the information provided, <span id="decline-firm-name">{{FIRM_NAME}}</span> may not be the right fit for your situation at this time.
            </p>

            <div class="resources-section">
                <h3 class="resources-title">General Resources</h3>
                <ul class="resources-list">
                    {{DECLINE_RESOURCES_HTML}}
                </ul>
            </div>

            <div class="decline-disclaimer">
                This is not legal advice. Time limits may apply to your situation. Consider consulting with a licensed attorney.
            </div>

            <button class="decline-button" onclick="startOver()">Start New Evaluation</button>
        </div>
    </div>

    <!-- Additional Comments Screen -->
    <div id="additional-comments-screen" class="screen">
        <div class="additional-comments-container">
            <h2 style="color: #ffffff; font-size: 20px; margin-bottom: 15px;">Thank You for Providing Information</h2>
            <p style="color: #e2e8f0; font-size: 16px; margin-bottom: 25px;">Is there anything else you'd like to add?</p>

            <!-- Yes/No Buttons -->
            <div id="comments-buttons" style="display: flex; gap: 15px; justify-content: center; margin-bottom: 20px;">
                <button onclick="showCommentsTextarea()" class="action-button primary" style="min-width: 100px;">
                    Yes
                </button>
                <button onclick="submitWithoutComments()" class="action-button secondary" style="min-width: 100px; background: #f1f5f9; color: #0c1f3f;">
                    No
                </button>
            </div>

            <!-- Textarea (Hidden Initially) -->
            <div id="comments-input-section" style="display: none;">
                <textarea id="additional-comments-input"
                    maxlength="500"
                    placeholder="Please share any additional details, questions, or concerns..."
                    style="width: 100%; height: 120px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 15px; resize: none; font-family: inherit; box-sizing: border-box;"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
                    <span id="char-counter" style="color: #64748b; font-size: 13px;">0 / 500 characters</span>
                    <button onclick="submitWithComments()" class="action-button primary">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal-overlay" class="help-modal-overlay" onclick="closeHelpModal(event)">
        <div class="help-modal" onclick="event.stopPropagation()">
            <div class="help-modal-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="help-modal-title-text">Help</span>
            </div>
            <div id="help-modal-content" class="help-modal-content"></div>
            <button class="help-modal-close" onclick="closeHelpModal()">Got it</button>
        </div>
    </div>

    <!-- Session Recovery Modal -->
    <div id="recovery-modal-overlay" class="help-modal-overlay">
        <div class="help-modal" onclick="event.stopPropagation()" style="text-align: center;">
            <div class="help-modal-title" style="justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                <span>Continue Where You Left Off?</span>
            </div>
            <div class="help-modal-content" style="text-align: center; margin-bottom: 20px;">
                <p id="recovery-name" style="font-size: 1.1rem; color: var(--accent-gold); margin-bottom: 8px;"></p>
                <p style="color: var(--text-muted);">We found your previous conversation. Would you like to continue or start fresh?</p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="startFresh()" class="action-button secondary" style="background: transparent; border: 1px solid var(--border-subtle); color: var(--text-light);">
                    Start Fresh
                </button>
                <button onclick="restoreSession()" class="action-button primary">
                    Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Demo Mode Confirmation Modal -->
    <div id="demo-confirmation-overlay" class="help-modal-overlay">
        <div class="help-modal" onclick="event.stopPropagation()" style="text-align: center; max-width: 400px;">
            <div class="help-modal-title" style="justify-content: center;">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #22c55e;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>Demo Intake Sent!</span>
            </div>
            <div class="help-modal-content" style="text-align: center; margin-bottom: 20px;">
                <p style="color: var(--text-muted); margin-bottom: 12px;">The intake lead has been sent to:</p>
                <p id="demo-confirmation-email" style="font-size: 1.1rem; color: var(--accent-gold); font-weight: 500; word-break: break-all;"></p>
                <p style="color: var(--text-muted); margin-top: 12px; font-size: 0.9rem;">Please check your inbox to see the lead notification email.</p>
            </div>
            <button onclick="closeDemoConfirmation()" style="min-width: 140px; padding: 12px 32px; background: linear-gradient(135deg, #c9a962, #b8860b); color: #fff; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(201, 169, 98, 0.3);">
                OK
            </button>
        </div>
    </div>

    <!-- Demo Limit Reached Modal -->
    <div id="demo-limit-modal" class="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); align-items: center; justify-content: center; z-index: 10000;">
        <div class="modal-content" style="background: white; padding: 2rem; border-radius: 12px; text-align: center; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 480px; margin: 1rem;">
            <h3 style="margin: 0 0 1rem 0; color: #1a3a5c; font-size: 1.5rem;">Thanks for Trying the Demo</h3>
            <p style="margin: 0 0 1.5rem 0; color: #4a5568; line-height: 1.6;">
                Ready to go live on your website?
            </p>
            <a href="https://preintake.ai/create-account.html?firm={{LEAD_ID}}"
               style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 1rem 2rem; background: linear-gradient(135deg, #c9a962, #b8860b); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 1rem; transition: all 0.3s ease;">
                Get Started
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M5 12h14M12 5l7 7-7 7"/>
                </svg>
            </a>
            <p style="margin: 1.5rem 0 0 0; font-size: 0.875rem; color: #718096;">
                Questions? <a href="mailto:support@preintake.ai" style="color: #c9a962;">support@preintake.ai</a>
            </p>
        </div>
    </div>

    <script>
        // Detect embed mode (when loaded in modal iframe)
        if (new URLSearchParams(window.location.search).get('embed') === 'true') {
            document.body.classList.add('embed-mode');
        }

        // Configuration
        const CONFIG = {
            firmName: '{{FIRM_NAME_JS}}',
            proxyUrl: '{{PROXY_URL}}',
            model: '{{MODEL}}',
            webhookUrl: {{WEBHOOK_URL}},
            webhookKey: {{WEBHOOK_KEY}},
            scheduleUrl: {{SCHEDULE_URL}},
            state: '{{STATE}}',
            firmEmail: '{{FIRM_EMAIL}}'
        };

        // Fetch firm status to determine Demo vs Live mode
        let firmStatus = { isLiveMode: false, firmName: CONFIG.firmName, firmWebsite: null };

        // Additional comments state
        let additionalComments = '';
        let pendingAssessment = null;

        async function fetchFirmStatus() {
            try {
                const leadId = CONFIG.webhookKey.replace(/'/g, '');
                const response = await fetch(
                    `https://us-west1-teambuilder-plus-fe74d.cloudfunctions.net/getPreIntakeFirmStatus?leadId=${leadId}`
                );
                if (response.ok) {
                    firmStatus = await response.json();
                }
            } catch (error) {
                console.warn('Could not fetch firm status, defaulting to demo mode');
            }
        }

        // Fetch status on page load
        fetchFirmStatus();

        // Apply firm branding
        document.getElementById('schedule-button').href = CONFIG.scheduleUrl || '#';

        // Rate limit retry configuration
        const MAX_RETRIES = 3;
        const INITIAL_RETRY_DELAY = 5000;

        // State
        let conversationHistory = [];
        let collectedData = {};
        let currentStep = 1;
        let isProcessing = false;
        let apiCallDepth = 0;
        let currentHelpContent = null;
        const TOTAL_STEPS = {{TOTAL_STEPS}};

        // Session Recovery Constants
        const SESSION_KEY = 'preintake_session_{{LEAD_ID}}';
        const SESSION_TTL_HOURS = 24;

        // Save session to localStorage
        function saveSession() {
            if (!collectedData.contact) return; // Only save if we have contact info
            try {
                const session = {
                    conversationHistory,
                    collectedData,
                    currentStep,
                    savedAt: Date.now()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(session));
            } catch (e) {
                console.warn('Could not save session:', e);
            }
        }

        // Load session from localStorage
        function loadSession() {
            try {
                const saved = localStorage.getItem(SESSION_KEY);
                if (!saved) return null;

                const session = JSON.parse(saved);
                const hoursSinceSave = (Date.now() - session.savedAt) / (1000 * 60 * 60);

                if (hoursSinceSave > SESSION_TTL_HOURS) {
                    localStorage.removeItem(SESSION_KEY);
                    return null;
                }

                return session;
            } catch (e) {
                console.warn('Could not load session:', e);
                return null;
            }
        }

        // Clear saved session
        function clearSession() {
            try {
                localStorage.removeItem(SESSION_KEY);
            } catch (e) {
                console.warn('Could not clear session:', e);
            }
        }

        // Check if we have a recoverable session
        function hasRecoverableSession() {
            const session = loadSession();
            return session && session.collectedData?.contact;
        }

        // Demo submission limiting
        const SUBMISSION_COUNT_KEY = 'preintake_demo_count_{{LEAD_ID}}';
        const MAX_DEMO_SUBMISSIONS = 10;

        function getSubmissionCount() {
            try {
                const count = localStorage.getItem(SUBMISSION_COUNT_KEY);
                return count ? parseInt(count, 10) : 0;
            } catch (e) {
                console.warn('Could not get submission count:', e);
                return 0;
            }
        }

        function incrementSubmissionCount() {
            try {
                const count = getSubmissionCount() + 1;
                localStorage.setItem(SUBMISSION_COUNT_KEY, count.toString());
                return count;
            } catch (e) {
                console.warn('Could not increment submission count:', e);
                return 0;
            }
        }

        function hasReachedSubmissionLimit() {
            return getSubmissionCount() >= MAX_DEMO_SUBMISSIONS;
        }

        function showDemoLimitModal() {
            document.getElementById('demo-limit-modal').style.display = 'flex';
        }

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showConsentScreen() {
            showScreen('consent-screen');
        }

        function toggleConsentButton() {
            const checkbox = document.getElementById('consent-checkbox');
            const button = document.getElementById('consent-button');
            if (checkbox.checked) {
                button.classList.add('enabled');
            } else {
                button.classList.remove('enabled');
            }
        }

        // Help modal functions
        function showHelpModal(title, content) {
            document.getElementById('help-modal-title-text').textContent = title;
            document.getElementById('help-modal-content').textContent = content;
            document.getElementById('help-modal-overlay').classList.add('active');
        }

        function closeHelpModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('help-modal-overlay').classList.remove('active');
            }
        }

        // Show demo confirmation modal (Demo mode only)
        function showDemoConfirmation() {
            if (firmStatus.isLiveMode) return; // Only show in Demo mode
            document.getElementById('demo-confirmation-email').textContent = CONFIG.firmEmail;
            document.getElementById('demo-confirmation-overlay').classList.add('active');
        }

        // Close demo confirmation modal
        function closeDemoConfirmation() {
            document.getElementById('demo-confirmation-overlay').classList.remove('active');
        }

        // System prompt (practice-area-specific)
        const SYSTEM_PROMPT = `{{SYSTEM_PROMPT}}`;

        // Tools definition (practice-area-specific)
        const TOOLS = {{TOOLS_JSON}};

        // Loading stages (practice-area-specific)
        const LOADING_STAGES = {{LOADING_STAGES_JSON}};

        // Practice area progress step labels (for dynamic sidebar updates)
        const PRACTICE_AREA_STEPS = {
            'personal injury': ['Basic Information', 'Incident Details', 'Liability Assessment', 'Injuries & Treatment', 'Insurance Details'],
            'immigration': ['Basic Information', 'Immigration Status', 'Case Details', 'Application History', 'Review'],
            'family law': ['Basic Information', 'Case Type', 'Family Details', 'Urgency Assessment', 'Review'],
            'family': ['Basic Information', 'Case Type', 'Family Details', 'Urgency Assessment', 'Review'],
            'tax': ['Basic Information', 'Tax Issue', 'IRS Situation', 'Resolution Options', 'Review'],
            'bankruptcy': ['Basic Information', 'Financial Situation', 'Debt Details', 'Qualification', 'Review'],
            'criminal law': ['Basic Information', 'Charges', 'Case Status', 'Court Details', 'Review'],
            'criminal': ['Basic Information', 'Charges', 'Case Status', 'Court Details', 'Review'],
            'criminal defense': ['Basic Information', 'Charges', 'Case Status', 'Court Details', 'Review'],
            'estate planning': ['Basic Information', 'Planning Needs', 'Asset Overview', 'Special Circumstances', 'Review'],
            'estate': ['Basic Information', 'Planning Needs', 'Asset Overview', 'Special Circumstances', 'Review'],
            'employment law': ['Basic Information', 'Employment Issue', 'Timeline', 'Documentation', 'Review'],
            'employment': ['Basic Information', 'Employment Issue', 'Timeline', 'Documentation', 'Review'],
            'workers compensation': ['Basic Information', 'Injury Details', 'Employer Response', 'Medical Treatment', 'Review'],
            'workers comp': ['Basic Information', 'Injury Details', 'Employer Response', 'Medical Treatment', 'Review'],
            'real estate': ['Basic Information', 'Transaction Type', 'Property Details', 'Timeline', 'Review'],
            'veterans law': ['Basic Information', 'Claim Type', 'Service History', 'Evidence', 'Review'],
            'veterans': ['Basic Information', 'Claim Type', 'Service History', 'Evidence', 'Review'],
            'default': ['Basic Information', 'Case Overview', 'Details', 'Qualification', 'Review']
        };

        // Update progress sidebar when practice area is selected
        function updateProgressSteps(practiceArea) {
            const area = practiceArea.toLowerCase();
            let steps = PRACTICE_AREA_STEPS['default'];

            // Find matching practice area
            for (const [key, value] of Object.entries(PRACTICE_AREA_STEPS)) {
                if (area.includes(key) || key.includes(area)) {
                    steps = value;
                    break;
                }
            }

            // Update the sidebar HTML
            const progressStepsContainer = document.querySelector('.progress-steps');
            if (progressStepsContainer) {
                progressStepsContainer.innerHTML = steps.map((label, i) => `
                    <div class="progress-step${i === 0 ? ' completed' : (i === 1 ? ' active' : '')}" data-step="${i + 1}">
                        <div class="step-indicator">${i + 1}<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <span class="step-text">${label}</span>
                    </div>`).join('');

                console.log('Updated progress steps for:', practiceArea, '->', steps);
            }
        }

        // Check if a value is a practice area selection
        function isPracticeAreaSelection(value) {
            const practiceAreaKeywords = [
                'personal injury', 'immigration', 'family law', 'family', 'tax',
                'bankruptcy', 'criminal law', 'criminal defense', 'criminal',
                'estate planning', 'estate', 'employment law', 'employment',
                'workers compensation', 'workers comp', 'real estate',
                'veterans law', 'veterans'
            ];
            const lowerValue = value.toLowerCase();
            return practiceAreaKeywords.some(keyword =>
                lowerValue === keyword || lowerValue.includes(keyword)
            );
        }

        // Start assessment - check for recoverable session first
        function startAssessment() {
            const session = loadSession();
            if (session && session.collectedData?.contact) {
                // Show recovery modal
                const name = session.collectedData.contact.name || 'there';
                document.getElementById('recovery-name').textContent = `Welcome back, ${name}!`;
                document.getElementById('recovery-modal-overlay').classList.add('active');
                return;
            }

            // No recoverable session, start fresh
            beginFreshAssessment();
        }

        // Begin a fresh assessment (no recovery)
        function beginFreshAssessment() {
            showScreen('chat-screen');
            conversationHistory = [];
            collectedData = {};
            currentStep = 1;
            isProcessing = false;
            apiCallDepth = 0;
            currentHelpContent = null;
            clearSession(); // Clear any stale session data
            updateProgressSteps();

            const initialMessage = { role: "user", content: "{{INITIAL_MESSAGE}}" };
            conversationHistory.push(initialMessage);
            sendToAPI(conversationHistory);
        }

        // User chose to start fresh
        function startFresh() {
            document.getElementById('recovery-modal-overlay').classList.remove('active');
            clearSession();
            beginFreshAssessment();
        }

        // User chose to restore session
        function restoreSession() {
            document.getElementById('recovery-modal-overlay').classList.remove('active');
            const session = loadSession();
            if (!session) {
                beginFreshAssessment();
                return;
            }

            // Restore state
            conversationHistory = session.conversationHistory || [];
            collectedData = session.collectedData || {};
            currentStep = session.currentStep || 1;
            isProcessing = false;
            apiCallDepth = 0;

            // Show chat screen and rebuild conversation display
            showScreen('chat-screen');
            updateProgressSteps();

            // Clear existing messages and re-render conversation
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';

            // Re-render all messages from history (skip system messages)
            for (const msg of conversationHistory) {
                if (msg.role === 'user' || msg.role === 'assistant') {
                    addMessage(msg.content, msg.role, false);
                }
            }

            // Re-enable input and scroll to bottom
            document.querySelector('.chat-input-area').style.display = 'flex';
            messagesContainer.scrollTo({ top: messagesContainer.scrollHeight, behavior: 'smooth' });
        }

        // Update progress steps
        function updateProgressSteps() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
        }

        // Parse AI-specified options from response
        // Format: [OPTIONS: Option 1 | Option 2 | Option 3]
        function parseAIOptions(text) {
            // Check for multi-select format first
            const multiMatch = text.match(/\[OPTIONS-MULTI:\s*([^\]]+)\]/);
            if (multiMatch) {
                const options = multiMatch[1].split('|').map(opt => ({
                    label: opt.trim(),
                    value: opt.trim()
                })).filter(opt => opt.label.length > 0);

                if (options.length === 0) return null;

                const cleanText = text.replace(/\[OPTIONS-MULTI:[^\]]+\]/, '').trim();
                return { text: cleanText, buttons: { multiSelect: true, buttons: options } };
            }

            // Check for single-select format
            const match = text.match(/\[OPTIONS:\s*([^\]]+)\]/);
            if (!match) return null;

            const options = match[1].split('|').map(opt => ({
                label: opt.trim(),
                value: opt.trim()
            })).filter(opt => opt.label.length > 0);

            if (options.length === 0) return null;

            // Return clean text and buttons
            const cleanText = text.replace(/\[OPTIONS:[^\]]+\]/, '').trim();
            return { text: cleanText, buttons: options };
        }

        // Legacy fallback: pattern-matching for edge cases
        {{DETECT_BUTTONS_FUNCTION}}

        // Add message to chat
        function addMessage(content, role, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatarContent = role === 'assistant' ? '{{AVATAR_ICON}}' : 'You';

            // For assistant messages, parse AI-specified options first
            let displayContent = content;
            let detectedResult = null;

            if (role === 'assistant') {
                const aiOptions = parseAIOptions(content);
                if (aiOptions) {
                    displayContent = aiOptions.text;
                    detectedResult = aiOptions.buttons;
                } else {
                    // Fallback to legacy pattern matching
                    detectedResult = detectQuestionButtons(content);
                }
            }

            if (isTyping) {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatarContent}</div>
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                `;
                messageDiv.id = 'typing-indicator';
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${avatarContent}</div>
                    <div class="message-content">${displayContent}</div>
                `;

                if (role === 'assistant' && detectedResult) {
                    document.querySelector('.chat-input-area').style.display = 'none';

                    const helpContent = currentHelpContent;
                    currentHelpContent = null;

                    // Handle both AI-driven (always array) and legacy (array or object with multiSelect)
                    const isMultiSelect = detectedResult.multiSelect === true;
                    const detectedButtons = isMultiSelect ? detectedResult.buttons : (Array.isArray(detectedResult) ? detectedResult : [detectedResult]);

                    setTimeout(() => {
                        const messageContent = messageDiv.querySelector('.message-content');
                            if (messageContent) {
                                const optionsDiv = document.createElement('div');
                                optionsDiv.className = 'response-options';

                                if (isMultiSelect) {
                                    optionsDiv.dataset.multiSelect = 'true';
                                    const selectedValues = new Set();

                                    detectedButtons.forEach(option => {
                                        const button = document.createElement('button');
                                        button.className = 'response-button multi-select-btn';
                                        button.textContent = option.label;
                                        button.dataset.value = option.value;
                                        button.onclick = () => {
                                            if (isProcessing) return;

                                            if (option.value === 'None of these') {
                                                if (button.classList.contains('selected')) {
                                                    button.classList.remove('selected');
                                                    selectedValues.delete(option.value);
                                                } else {
                                                    optionsDiv.querySelectorAll('.multi-select-btn').forEach(btn => {
                                                        btn.classList.remove('selected');
                                                    });
                                                    selectedValues.clear();
                                                    button.classList.add('selected');
                                                    selectedValues.add(option.value);
                                                }
                                            } else {
                                                optionsDiv.querySelectorAll('.multi-select-btn').forEach(btn => {
                                                    if (btn.dataset.value === 'None of these') {
                                                        btn.classList.remove('selected');
                                                        selectedValues.delete('None of these');
                                                    }
                                                });

                                                button.classList.toggle('selected');
                                                if (button.classList.contains('selected')) {
                                                    selectedValues.add(option.value);
                                                } else {
                                                    selectedValues.delete(option.value);
                                                }
                                            }

                                            const doneBtn = optionsDiv.querySelector('.done-button');
                                            if (doneBtn) {
                                                doneBtn.disabled = selectedValues.size === 0;
                                                doneBtn.style.opacity = selectedValues.size === 0 ? '0.5' : '1';
                                            }
                                        };
                                        optionsDiv.appendChild(button);
                                    });

                                    const doneBtn = document.createElement('button');
                                    doneBtn.className = 'response-button done-button';
                                    doneBtn.textContent = 'Done';
                                    doneBtn.disabled = true;
                                    doneBtn.style.opacity = '0.5';
                                    doneBtn.style.marginTop = '10px';
                                    doneBtn.style.backgroundColor = 'var(--accent-gold)';
                                    doneBtn.onclick = () => {
                                        if (isProcessing || selectedValues.size === 0) return;

                                        optionsDiv.querySelectorAll('button').forEach(btn => {
                                            btn.disabled = true;
                                            if (!btn.classList.contains('selected') && !btn.classList.contains('done-button')) {
                                                btn.style.opacity = '0.4';
                                            }
                                        });

                                        const combinedValue = Array.from(selectedValues).join(', ');
                                        addMessage(combinedValue, 'user');
                                        conversationHistory.push({ role: "user", content: combinedValue });
                                        sendToAPI(conversationHistory);
                                    };
                                    optionsDiv.appendChild(doneBtn);
                                } else {
                                    detectedButtons.forEach(option => {
                                        const button = document.createElement('button');
                                        button.className = 'response-button';
                                        button.textContent = option.label;
                                        button.onclick = () => selectOption(button, option.value);
                                        optionsDiv.appendChild(button);
                                    });
                                }

                                if (helpContent) {
                                    const infoBtn = document.createElement('button');
                                    infoBtn.className = 'info-help-button';
                                    infoBtn.title = 'Click for help';
                                    infoBtn.textContent = 'i';
                                    infoBtn.onclick = (e) => {
                                        e.stopPropagation();
                                        showHelpModal(helpContent.title, helpContent.content);
                                    };
                                    optionsDiv.appendChild(infoBtn);
                                }
                                messageContent.appendChild(optionsDiv);

                                setTimeout(() => {
                                    messagesContainer.scrollTo({
                                        top: messagesContainer.scrollHeight,
                                        behavior: 'smooth'
                                    });
                                }, 50);
                            }
                        }, 100);
                    } else {
                        document.querySelector('.chat-input-area').style.display = 'block';
                    }
                }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
            return messageDiv;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function updateTypingMessage(message) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.innerHTML = `<span style="color: var(--accent-gold);">${message}</span>`;
            }
        }

        function selectOption(button, value) {
            if (isProcessing) return;

            button.classList.add('selected');
            document.querySelectorAll('.response-button').forEach(btn => {
                btn.disabled = true;
                if (btn !== button) btn.style.opacity = '0.4';
            });
            document.querySelectorAll('.info-help-button').forEach(btn => {
                btn.disabled = true;
            });

            // Check if this is a practice area selection and update sidebar
            if (isPracticeAreaSelection(value)) {
                updateProgressSteps(value);
            }

            addMessage(value, 'user');
            conversationHistory.push({ role: "user", content: value });
            sendToAPI(conversationHistory);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Email validation function
        function isValidEmail(email) {
            // Basic format check
            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)+$/;
            if (!emailRegex.test(email)) {
                return { valid: false, reason: 'Please enter a valid email address (e.g., jane@email.com)' };
            }

            const domain = email.split('@')[1].toLowerCase();

            // Check for common typos in popular domains
            const typoPatterns = [
                { pattern: /^g{1,2}mail\./, suggestion: 'gmail.com' },
                { pattern: /^gmial\./, suggestion: 'gmail.com' },
                { pattern: /^gmai\./, suggestion: 'gmail.com' },
                { pattern: /^gamil\./, suggestion: 'gmail.com' },
                { pattern: /^gnail\./, suggestion: 'gmail.com' },
                { pattern: /^gmail\.[a-z]{2}$/, suggestion: 'gmail.com' }, // gmail.cm, gmail.co
                { pattern: /^yaho{1,2}\./, suggestion: 'yahoo.com' },
                { pattern: /^yahooo?\./, suggestion: 'yahoo.com' },
                { pattern: /^yhaoo\./, suggestion: 'yahoo.com' },
                { pattern: /^hotmal\./, suggestion: 'hotmail.com' },
                { pattern: /^hotmai\./, suggestion: 'hotmail.com' },
                { pattern: /^hotamil\./, suggestion: 'hotmail.com' },
                { pattern: /^outloo?k\./, suggestion: 'outlook.com' },
                { pattern: /^outlok\./, suggestion: 'outlook.com' }
            ];

            for (const typo of typoPatterns) {
                if (typo.pattern.test(domain) && domain !== typo.suggestion) {
                    return { valid: false, reason: `Did you mean ${email.split('@')[0]}@${typo.suggestion}?` };
                }
            }

            // Check for obviously fake/test domains
            const fakeDomains = ['test.com', 'example.com', 'fake.com', 'asdf.com', 'aaa.com', 'abc.com', 'xxx.com', 'temp.com', 'noemail.com', 'none.com'];
            if (fakeDomains.includes(domain)) {
                return { valid: false, reason: 'Please enter your actual email address so we can follow up with you.' };
            }

            // Check for minimum domain length
            if (domain.length < 4) {
                return { valid: false, reason: 'Please enter a valid email domain.' };
            }

            return { valid: true };
        }

        // Show validation error in chat
        function showEmailValidationError(errorMessage) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message assistant-message email-validation-error';
            errorDiv.innerHTML = `
                <div class="message-content" style="background-color: #fef2f2; border-left: 3px solid #ef4444;">
                    <p style="color: #dc2626; margin: 0;">âš ï¸ ${errorMessage}</p>
                </div>
            `;
            document.getElementById('chat-messages').appendChild(errorDiv);
            document.getElementById('chat-messages').scrollTo({
                top: document.getElementById('chat-messages').scrollHeight,
                behavior: 'smooth'
            });

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.style.opacity = '0';
                    errorDiv.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => errorDiv.remove(), 300);
                }
            }, 5000);
        }

        // Phone validation function
        function isValidPhone(phone) {
            const cleaned = phone.replace(/[^\d+]/g, '');

            // US: 10 digits with optional +1
            const usPattern = /^(\+?1)?[2-9]\d{2}[2-9]\d{6}$/;

            // International: + followed by 7-15 digits
            const intlPattern = /^\+[1-9]\d{6,14}$/;

            if (usPattern.test(cleaned) || intlPattern.test(cleaned)) {
                return { valid: true };
            }

            if (cleaned.length < 10) {
                return { valid: false, reason: 'Phone number appears too short. Please enter a complete phone number.' };
            }
            if (cleaned.length > 15) {
                return { valid: false, reason: 'Phone number appears too long. Please check and re-enter.' };
            }

            return { valid: false, reason: 'Please enter a valid phone number (e.g., (555) 123-4567 or +1 555 123 4567)' };
        }

        // Show phone validation error in chat
        function showPhoneValidationError(errorMessage) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message assistant-message';
            errorDiv.innerHTML = `
                <div class="message-content" style="background-color: #fef2f2; border-left: 3px solid #ef4444;">
                    <p style="color: #dc2626; margin: 0;">${errorMessage}</p>
                </div>
            `;
            document.getElementById('chat-messages').appendChild(errorDiv);
            document.getElementById('chat-messages').scrollTo({
                top: document.getElementById('chat-messages').scrollHeight,
                behavior: 'smooth'
            });

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.style.opacity = '0';
                    errorDiv.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => errorDiv.remove(), 300);
                }
            }, 5000);
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message || isProcessing) return;

            // Check if the message looks like an email (contains @ and .)
            if (message.includes('@') && message.includes('.') && !message.includes(' ')) {
                const emailValidation = isValidEmail(message);
                if (!emailValidation.valid) {
                    showEmailValidationError(emailValidation.reason);
                    input.select();
                    return;
                }
            }

            // Check if input looks like a phone number (mostly digits, 7+ chars)
            const phoneChars = message.replace(/[\d\s\-\(\)\+\.]/g, '');
            const digitCount = (message.match(/\d/g) || []).length;
            if (phoneChars.length === 0 && digitCount >= 7) {
                const phoneValidation = isValidPhone(message);
                if (!phoneValidation.valid) {
                    showPhoneValidationError(phoneValidation.reason);
                    input.select();
                    return;
                }
            }

            input.value = '';
            addMessage(message, 'user');
            conversationHistory.push({ role: "user", content: message });
            sendToAPI(conversationHistory);
        }

        async function sendToAPI(messages, retryCount = 0) {
            apiCallDepth++;
            isProcessing = true;
            document.getElementById('send-button').disabled = true;

            if (retryCount === 0 && !document.getElementById('typing-indicator')) {
                addMessage('', 'assistant', true);
            }

            try {
                const response = await fetch(CONFIG.proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: CONFIG.model,
                        max_tokens: 4096,
                        system: SYSTEM_PROMPT,
                        tools: TOOLS,
                        messages: messages
                    })
                });

                if (response.status === 429 && retryCount < MAX_RETRIES) {
                    const delay = INITIAL_RETRY_DELAY * Math.pow(2, retryCount);
                    updateTypingMessage(`High demand - waiting ${Math.ceil(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return sendToAPI(messages, retryCount + 1);
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error ${response.status}: ${errorData.error?.message || JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                removeTypingIndicator();
                await processResponse(data);

            } catch (error) {
                console.error('API Error:', error);
                removeTypingIndicator();
                addMessage(`I apologize, but I encountered an error. Please refresh and try again.`, 'assistant');
            } finally {
                apiCallDepth--;
                if (apiCallDepth === 0) {
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                }
            }
        }

        async function processResponse(data) {
            let textContent = '';
            let toolUses = [];

            for (const block of data.content) {
                if (block.type === 'text' && block.text) {
                    textContent += block.text;
                } else if (block.type === 'tool_use') {
                    toolUses.push(block);
                }
            }

            const toolResults = [];
            if (toolUses.length > 0) {
                for (const tool of toolUses) {
                    const result = processToolUse(tool);
                    toolResults.push({
                        type: "tool_result",
                        tool_use_id: tool.id,
                        content: result || "Acknowledged"
                    });
                }
            }

            if (textContent) {
                addMessage(textContent, 'assistant');
            }

            const filteredContent = data.content.filter(block => {
                if (block.type === 'text') return block.text && block.text.trim().length > 0;
                return true;
            });

            if (filteredContent.length > 0) {
                conversationHistory.push({ role: "assistant", content: filteredContent });
            }

            if (toolUses.length > 0) {
                const hasComplete = toolUses.some(t => t.name === 'complete_intake');
                if (hasComplete) return;

                if (toolResults.length > 0) {
                    conversationHistory.push({ role: "user", content: toolResults });
                    await sendToAPI(conversationHistory);
                }
            }
        }

        function processToolUse(tool) {
            const { name, input } = tool;

            switch (name) {
                case 'collect_contact_info':
                    collectedData.contact = input;
                    if (currentStep === 1) { currentStep = 2; updateProgressSteps(); }
                    saveSession(); // Save progress for session recovery
                    return "Contact information collected.";

                case 'collect_case_info':
                    collectedData.case_info = input;
                    if (currentStep <= 2) { currentStep = 3; updateProgressSteps(); }
                    saveSession(); // Save progress for session recovery
                    return "Case information collected.";

                case 'collect_details':
                    collectedData.details = input;
                    if (currentStep <= 3) { currentStep = 4; updateProgressSteps(); }
                    saveSession(); // Save progress for session recovery
                    return "Details collected.";

                case 'collect_additional_info':
                    collectedData.additional = input;
                    if (currentStep <= 4) { currentStep = 5; updateProgressSteps(); }
                    saveSession(); // Save progress for session recovery
                    return "Additional information collected.";

                case 'show_question_help':
                    currentHelpContent = {
                        title: input.help_title,
                        content: input.help_content
                    };
                    return "Help content stored.";

                case 'complete_intake':
                    // Check demo submission limit BEFORE processing
                    if (hasReachedSubmissionLimit()) {
                        showDemoLimitModal();
                        return "Demo submission limit reached.";
                    }
                    collectedData.assessment = input;
                    // Check if GREEN or YELLOW - offer additional comments
                    if (input.routing === 'green' || input.routing === 'yellow') {
                        pendingAssessment = input;
                        showScreen('additional-comments-screen');
                        return "Assessment complete. Awaiting additional comments.";
                    } else {
                        // RED routing - skip additional comments
                        clearSession(); // Clear session on successful submission
                        sendWebhook(input);
                        showLoadingScreen(input);
                        return "Assessment complete.";
                    }

                default:
                    return "Tool not recognized.";
            }
        }

        // Format conversation history into readable transcript
        function formatTranscript() {
            const lines = [];
            for (const msg of conversationHistory) {
                if (msg.role === 'user') {
                    // User messages - could be string or tool results array
                    if (typeof msg.content === 'string') {
                        lines.push(`Visitor: ${msg.content}`);
                    }
                    // Skip tool_result arrays (internal)
                } else if (msg.role === 'assistant') {
                    // Assistant messages - extract text blocks only
                    if (Array.isArray(msg.content)) {
                        for (const block of msg.content) {
                            if (block.type === 'text' && block.text) {
                                // Remove [OPTIONS: ...] from display
                                const cleanText = block.text.replace(/\[OPTIONS:.*?\]/g, '').trim();
                                if (cleanText) {
                                    lines.push(`Intake: ${cleanText}`);
                                }
                            }
                        }
                    } else if (typeof msg.content === 'string') {
                        const cleanText = msg.content.replace(/\[OPTIONS:.*?\]/g, '').trim();
                        if (cleanText) {
                            lines.push(`Intake: ${cleanText}`);
                        }
                    }
                }
            }
            return lines.join('\n\n');
        }

        // Send webhook with lead data
        async function sendWebhook(assessment) {
            if (!CONFIG.webhookUrl) return;

            const payload = {
                lead: collectedData.contact || {},
                case_info: collectedData.case_info || {},
                details: collectedData.details || {},
                additional: collectedData.additional || {},
                routing: assessment.routing,
                urgency: assessment.urgency,
                confidence_level: assessment.confidence_level,
                recommended_next_action: assessment.recommended_next_action,
                primary_disqualifier: assessment.primary_disqualifier || null,
                primary_strength_factor: assessment.primary_strength_factor || null,
                key_factors: assessment.key_factors || [],
                // New fields for enhanced email
                ai_screening_summary: assessment.ai_screening_summary || null,
                sol_status: assessment.sol_status || null,
                injuries: assessment.injuries || null,
                treatment_status: assessment.treatment_status || null,
                // Additional comments from client
                additional_comments: assessment.additional_comments || null,
                // Full conversation transcript
                transcript: formatTranscript(),
                timestamp: new Date().toISOString(),
                source: 'preintake-demo-{{LEAD_ID}}'
            };

            try {
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.webhookKey || ''
                    },
                    body: JSON.stringify(payload)
                });
                // Increment demo submission count on successful delivery
                if (response.ok) {
                    const newCount = incrementSubmissionCount();
                    console.log(`Demo submission ${newCount}/${MAX_DEMO_SUBMISSIONS} recorded`);

                    // Notify parent window that intake was completed (for exit confirmation)
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'intake-completed',
                            firmId: '{{LEAD_ID}}'
                        }, '*');
                    }
                }
            } catch (error) {
                console.error('Webhook error:', error);
            }
        }

        function showLoadingScreen(assessment) {
            showScreen('loading-screen');

            const stages = LOADING_STAGES.map(s => s.id);
            let currentStage = 0;
            let progress = 0;

            const progressBar = document.getElementById('loading-progress-bar');

            const stageInterval = setInterval(() => {
                if (currentStage > 0) {
                    document.querySelector(`.loading-stage[data-stage="${stages[currentStage-1]}"]`).classList.remove('active');
                    document.querySelector(`.loading-stage[data-stage="${stages[currentStage-1]}"]`).classList.add('complete');
                }
                if (currentStage < stages.length) {
                    document.querySelector(`.loading-stage[data-stage="${stages[currentStage]}"]`).classList.add('active');
                    currentStage++;
                }
            }, 1000);

            const progressInterval = setInterval(() => {
                progress += 2;
                progressBar.style.width = `${Math.min(progress, 100)}%`;

                if (progress >= 100) {
                    clearInterval(progressInterval);
                    clearInterval(stageInterval);
                    setTimeout(() => showResults(assessment), 500);
                }
            }, 60);
        }

        function showResults(assessment) {
            if (assessment.routing === 'red') {
                showScreen('decline-screen');
                return;
            }

            showScreen('results-screen');

            const routingBadge = document.getElementById('routing-badge');
            const routingText = document.getElementById('routing-text');

            if (assessment.routing === 'green') {
                routingBadge.className = 'routing-badge green';
                routingText.textContent = "We'd Like to Speak With You";
            } else if (assessment.routing === 'yellow') {
                routingBadge.className = 'routing-badge yellow';
                routingText.textContent = "We Need More Information";
            }

            const nextStepsText = document.getElementById('next-steps-text');
            if (assessment.routing === 'green') {
                nextStepsText.textContent = "Based on the information you provided, we believe you may have a case worth discussing. A member of our team will contact you within 24 hours to schedule a free consultation.";
            } else {
                nextStepsText.textContent = "We'd like to learn more about your case before scheduling a consultation. Please gather any relevant documents you may have. We'll reach out to discuss next steps.";
            }

            const factorsList = document.getElementById('factors-list');
            factorsList.innerHTML = '';

            if (assessment.key_factors) {
                assessment.key_factors.forEach((factor, index) => {
                    setTimeout(() => {
                        const li = document.createElement('li');
                        li.className = 'factor-item';
                        const iconClass = factor.impact === 'positive' ? 'positive' :
                                         factor.impact === 'negative' ? 'negative' : 'neutral';
                        const iconPath = factor.impact === 'positive' ? 'M5 13l4 4L19 7' :
                                        factor.impact === 'negative' ? 'M6 18L18 6M6 6l12 12' :
                                        'M20 12H4';
                        li.innerHTML = `
                            <svg class="factor-icon ${iconClass}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}" />
                            </svg>
                            <span class="factor-text">${factor.factor}</span>
                        `;
                        factorsList.appendChild(li);
                    }, index * 150);
                });
            }

            // Handle post-submission display based on mode (uses firmStatus from API call)
            const bottomActions = document.getElementById('bottom-actions');
            const preintakePromo = document.getElementById('preintake-promo');
            const returnToFirm = document.getElementById('return-to-firm');

            if (firmStatus.isLiveMode) {
                // Live Mode: Show only "Return to Firm" button
                if (bottomActions) bottomActions.style.display = 'none';
                if (preintakePromo) preintakePromo.style.display = 'none';
                if (returnToFirm && firmStatus.firmWebsite) {
                    returnToFirm.style.display = 'flex';
                    document.getElementById('return-button').href = firmStatus.firmWebsite;
                    document.getElementById('return-firm-name').textContent = firmStatus.firmName;
                }
            } else {
                // Demo Mode: Show only preintake-promo
                if (bottomActions) bottomActions.style.display = 'none';
                if (preintakePromo) preintakePromo.style.display = 'block';
                if (returnToFirm) returnToFirm.style.display = 'none';

                // Show demo confirmation modal after a brief delay
                setTimeout(() => {
                    showDemoConfirmation();
                }, 800);
            }
        }

        // === Additional Comments Functions ===

        // Show textarea when user clicks "Yes"
        function showCommentsTextarea() {
            document.getElementById('comments-buttons').style.display = 'none';
            document.getElementById('comments-input-section').style.display = 'block';
            document.getElementById('additional-comments-input').focus();
        }

        // Submit without additional comments
        function submitWithoutComments() {
            additionalComments = '';
            finalizeSubmission();
        }

        // Submit with additional comments
        function submitWithComments() {
            additionalComments = document.getElementById('additional-comments-input').value.trim();
            finalizeSubmission();
        }

        // Complete the submission flow
        function finalizeSubmission() {
            if (!pendingAssessment) return;

            // Add additional comments to assessment if provided
            if (additionalComments) {
                pendingAssessment.additional_comments = additionalComments;
            }

            clearSession(); // Clear session on successful submission
            sendWebhook(pendingAssessment);
            showLoadingScreen(pendingAssessment);
            pendingAssessment = null;
        }

        // Initialize character counter on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            const textarea = document.getElementById('additional-comments-input');
            const counter = document.getElementById('char-counter');

            if (textarea && counter) {
                textarea.addEventListener('input', function() {
                    const length = this.value.length;
                    counter.textContent = `${length} / 500 characters`;
                    counter.style.color = length > 450 ? '#ef4444' : '#64748b';
                });
            }
        });

        function startOver() {
            showScreen('landing-screen');
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('consent-checkbox').checked = false;
            document.getElementById('consent-button').classList.remove('enabled');
            conversationHistory = [];
            collectedData = {};
            currentStep = 1;
            isProcessing = false;
            apiCallDepth = 0;
            currentHelpContent = null;
            updateProgressSteps();

            document.querySelectorAll('.loading-stage').forEach(stage => {
                stage.classList.remove('active', 'complete');
            });
            document.getElementById('loading-progress-bar').style.width = '0%';
        }

    </script>

    <!-- Onboarding Modal -->
    <div id="onboarding-modal" class="onboarding-modal">
        <div class="onboarding-modal-content">
            <div class="onboarding-modal-logo">
                <img src="https://preintake.ai/images/icon.png" alt="PreIntake.ai" width="32" height="32">
                <span>PreIntake.ai</span>
            </div>
            <h2>Welcome to Your Demo</h2>
            <div id="onboarding-firm-name" class="firm-name"></div>

            <ul class="onboarding-steps">
                <li class="onboarding-step">
                    <svg class="onboarding-step-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>Complete a sample intake conversation (~2 min)</span>
                </li>
                <li class="onboarding-step">
                    <svg class="onboarding-step-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>See how inquiries are evaluated and summarized</span>
                </li>
                <li class="onboarding-step">
                    <svg class="onboarding-step-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span>Receive a sample lead notification at <span id="onboarding-email" class="onboarding-step-email"></span></span>
                </li>
            </ul>

            <div class="onboarding-divider"></div>

            <p>When you're ready to go live, it embeds directly into your websiteâ€”setup takes just minutes, and visitors never leave your site.</p>
            <button id="onboarding-modal-close" class="onboarding-modal-button">Start Demo</button>
        </div>
    </div>

    <script>
        // Onboarding modal - show once per session
        (function() {
            const modal = document.getElementById('onboarding-modal');
            const closeBtn = document.getElementById('onboarding-modal-close');
            const firmNameDiv = document.getElementById('onboarding-firm-name');
            const emailSpan = document.getElementById('onboarding-email');

            // Use firm name and email from embedded CONFIG
            if (typeof CONFIG !== 'undefined') {
                if (CONFIG.firmName && firmNameDiv) {
                    firmNameDiv.textContent = CONFIG.firmName;
                }
                if (CONFIG.firmEmail && emailSpan) {
                    emailSpan.textContent = CONFIG.firmEmail;
                }
            }

            if (sessionStorage.getItem('preintake_onboarding_seen')) {
                modal.classList.add('hidden');
            }

            closeBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
                sessionStorage.setItem('preintake_onboarding_seen', 'true');

                // Notify parent window that demo has actually started (for view tracking)
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'demo-started',
                        firmId: '{{LEAD_ID}}',
                        firmEmail: CONFIG.firmEmail || ''
                    }, '*');
                }
            });
        })();
    </script>
</body>
</html>
