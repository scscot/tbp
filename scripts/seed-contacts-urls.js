#!/usr/bin/env node
/**
 * Multi-Company URL Seeder - Common Crawl Index
 *
 * Discovers distributor URLs for multiple direct sales companies from
 * Common Crawl Index and seeds them into the direct_sales_contacts
 * Firestore collection.
 *
 * Usage:
 *   node scripts/seed-contacts-urls.js                      # Seed all companies with patterns
 *   node scripts/seed-contacts-urls.js --company=Herbalife  # Seed specific company
 *   node scripts/seed-contacts-urls.js --company=doTERRA --max=100
 *
 * Environment variables:
 *   DRY_RUN - If "true", don't write to Firestore (preview only)
 *   MAX_URLS - Maximum URLs to seed per company (default: 10000)
 *
 * Data sources:
 *   - Common Crawl Index API (no API key required)
 *   - Wayback Machine CDX API (no API key required)
 *   - Certificate Transparency logs via crt.sh (subdomain patterns only)
 * Patterns: patterns.json (generated by base_url_discovery.js)
 */

const admin = require('firebase-admin');
const fs = require('fs');
const path = require('path');

// ============================================================================
// CONFIGURATION
// ============================================================================

const CONFIG = {
  // Pattern file
  PATTERNS_FILE: path.join(__dirname, 'patterns.json'),

  // Common Crawl Index - comprehensive list of indexes to search
  COMMON_CRAWL_INDEXES: [
    // 2026
    'CC-MAIN-2026-04',
    // 2025 (all available)
    'CC-MAIN-2025-51',
    'CC-MAIN-2025-47',
    'CC-MAIN-2025-43',
    'CC-MAIN-2025-38',
    'CC-MAIN-2025-33',
    'CC-MAIN-2025-30',
    'CC-MAIN-2025-26',
    'CC-MAIN-2025-21',
    'CC-MAIN-2025-18',
    'CC-MAIN-2025-13',
    'CC-MAIN-2025-08',
    'CC-MAIN-2025-05',
    // 2024 (all available)
    'CC-MAIN-2024-51',
    'CC-MAIN-2024-46',
    'CC-MAIN-2024-42',
    'CC-MAIN-2024-38',
    'CC-MAIN-2024-33',
  ],
  COMMON_CRAWL_BASE: 'https://index.commoncrawl.org',

  // Firestore
  COLLECTION: 'direct_sales_contacts',
  SOURCE: 'web_index',  // Combined: Common Crawl + Wayback Machine + crt.sh

  // Rate limiting
  DELAY_BETWEEN_REQUESTS: 1000,
  MAX_URLS_PER_COMPANY: 10000,

  // Paths/files to exclude
  EXCLUDED_PATHS: [
    'robots.txt', 'sitemap', 'favicon',
    '/login', '/signin', '/register', '/signup', '/account',
    '/cart', '/checkout', '/admin', '/api/', '/cdn-cgi/',
    '/privacy', '/terms', '/about', '/contact', '/careers',
    '/press', '/blog', '/news', '/help', '/support', '/faq',
    '.pdf', '.jpg', '.png', '.gif', '.css', '.js', '.xml',
  ],

  // Company name mappings (domain -> display name)
  // IMPORTANT: These names are used in email campaigns - must be accurate brand names
  COMPANY_NAMES: {
    // A
    'acn.com': 'ACN',
    'acti-labs.com': 'Acti-Labs',
    'activz.com': 'Activz',
    'aerus.com': 'Aerus',
    'akunashop.com': 'Akuna',
    'allianceinmotion.com': 'Alliance in Motion',
    'aloette.com': 'Aloette',
    'alovea.com': 'Alovea',
    'alphay.com': 'Alphay',
    'amare.com': 'Amare Global',
    'ambitenergy.com': 'Ambit Energy',
    'amc.info': 'AMC Cookware',
    'ameriplan.com': 'AmeriPlan',
    'amakhaparis.com.br': 'Amakha Paris',
    'amorepacific.com': 'AmorePacific',
    'amway.com': 'Amway',
    'anovite.com': 'Anovite',
    'aplgo.com': 'APL GO',
    'aquasource.co.uk': 'AquaSource',
    'arbonne.com': 'Arbonne',
    'aregolife.com': 'Arego Life',
    'arieyl.com': 'Arieyl',
    'arsoa.co.jp': 'Arsoa',
    'arvea-nature.com': 'Arvea Nature',
    'asciraglobal.com': 'Ascira Global',
    'asclepiuswellness.com': 'Asclepius Wellness',
    'aseaglobal.com': 'ASEA Global',
    'asiliglobal.com': 'Asili Global',
    'athenas.com': 'Athenas',
    'atomy.com': 'Atomy',
    'audere.com': 'Audere',
    'auvoriaprime.com': 'Auvoria Prime',
    'avenaoriginals.com': 'Avena Originals',
    'avon.com': 'Avon',
    'awakend.com': 'Awakend',
    'axxaglobal.com': 'Axxa Global',
    // B
    'www.barefootbooks.com': 'Barefoot Books',
    'be.club': 'BE Club',
    'beautysociety.com': 'Beauty Society',
    'www.belcorp.biz': 'Belcorp',
    'bellagrace.com': 'Bella Grace',
    'bellame.com': 'Bellame',
    'beneve.com': 'Beneve',
    'www.bepic.com': 'B-Epic',
    'www.betterware.com.mx': 'Betterware',
    'beyondslim.com': 'Beyond Slim',
    'beyuna.com': 'Beyuna',
    'bfsuma.com': 'BF Suma',
    'bhipglobal.com': 'BHIP Global',
    'bioreigns.com': 'BioReigns',
    'bodepro.com': 'Bode Pro',
    'bodi.com': 'BODi',
    'bodylogic.com': 'Body Logic',
    'bofrost.com': 'Bofrost',
    'www.boissetcollection.com': 'Boisset Collection',
    'bombparty.com': 'Bomb Party',
    'boncook.com': 'Bon Cook',
    'bonvera.com': 'Bonvera',
    'bravenlyglobal.com': 'Bravenly Global',
    'bwlgroup.com': 'BWL Group',
    'bydzyne.com': 'ByDzyne',
    // C
    'www.cabionline.com': 'Cabi',
    'calerie.com': 'Calerie',
    'cannaglobe.com': 'Canna Globe',
    'captain-tortue.com': 'Captain Tortue',
    'carico.com': 'Carico',
    'celebratinghome.com': 'Celebrating Home',
    'cerule.com': 'Cerule',
    'chalkcouture.com': 'Chalk Couture',
    'chalkyandcompany.com': 'Chalky & Company',
    'charle.co.jp': 'Charle',
    'chogangroupspa.com': 'Chogan Group',
    'cili.com': 'CILI',
    'clearunited.com': 'Clear United',
    'closetomyheart.com': 'Close to My Heart',
    'colormebeautiful.com': 'Color Me Beautiful',
    'colwayinternational.com': 'Colway International',
    'compelling-creations.com': 'Compelling Creations',
    'conklin.com': 'Conklin',
    'coral-club.com': 'Coral Club',
    'corvive.com': 'Corvive',
    'www.cosway.com.my': 'Cosway',
    'coway.com': 'Coway',
    'www.creativememories.com': 'Creative Memories',
    'crowd1.com': 'Crowd1',
    'cutco.com': 'Cutco',
    // D
    'daisybluenaturals.com': 'Daisy Blue Naturals',
    'www.damselindefense.com': 'Damsel in Defense',
    'deesse.com': 'Deesse',
    'destina1.com': 'Destina',
    'doterra.com': 'doTERRA',
    'dr-juchheim.de': 'Dr. Juchheim',
    'dreamtrips.com': 'DreamTrips',
    'dudleyq.com': 'Dudley Q',
    'duolife.eu': 'DuoLife',
    'dxn2u.com': 'DXN',
    // E
    'eaconomy.com': 'Eaconomy',
    'eazyways.com': 'Eazy Ways',
    'edmark.com': 'Edmark',
    'eexcel.com': 'E. Excel',
    'elken.com': 'Elken',
    'elomir.com': 'Elomir',
    'eminenceorganics.com': 'Eminence Organics',
    'enagic.com': 'Enagic',
    'energetix.tv': 'Energetix',
    'eniva.com': 'Eniva',
    'enzacta.com': 'Enzacta',
    'epictrading.com': 'Epic Trading',
    'eqology.com': 'Eqology',
    'essanteorganics.com': 'Essante Organics',
    'essensworld.com': 'Essens',
    'essentialbodywear.com': 'Essential Bodywear',
    'eternalspiritbeauty.com': 'Eternal Spirit Beauty',
    'evergreenlife.it': 'Evergreen Life',
    'exialoe.es': 'Exialoe',
    'exprealty.com': 'eXp Realty',
    // F
    'faberlic.com': 'Faberlic',
    'familyfirstlife.com': 'Family First Life',
    'farmasi.com': 'Farmasi',
    'fifthavenuecollection.com': 'Fifth Avenue Collection',
    'firstfitness.com': 'First Fitness',
    'fitteam.com': 'FitTeam',
    'www.flavongroup.com': 'Flavon Group',
    'fmworld.com': 'FM World',
    'foreverliving.com': 'Forever Living',
    'frequense.com': 'Frequense',
    'futureglobalvision.com': 'Future Global Vision',
    'fuxion.com': 'FuXion',
    // G
    'ganoexcel.com': 'Gano Excel',
    'gelmoment.com': 'GelMoment',
    'genistar.co.uk': 'Genistar',
    'giffarine.com': 'Giffarine',
    'glazetrading.com': 'Glaze Trading',
    'globallee.com': 'Global Lee',
    'gofinity.com': 'GoFinity',
    'goldcanyon.com': 'Gold Canyon',
    'govvi.com': 'Govvi',
    'www.greencompassglobal.com': 'Green Compass',
    'greenwayglobal.com': 'Greenway Global',
    'grupohinode.com': 'Grupo Hinode',
    // H
    'h2oathome.com': 'H2O at Home',
    'ha-ra.de': 'Ha-Ra',
    'hb-naturals.com': 'HB Naturals',
    'hcwellness.com': 'HC Wellness',
    'healthgarde.com': 'HealthGarde',
    'healy.shop': 'Healy',
    'hegemon-group.com': 'Hegemon Group',
    'heim-und-haus.de': 'Heim & Haus',
    'hempmate.com': 'HempMate',
    'herbalife.com': 'Herbalife',
    'homm.com.tr': 'HOMM',
    'hteusa.com': 'HTE USA',
    'hughandgrace.com': 'Hugh & Grace',
    'hulsabrands.com': 'Hulsa Brands',
    'www.hycite.com': 'Hy Cite',
    // I
    'iam-worldwide.com': 'I Am Worldwide',
    'iamtruu.com': 'I Am Truu',
    'ibuumerang.com': 'iBuumerang',
    'idlife.com': 'IDLife',
    'igeniusglobal.com': 'iGenius',
    'ihub.global': 'iHub Global',
    'illuminent.com': 'Illuminent',
    'immunotec.com': 'Immunotec',
    'impactglobal.com': 'Impact Global',
    'incruises.com': 'inCruises',
    'initialoutfitters.com': 'Initial Outfitters',
    'inkavida.com': 'Inkavida',
    'innov8tivenutrition.com': 'Innov8tive Nutrition',
    'inspiranzadesigns.com': 'Inspiranza Designs',
    'inuka.co.za': 'Inuka',
    'iphytoscience.com': 'iPhyto Science',
    'isagenix.com': 'Isagenix',
    'itworks.com': 'It Works!',
    // J
    'javamomma.com': 'Java Momma',
    'jbloomdesigns.com': 'JBloom Designs',
    'jeunesseglobal.com': 'Jeunesse',
    'jhilburn.com': 'J.Hilburn',
    'jifu.com': 'JIFU',
    'jordanessentials.com': 'Jordan Essentials',
    'joymain.com': 'Joymain',
    'jrwatkins.com': 'J.R. Watkins',
    'juiceplus.com': 'Juice Plus+',
    'jumptohealth.com': 'Jump to Health',
    'just-international.com': 'Just International',
    'juuva.com': 'Juuva',
    // K
    'kalaia.com': 'Kalaia',
    'kangmeius.com': 'Kangmei',
    'kannaway.com': 'Kannaway',
    'karavita.com': 'Kara Vita',
    'kirby.com': 'Kirby',
    'kitchenfair.com.mx': 'Kitchen Fair',
    // L
    'lavylites.com': 'Lavylites',
    'lbri.com': 'L\'Bri',
    'le-vel.com': 'Le-Vel',
    'legalshield.com': 'LegalShield',
    'lemongrassspa.com': 'Lemongrass Spa',
    'lifeabundance.com': 'Life\'s Abundance',
    'lifeactivated.com': 'Life Activated',
    'lifeleadership.com': 'Life Leadership',
    'www.lifepharm.com': 'LifePharm',
    'lifeplus.com': 'Life Plus',
    'lifevantage.com': 'LifeVantage',
    'lifewave.com': 'LifeWave',
    'lillarose.com': 'Lilla Rose',
    'limelifebyalcone.com': 'LimeLife by Alcone',
    'livegood.com': 'LiveGood',
    'livepure.com': 'LivePure',
    'longrich.com': 'Longrich',
    'www.lordeandbelle.com': 'Lorde and Belle',
    'lorrainelea.com': 'Lorraine Lea',
    'lovebiome.com': 'LoveBiome',
    'lovewinx.com': 'LoveWinx',
    'lrworld.com': 'LR Health & Beauty',
    'lularoe.com': 'LuLaRoe',
    'lumivitae.com': 'Lumi Vitae',
    'lurralife.com': 'Lurra Life',
    'luume.com': 'Luume',
    'luxinternational.com': 'Lux International',
    // M
    'magnabilities.com': 'Magnabilities',
    'magnessa.com': 'Magnessa',
    'magnetix-wellness.com': 'Magnetix Wellness',
    'mannatech.com': 'Mannatech',
    'marketamerica.com': 'Market America',
    'maruko.com': 'Maruko',
    'marykay.com': 'Mary Kay',
    'mavie.global': 'MaVie Global',
    'max.com': 'Max International',
    'melaleuca.com': 'Melaleuca',
    'metrin.com': 'Metrin',
    'mi-lifestyle.com': 'Mi Lifestyle',
    'miessence.com': 'Miessence',
    'miki.co.jp': 'Miki',
    'mined.world': 'Mined',
    'miraburst.com': 'Mira Burst',
    'modere.com': 'Modere',
    'modicare.com': 'Modicare',
    'monatglobal.com': 'Monat',
    'mwrfinancial.com': 'MWR Financial',
    'mwrlife.com': 'MWR Life',
    'myctfo.com': 'CTFO',
    'mydailychoice.com': 'MyDailyChoice',
    'myecon.net': 'MyEcon',
    'myvestige.com': 'Vestige',
    // N
    'n8essentials.com': 'N8 Essentials',
    'naris.co.jp': 'Naris Cosmetics',
    'www.natura.com': 'Natura',
    'naturavitalis.com': 'Natura Vitalis',
    'naturessunshine.com': 'Nature\'s Sunshine',
    'naturallyplus.com': 'Naturally Plus',
    'nefful.com.sg': 'Nefful',
    'nelolife.com': 'Nelo Life',
    'neolife.com': 'NeoLife',
    'neora.com': 'Neora',
    'netsurfnetwork.com': 'Netsurf Network',
    'neumi.com': 'Neumi',
    'nevetica.com': 'Nevetica',
    'newearth.com': 'New Earth',
    'newgendirect.com': 'NewGen Direct',
    'newhopeglobal.com': 'New Hope Global',
    'newimage.com': 'New Image',
    'newulife.com': 'NewULife',
    'nexarise.com': 'NexaRise',
    'nexusrewards.com': 'Nexus Rewards',
    'nhtglobal.com': 'NHT Global',
    'nikken.com': 'Nikken',
    'noondaycollection.com': 'Noonday Collection',
    'norwex.com': 'Norwex',
    'novaemm.com': 'Nova EMM',
    'nowsite.online': 'Now Lifestyle',
    'nui.social': 'Nui',
    'nuskin.com': 'Nu Skin',
    'nutrimetics.com': 'Nutrimetics',
    'nvu.com': 'NVU',
    'us.nyrorganic.com': 'NYR Organic',
    // O
    'oboticario.com': 'O Boticário',
    'olbali.com': 'Olbali',
    'olivetreepeople.com': 'Olive Tree People',
    'omnilife.com': 'Omnilife',
    'onemoreinternational.com': 'One More International',
    'onehopewine.com': 'OneHope Wine',
    'optavia.com': 'Optavia',
    'optidee.com': 'Optidee',
    'opulence.com': 'Opulence Global',
    'organogold.com': 'Organo Gold',
    'oriflame.com': 'Oriflame',
    'origamiowl.com': 'Origami Owl',
    'oxoglobal.com': 'OXO Global',
    // P
    'www.pamperedchef.com': 'Pampered Chef',
    'paparazziaccessories.com': 'Paparazzi Accessories',
    'parklanejewelry.com': 'Park Lane Jewelry',
    'partner.co': 'Partner.Co',
    'partylite.com': 'PartyLite',
    'pawtree.com': 'PawTree',
    'www.perfectlyposh.com': 'Perfectly Posh',
    'www.pfaonline.com': 'PFA Online',
    'www.phpagency.com': 'PHP Agency',
    'pieroth.com': 'Pieroth',
    'pinkzebrahome.com': 'Pink Zebra',
    'plannetmarketing.com': 'PlanNet Marketing',
    'plexusworldwide.com': 'Plexus',
    'plunderdesign.com': 'Plunder Design',
    'pm-international.com': 'PM-International',
    'polishop.com': 'Polishop',
    'pomifera.com': 'Pomifera',
    'powur.com': 'Powur',
    'prifeinternational.com': 'Prife International',
    'primemybody.com': 'Prime My Body',
    'primerica.com': 'Primerica',
    'princesshouse.com': 'Princess House',
    'pruvitnow.com': 'Prüvit',
    'pureromance.com': 'Pure Romance',
    'purium.com': 'Purium',
    // Q
    'qnet.net': 'QNET',
    'qneurope.com': 'QN Europe',
    'qsciences.com': 'Q Sciences',
    'quiari.com': 'QuiAri',
    'qyral.com': 'Qyral',
    // R
    'raccocosmeticos.com.br': 'Racco Cosméticos',
    'radiantlyyou.com': 'Radiantly You',
    'rainintl.com': 'Rain International',
    'rbclife.com': 'RBC Life',
    'realtimerelief.com': 'Real Time Relief',
    'www.redaspenlove.com': 'Red Aspen',
    'regalware.com': 'Regal Ware',
    'regenalife.com': 'Regena Life',
    'www.reico-vital.de': 'Reico Vital',
    'reliv.com': 'Reliv',
    'renaware.com': 'Rena Ware',
    'revitalu.com': 'Revital U',
    'rexair.com': 'Rexair (Rainbow)',
    'riman.com': 'Riman',
    'ringana.com': 'Ringana',
    'royalebusinessclub.com': 'Royale Business Club',
    'rubyribbon.com': 'Ruby Ribbon',
    // S
    'sabaforlife.com': 'Saba',
    'sabika-jewelry.com': 'Sabika',
    'sahajidahhai-o.com.my': 'Hai-O',
    'saladmaster.com': 'Saladmaster',
    'samidirect.com': 'Sami Direct',
    'www.sankiglobal.com': 'Sanki Global',
    'savingshighwayglobal.com': 'Savings Highway Global',
    'savvi.com': 'Savvi',
    'scentsy.com': 'Scentsy',
    'scoutandcellar.com': 'Scout & Cellar',
    'seacretdirect.com': 'Seacret',
    'sendoutcards.com': 'SendOutCards',
    'senegence.com': 'SeneGence',
    'shaklee.com': 'Shaklee',
    'shinecosmetics.com': 'Shine Cosmetics',
    'shoply.com': 'Shoply',
    'sibubeauty.com': 'Sibu Beauty',
    'siberianwellness.com': 'Siberian Wellness',
    'signaturehomestyles.com': 'Signature HomeStyles',
    'silkoilofmorocco.com': 'Silk Oil of Morocco',
    'silvericing.com': 'Silver Icing',
    'simply-naturals.com': 'Simply Naturals',
    'simplyfun.com': 'SimplyFun',
    'simplysaidinc.com': 'Simply Said',
    'siselinternational.com': 'Sisel International',
    'snep.com': 'SNEP',
    'solspeopleshop.com': 'Sols People',
    'soluni.com': 'Soluni',
    'solvasabeauty.com': 'Solvasa Beauty',
    'sorgenta.com': 'Sorgenta',
    'southwesternadvantage.com': 'Southwestern Advantage',
    'souvre.com': 'Souvre',
    'spxnutrition.com': 'SPX Nutrition',
    'stampinup.com': 'Stampin\' Up!',
    'www.steepedtea.com': 'Steeped Tea',
    'stelladot.com': 'Stella & Dot',
    'stemtech.com': 'Stemtech',
    'styledots.com': 'Style Dots',
    'successmore.com': 'Success More',
    'sunrun.com': 'Sunrun',
    'www.sunrider.com': 'Sunrider',
    'superpatch.com': 'Super Patch',
    'superlifeworld.com': 'SuperLife',
    'surge365.com': 'Surge365',
    'swissjust.com': 'Swiss Just',
    'synergyworldwide.com': 'Synergy WorldWide',
    // T
    'talkfusion.com': 'Talk Fusion',
    'www.tastefullysimple.com': 'Tastefully Simple',
    'tavalifestyle.com': 'Tava Lifestyle',
    'www.tealightful.com': 'TeaLightful',
    'teomaglobal.com': 'Teoma Global',
    'thanks.ai': 'Thanks AI',
    'thecode.com': 'The Code',
    'thehappyco.com': 'The Happy Co.',
    'www.therealbrokerage.com': 'The Real Brokerage',
    'therootbrands.com': 'The Root Brands',
    'threeinternational.com': 'Three International',
    'www.thrivelife.com': 'Thrive Life',
    'tiande.com': 'TianDe',
    'tiens.com': 'Tiens',
    'tocara.com': 'Tocara',
    'toribellecosmetics.com': 'Tori Belle',
    'totallifechanges.com': 'Total Life Changes',
    'touchstonecrystal.com': 'Touchstone Crystal',
    'touchstoneessentials.com': 'Touchstone Essentials',
    'tranont.com': 'Tranont',
    'travelingvineyard.com': 'Traveling Vineyard',
    'travorium.com': 'Travorium',
    'www.trevocorporate.com': 'Trevo',
    'truiqglobal.com': 'TruIQ Global',
    'www.truvy.com': 'Truvy',
    // U
    'unicity.com': 'Unicity',
    'univera.com': 'Univera',
    'upessencia.com.br': 'Up Essência',
    'urworthit.com': 'UR Worth It',
    'usana.com': 'USANA',
    'www.usborne.com': 'Usborne Books',
    'uw.co.uk': 'Utility Warehouse',
    // V
    'vabo-n.com': 'Vabo-N',
    'valentus.com': 'Valentus',
    'vegascosmetics.de': 'Vegas Cosmetics',
    'velovita.com': 'Velovita',
    'vertera.com': 'Vertera',
    'vfinity.com': 'VFinity',
    'victoria-benelux.com': 'Victoria Benelux',
    'vidadivina.com': 'Vida Divina',
    'vidafyglobal.com': 'Vidafy',
    'vieroots.com': 'VieRoots',
    'viiva.com': 'Viiva',
    'visi-global.com': 'Visi',
    'vitalhealthglobal.com': 'Vital Health Global',
    'vitamist.com': 'Vitamist',
    'www.vivint.com': 'Vivint',
    'vivri.com': 'Vivri',
    'vorwerk.com': 'Vorwerk',
    'voxxlife.com': 'Voxx Life',
    'vyvo.com': 'Vyvo',
    // W
    'wewe.global': 'WeWe Global',
    'wellnesspro.com': 'Wellness Pro',
    'wellstar.de': 'Wellstar',
    'welltures.com': 'Welltures',
    'www.wfgconnect.com': 'World Financial Group',
    'wildtree.com': 'Wildtree',
    'wineshop-at-home.com': 'WineShop At Home',
    'winworldwide.com': 'Win Worldwide',
    'worldbook.com': 'World Book',
    'wsb.com': 'WSB',
    // X
    'xelliss.com': 'Xelliss',
    'xendurance.com': 'Xendurance',
    'xooma.com': 'Xooma',
    'xpirient.com': 'Xpirient',
    'xyngular.com': 'Xyngular',
    // Y
    'yanbal.com': 'Yanbal',
    'yanoli.com': 'Yanoli',
    'yoli.com': 'Yoli',
    'yorhealth.com': 'Yor Health',
    'youniqueproducts.com': 'Younique',
    'youngevity.com': 'Youngevity',
    'youngliving.com': 'Young Living',
    // Z
    'zermat.com': 'Zermat',
    'zhulian.com.my': 'Zhulian',
    'zilis.com': 'Zilis',
    'zinzino.com': 'Zinzino',
    'zurvita.com': 'Zurvita',
    // Third-party platforms (Elify, etc.)
    'elify.com': 'Elify',
    '4life.com': '4Life',
    '7kmetals.com': '7K Metals',
  },
};

// ============================================================================
// FIREBASE INITIALIZATION
// ============================================================================

function initializeFirebase() {
  const serviceAccountPath = path.join(__dirname, '..', 'secrets', 'serviceAccountKey.json');

  if (!admin.apps.length) {
    admin.initializeApp({
      credential: admin.credential.cert(require(serviceAccountPath))
    });
  }

  return admin.firestore();
}

// ============================================================================
// BLOCKED PLATFORMS (from Firestore, shared with contacts-scraper)
// ============================================================================

/**
 * Load blocked platforms from Firestore (set by contacts-scraper.js)
 * Returns a Set of normalized company keys that should be skipped
 */
async function loadBlockedPlatforms(db) {
  try {
    const doc = await db.collection('config').doc('contactsScraper').get();
    if (doc.exists && doc.data().blockedPlatforms) {
      const blocked = doc.data().blockedPlatforms;
      const keys = new Set(Object.keys(blocked));
      console.log(`Loaded ${keys.size} blocked platforms from Firestore:`);
      for (const [key, val] of Object.entries(blocked)) {
        console.log(`  ${key}: ${val.reason}`);
      }
      return { keys, details: blocked };
    }
  } catch (err) {
    console.warn('Could not load blocked platforms:', err.message);
  }
  return { keys: new Set(), details: {} };
}

// ============================================================================
// PATTERN LOADING
// ============================================================================

function loadPatterns() {
  if (!fs.existsSync(CONFIG.PATTERNS_FILE)) {
    throw new Error(`Patterns file not found: ${CONFIG.PATTERNS_FILE}\nRun base_url_discovery.js first.`);
  }
  return JSON.parse(fs.readFileSync(CONFIG.PATTERNS_FILE, 'utf8'));
}

function getCompanyName(domain) {
  return CONFIG.COMPANY_NAMES[domain] || domain.replace('.com', '').replace(/\./g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

// ============================================================================
// COMMON CRAWL INDEX QUERY
// ============================================================================

/**
 * Query Common Crawl Index for URLs matching pattern
 */
async function queryCommonCrawlIndex(indexName, urlPattern) {
  const urls = [];
  const indexUrl = `${CONFIG.COMMON_CRAWL_BASE}/${indexName}-index`;
  const queryUrl = `${indexUrl}?url=${encodeURIComponent(urlPattern)}&output=json`;

  try {
    const response = await fetch(queryUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; TBP-URL-Seeder/1.0)',
      },
    });

    if (!response.ok) {
      if (response.status === 404) {
        return urls;
      }
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const text = await response.text();
    if (!text.trim()) return urls;

    // Common Crawl returns JSONL (one JSON object per line)
    const lines = text.trim().split('\n').filter(line => line.trim());

    for (const line of lines) {
      try {
        const record = JSON.parse(line);
        if (record.url) {
          urls.push(record.url);
        }
      } catch {
        // Skip malformed lines
      }
    }

  } catch (error) {
    console.log(`    Error querying ${indexName}: ${error.message}`);
  }

  return urls;
}

/**
 * Query multiple Common Crawl indexes and merge results
 */
async function discoverUrlsFromCommonCrawl(pattern) {
  const allUrls = new Set();

  console.log(`  Pattern: ${pattern}`);

  for (const indexName of CONFIG.COMMON_CRAWL_INDEXES) {
    console.log(`    Querying ${indexName}...`);
    const urls = await queryCommonCrawlIndex(indexName, pattern);
    urls.forEach(url => allUrls.add(url));

    console.log(`    Found ${urls.length} URLs (total unique: ${allUrls.size})`);

    // Rate limit between index queries
    await sleep(CONFIG.DELAY_BETWEEN_REQUESTS);

    // Stop if we have enough URLs
    if (allUrls.size >= CONFIG.MAX_URLS_PER_COMPANY) {
      console.log(`    Reached max URLs limit (${CONFIG.MAX_URLS_PER_COMPANY})`);
      break;
    }
  }

  console.log(`  Total unique URLs discovered: ${allUrls.size}`);

  return allUrls;
}

// ============================================================================
// WAYBACK MACHINE CDX API
// ============================================================================

/**
 * Query Internet Archive Wayback Machine CDX API for URLs matching pattern.
 * CDX API uses the same wildcard syntax as Common Crawl (*.domain.com/*)
 * Free, no API key required.
 */
async function discoverUrlsFromWaybackMachine(pattern) {
  const allUrls = new Set();

  // Convert Common Crawl pattern to Wayback CDX format
  // CC uses: *.mymonat.com/*  Wayback uses: *.mymonat.com/*
  // They use the same wildcard syntax fortunately
  const queryUrl = `https://web.archive.org/cdx/search/cdx?url=${encodeURIComponent(pattern)}&output=json&fl=original&collapse=urlkey&limit=10000`;

  console.log(`  Querying Wayback Machine CDX API...`);

  try {
    const response = await fetch(queryUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; TBP-URL-Seeder/1.0)',
      },
      signal: AbortSignal.timeout(60000), // 60s timeout
    });

    if (!response.ok) {
      if (response.status === 404) {
        console.log(`    Wayback: No results`);
        return allUrls;
      }
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    // CDX JSON output: first row is headers, rest are data rows
    // With fl=original, each row is [url]
    if (Array.isArray(data) && data.length > 1) {
      for (let i = 1; i < data.length; i++) {
        const url = data[i][0];
        if (url) allUrls.add(url);
      }
    }

    console.log(`    Wayback: Found ${allUrls.size} URLs`);
  } catch (error) {
    console.log(`    Wayback error: ${error.message}`);
  }

  return allUrls;
}

// ============================================================================
// CERTIFICATE TRANSPARENCY (crt.sh) - Subdomain Discovery
// ============================================================================

/**
 * Query crt.sh Certificate Transparency logs to discover subdomains.
 * Only useful for subdomain-type patterns (*.domain.com).
 * Free, no API key required.
 */
async function discoverSubdomainsFromCerts(patternInfo) {
  const allUrls = new Set();

  if (patternInfo.type !== 'subdomain') return allUrls;

  // Extract base domain from pattern like "*.mymonat.com/*"
  const match = patternInfo.pattern.match(/\*\.([^/]+)/);
  if (!match) return allUrls;
  const baseDomain = match[1];

  const queryUrl = `https://crt.sh/?q=${encodeURIComponent('%.' + baseDomain)}&output=json`;

  console.log(`  Querying crt.sh Certificate Transparency for ${baseDomain}...`);

  try {
    const response = await fetch(queryUrl, {
      headers: {
        'User-Agent': 'Mozilla/5.0 (compatible; TBP-URL-Seeder/1.0)',
      },
      signal: AbortSignal.timeout(60000), // 60s timeout
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const certs = await response.json();

    // Extract unique domain names from certificates
    const subdomains = new Set();
    for (const cert of certs) {
      if (cert.name_value) {
        // name_value can contain multiple domains separated by newlines
        const names = cert.name_value.split('\n');
        for (const name of names) {
          const trimmed = name.trim().toLowerCase();
          // Only include subdomains of the base domain, skip wildcards
          if (trimmed.endsWith('.' + baseDomain.toLowerCase()) && !trimmed.startsWith('*.')) {
            subdomains.add(trimmed);
          }
        }
      }
    }

    // Convert subdomains to URLs (homepage of each subdomain)
    for (const subdomain of subdomains) {
      allUrls.add(`https://${subdomain}`);
    }

    console.log(`    crt.sh: Found ${subdomains.size} subdomains → ${allUrls.size} URLs`);
  } catch (error) {
    console.log(`    crt.sh error: ${error.message}`);
  }

  return allUrls;
}

// ============================================================================
// URL NORMALIZATION & VALIDATION
// ============================================================================

/**
 * Normalize URL based on pattern type
 */
function normalizeUrl(url, patternInfo) {
  try {
    const parsed = new URL(url);
    const hostname = parsed.hostname.toLowerCase();
    const pathname = parsed.pathname;

    // Check for excluded paths
    const lowerUrl = url.toLowerCase();
    for (const excluded of CONFIG.EXCLUDED_PATHS) {
      if (lowerUrl.includes(excluded)) return null;
    }

    if (patternInfo.type === 'subdomain') {
      // For subdomain patterns, extract the base hostname
      // Skip bare domain without subdomain
      const parts = hostname.split('.');
      if (parts.length < 3) return null;

      // Skip www
      if (parts[0] === 'www') return null;

      // Return just the homepage for the subdomain
      return `https://${hostname}`;

    } else if (patternInfo.type === 'path') {
      // For path patterns, normalize the path
      const pathParts = pathname.split('/').filter(p => p);

      if (pathParts.length === 0) return null;

      // Get the first path segment (typically username/ID)
      const username = pathParts[0];

      // Skip locale/language codes and corporate pages
      const skipPatterns = [
        /^(en|es|de|fr|pt|it|ja|ko|zh|ru)[-_]/i,  // Locale codes
        /^(en|es|de|fr|pt|it|ja|ko|zh|ru)$/i,      // Single locale
        /^(catalog|content|corp|products|apps|hub|Main|webhosting)$/i,
      ];

      for (const skipPattern of skipPatterns) {
        if (skipPattern.test(username)) return null;
      }

      // Username should be alphanumeric
      if (!/^[a-zA-Z0-9_-]+$/.test(username)) return null;
      if (username.length < 3) return null;

      // Return normalized URL
      return `https://${hostname.replace(/^www\./, '')}/${username}`;

    } else if (patternInfo.type === 'third-party') {
      // Handle third-party platforms (like Zilis on Elify)
      // Keep the full path structure
      const pathParts = pathname.split('/').filter(p => p);
      if (pathParts.length < 2) return null;

      const username = pathParts[pathParts.length - 1];
      if (!/^[a-zA-Z0-9_-]+$/.test(username)) return null;

      return `https://${hostname}${pathname.replace(/\/$/, '')}`;
    }

    return null;
  } catch {
    return null;
  }
}

// ============================================================================
// FIRESTORE OPERATIONS
// ============================================================================

/**
 * Load existing URLs from Firestore for a specific company
 */
async function loadExistingUrls(db, companyName) {
  console.log(`  Loading existing URLs for ${companyName}...`);

  const existingUrls = new Set();
  const snapshot = await db.collection(CONFIG.COLLECTION)
    .where('company', '==', companyName)
    .select('url')
    .get();

  snapshot.forEach(doc => {
    const url = doc.data().url;
    if (url) {
      existingUrls.add(url);
    }
  });

  console.log(`  Found ${existingUrls.size} existing URLs in Firestore`);

  return existingUrls;
}

/**
 * Insert new URLs into Firestore
 */
async function insertUrls(db, urls, companyName, dryRun) {
  if (urls.length === 0) {
    console.log('  No new URLs to insert');
    return 0;
  }

  console.log(`  Inserting ${urls.length} new URLs...`);

  if (dryRun) {
    console.log('  DRY RUN - Would insert the following URLs:');
    urls.slice(0, 10).forEach(url => console.log(`    ${url}`));
    if (urls.length > 10) {
      console.log(`    ... and ${urls.length - 10} more`);
    }
    return 0;
  }

  let batch = db.batch();
  let batchCount = 0;
  let totalInserted = 0;

  for (const url of urls) {
    const docRef = db.collection(CONFIG.COLLECTION).doc();

    batch.set(docRef, {
      // URL & Source
      url: url,
      normalizedUrl: url,
      source: CONFIG.SOURCE,
      company: companyName,

      // Contact Info (null until scraped)
      firstName: null,
      lastName: null,
      email: null,

      // Scrape Status
      scraped: false,
      scrapedAt: null,
      scrapeStatus: 'pending',
      scrapeError: null,
      scrapeAttempts: 0,
      lastAttemptAt: null,

      // Metadata
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
      updatedAt: admin.firestore.FieldValue.serverTimestamp(),
    });

    batchCount++;
    totalInserted++;

    // Firestore batch limit is 500
    if (batchCount >= 500) {
      await batch.commit();
      console.log(`    Committed batch of ${batchCount} URLs (total: ${totalInserted})`);
      batch = db.batch();
      batchCount = 0;
    }
  }

  // Commit remaining
  if (batchCount > 0) {
    await batch.commit();
    console.log(`    Committed final batch of ${batchCount} URLs (total: ${totalInserted})`);
  }

  return totalInserted;
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function parseArgs() {
  const args = process.argv.slice(2);
  const options = {
    company: null,
    maxUrls: process.env.MAX_URLS ? parseInt(process.env.MAX_URLS, 10) : CONFIG.MAX_URLS_PER_COMPANY,
    dryRun: process.env.DRY_RUN === 'true',
  };

  for (const arg of args) {
    if (arg.startsWith('--company=')) {
      options.company = arg.split('=')[1];
    } else if (arg.startsWith('--max=')) {
      options.maxUrls = parseInt(arg.split('=')[1], 10);
    } else if (arg === '--dry-run') {
      options.dryRun = true;
    }
  }

  return options;
}

// ============================================================================
// PROCESS SINGLE COMPANY
// ============================================================================

async function processCompany(db, companyDomain, patternInfo, options) {
  const companyName = getCompanyName(companyDomain);

  console.log(`\n${'='.repeat(60)}`);
  console.log(`Processing: ${companyName} (${companyDomain})`);
  console.log('='.repeat(60));

  // Skip if no pattern or marked as no-email platform
  if (!patternInfo.pattern || patternInfo.urlCount === 0) {
    console.log('  Skipping: No pattern discovered');
    return { company: companyName, discovered: 0, inserted: 0, skipped: true };
  }

  if (patternInfo.noEmailPlatform) {
    console.log('  Skipping: Marked as no-email platform');
    return { company: companyName, discovered: 0, inserted: 0, skipped: true };
  }

  // Discover URLs from all sources
  const discoveredUrls = new Set();

  // Source 1: Common Crawl
  console.log('\n  Discovering URLs from Common Crawl...');
  const ccUrls = await discoverUrlsFromCommonCrawl(patternInfo.pattern);
  ccUrls.forEach(url => discoveredUrls.add(url));

  // Source 2: Wayback Machine CDX API
  await sleep(CONFIG.DELAY_BETWEEN_REQUESTS);
  const wbUrls = await discoverUrlsFromWaybackMachine(patternInfo.pattern);
  const wbNew = [...wbUrls].filter(u => !discoveredUrls.has(u)).length;
  wbUrls.forEach(url => discoveredUrls.add(url));
  if (wbNew > 0) console.log(`    (+${wbNew} new from Wayback)`);

  // Source 3: Certificate Transparency (subdomain patterns only)
  if (patternInfo.type === 'subdomain') {
    await sleep(CONFIG.DELAY_BETWEEN_REQUESTS);
    const certUrls = await discoverSubdomainsFromCerts(patternInfo);
    const certNew = [...certUrls].filter(u => !discoveredUrls.has(u)).length;
    certUrls.forEach(url => discoveredUrls.add(url));
    if (certNew > 0) console.log(`    (+${certNew} new from crt.sh)`);
  }

  console.log(`  Total discovered across all sources: ${discoveredUrls.size}`);

  // Normalize and validate URLs
  console.log('\n  Normalizing and validating URLs...');
  const validUrls = new Set();

  for (const url of discoveredUrls) {
    const normalized = normalizeUrl(url, patternInfo);
    if (normalized) {
      validUrls.add(normalized);
    }
  }

  console.log(`  Valid URLs after normalization: ${validUrls.size}`);

  // Load existing URLs for deduplication
  const existingUrls = await loadExistingUrls(db, companyName);

  // Filter out duplicates
  const newUrls = Array.from(validUrls).filter(url => !existingUrls.has(url));
  console.log(`  New URLs (not in Firestore): ${newUrls.length}`);

  // Apply max limit
  const urlsToInsert = newUrls.slice(0, options.maxUrls);
  if (newUrls.length > options.maxUrls) {
    console.log(`  Limited to ${options.maxUrls} URLs`);
  }

  // Insert into Firestore
  const insertedCount = await insertUrls(db, urlsToInsert, companyName, options.dryRun);

  return {
    company: companyName,
    discovered: discoveredUrls.size,
    valid: validUrls.size,
    new: newUrls.length,
    inserted: insertedCount,
    skipped: false,
  };
}

// ============================================================================
// MAIN EXECUTION
// ============================================================================

async function main() {
  const startTime = Date.now();
  const options = parseArgs();

  console.log('='.repeat(60));
  console.log('MULTI-COMPANY URL SEEDER - Common Crawl Index');
  console.log('='.repeat(60));
  console.log(`Mode: ${options.dryRun ? 'DRY RUN' : 'LIVE'}`);
  console.log(`Max URLs per company: ${options.maxUrls}`);
  console.log(`Timestamp: ${new Date().toISOString()}`);

  // Load patterns
  const patterns = loadPatterns();
  console.log(`Loaded ${Object.keys(patterns).length} company patterns`);

  // Initialize Firebase
  const db = initializeFirebase();

  // Load blocked platforms from Firestore (set by contacts-scraper.js)
  const { keys: blockedKeys, details: blockedDetails } = await loadBlockedPlatforms(db);

  // Determine which companies to process
  let companiesToProcess;
  if (options.company) {
    // Find the company by name or domain
    const companyLower = options.company.toLowerCase();
    companiesToProcess = Object.entries(patterns).filter(([domain, _]) => {
      const name = getCompanyName(domain).toLowerCase();
      return domain.includes(companyLower) || name.includes(companyLower);
    });

    if (companiesToProcess.length === 0) {
      console.error(`Company not found: ${options.company}`);
      process.exit(1);
    }
  } else {
    // Process all companies with valid patterns
    companiesToProcess = Object.entries(patterns).filter(([_, p]) =>
      p.pattern && p.urlCount > 0 && !p.noEmailPlatform
    );
  }

  // Filter out Firestore-blocked platforms (set by contacts-scraper.js)
  if (blockedKeys.size > 0) {
    const beforeCount = companiesToProcess.length;
    companiesToProcess = companiesToProcess.filter(([domain, _]) => {
      const normKey = getCompanyName(domain).toLowerCase().trim();
      return !blockedKeys.has(normKey);
    });
    const skipped = beforeCount - companiesToProcess.length;
    if (skipped > 0) {
      console.log(`Skipped ${skipped} Firestore-blocked companies`);
    }
  }

  console.log(`Processing ${companiesToProcess.length} companies`);

  // Process each company
  const results = [];
  for (const [domain, patternInfo] of companiesToProcess) {
    const result = await processCompany(db, domain, patternInfo, options);
    results.push(result);

    // Rate limit between companies
    if (companiesToProcess.indexOf([domain, patternInfo]) < companiesToProcess.length - 1) {
      await sleep(CONFIG.DELAY_BETWEEN_REQUESTS * 2);
    }
  }

  // Summary
  const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
  const totalInserted = results.reduce((sum, r) => sum + (r.inserted || 0), 0);
  const totalDiscovered = results.reduce((sum, r) => sum + (r.discovered || 0), 0);

  console.log('\n' + '='.repeat(60));
  console.log('SEEDING COMPLETE');
  console.log('='.repeat(60));
  console.log(`Companies processed: ${results.length}`);
  console.log(`Total URLs discovered: ${totalDiscovered}`);
  console.log(`Total URLs inserted: ${totalInserted}`);
  console.log(`Time elapsed: ${elapsed}s`);
  console.log('='.repeat(60));

  // Per-company summary
  console.log('\nPer-company results:');
  for (const result of results) {
    if (result.skipped) {
      console.log(`  ${result.company}: SKIPPED`);
    } else {
      console.log(`  ${result.company}: ${result.inserted} inserted (${result.discovered} discovered, ${result.new} new)`);
    }
  }

  // Exit
  process.exit(0);
}

// Run
main().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
