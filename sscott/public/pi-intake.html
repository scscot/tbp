<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Free Case Evaluation - California Personal Injury</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #0c1f3f;
            --primary-blue: #1a3a5c;
            --accent-gold: #c9a962;
            --accent-gold-light: #e5d4a1;
            --text-light: #ffffff;
            --text-muted: #a0aec0;
            --bg-card: rgba(255, 255, 255, 0.05);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --border-subtle: rgba(255, 255, 255, 0.1);
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --gradient-primary: linear-gradient(135deg, #0c1f3f 0%, #1a3a5c 50%, #0c1f3f 100%);
            --gradient-gold: linear-gradient(135deg, #c9a962 0%, #e5d4a1 50%, #c9a962 100%);
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(201, 169, 98, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--gradient-primary);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .screen {
            display: none;
            min-height: 100vh;
        }

        .screen.active {
            display: flex;
        }

        /* Landing Screen */
        #landing-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            background: var(--gradient-primary);
            position: relative;
            overflow: hidden;
        }

        #landing-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(201, 169, 98, 0.05) 0%, transparent 50%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .landing-content {
            position: relative;
            z-index: 1;
            max-width: 800px;
        }

        .logo-text {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--accent-gold);
            letter-spacing: 2px;
            margin-bottom: 2rem;
        }

        .landing-headline {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 1.5rem;
            line-height: 1.2;
            background: var(--gradient-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .landing-subheadline {
            font-size: 1.25rem;
            color: var(--text-muted);
            margin-bottom: 3rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .cta-button {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1.25rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-dark);
            background: var(--gradient-gold);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-glow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cta-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 60px rgba(201, 169, 98, 0.5);
        }

        .cta-button svg {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .cta-button:hover svg {
            transform: translateX(5px);
        }

        .landing-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-top: 4rem;
            padding-top: 3rem;
            border-top: 1px solid var(--border-subtle);
        }

        .feature {
            text-align: center;
        }

        .feature-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 1rem;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 12px;
            color: var(--accent-gold);
        }

        .feature h3 {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-light);
        }

        .feature p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .disclaimer {
            margin-top: 3rem;
            padding: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            max-width: 600px;
            text-align: center;
            opacity: 0.7;
        }

        /* Consent Screen */
        #consent-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .consent-content {
            max-width: 600px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
        }

        .consent-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--accent-gold);
            margin-bottom: 1.5rem;
        }

        .consent-items {
            text-align: left;
            margin-bottom: 2rem;
        }

        .consent-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.95rem;
            color: var(--text-light);
        }

        .consent-item svg {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            color: var(--accent-gold);
            margin-top: 2px;
        }

        .consent-checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin: 2rem 0;
            padding: 1rem;
            background: rgba(201, 169, 98, 0.1);
            border: 1px solid rgba(201, 169, 98, 0.3);
            border-radius: 8px;
            text-align: left;
        }

        .consent-checkbox {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            accent-color: var(--accent-gold);
            cursor: pointer;
        }

        .consent-checkbox-label {
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: pointer;
        }

        .consent-button {
            padding: 1rem 3rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-dark);
            background: var(--gradient-gold);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
        }

        .consent-button.enabled {
            opacity: 1;
            pointer-events: auto;
        }

        .consent-button.enabled:hover {
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        /* Chat Screen */
        #chat-screen {
            flex-direction: column;
            height: 100vh;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 2rem;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border-subtle);
        }

        .chat-header-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--accent-gold);
        }

        .chat-header-disclosure {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .chat-main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .progress-sidebar {
            width: 280px;
            padding: 2rem;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--border-subtle);
            overflow-y: auto;
        }

        .progress-title {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 1.5rem;
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background: var(--bg-card);
        }

        .progress-step.completed .step-indicator {
            background: var(--success);
            border-color: var(--success);
        }

        .progress-step.completed .step-indicator svg {
            display: block;
        }

        .step-indicator {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .progress-step.active .step-indicator {
            border-color: var(--accent-gold);
            background: var(--accent-gold);
            color: var(--primary-dark);
        }

        .step-indicator svg {
            display: none;
            width: 14px;
            height: 14px;
            color: white;
        }

        .step-text {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .progress-step.active .step-text,
        .progress-step.completed .step-text {
            color: var(--text-light);
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            max-width: 80%;
            animation: fadeInUp 0.3s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.assistant { align-self: flex-start; }
        .message.user { align-self: flex-end; flex-direction: row-reverse; }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .message.assistant .message-avatar {
            background: var(--accent-gold);
            color: var(--primary-dark);
        }

        .message.user .message-avatar {
            background: var(--primary-blue);
            color: var(--text-light);
        }

        .message-content {
            padding: 1rem 1.25rem;
            border-radius: 16px;
            line-height: 1.6;
        }

        .message.assistant .message-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: var(--primary-blue);
            border-bottom-right-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 1rem 1.25rem;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            width: fit-content;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent-gold);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .response-options {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .response-button {
            padding: 0.625rem 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 25px;
            color: var(--text-light);
            font-size: 0.875rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .response-button:hover {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            transform: translateY(-1px);
        }

        .response-button.selected {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            pointer-events: none;
        }

        /* Multi-select button styling - allows toggling */
        .response-button.multi-select-btn.selected {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            color: var(--primary-dark);
            pointer-events: auto;
        }

        .response-button.multi-select-btn.selected::before {
            content: "âœ“ ";
        }

        .response-button.done-button {
            width: 100%;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-help-button {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: white;
            border: none;
            color: #1a1f2e;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-family: Georgia, serif;
            font-size: 16px;
            font-weight: bold;
            font-style: italic;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .info-help-button:hover {
            background: var(--accent-gold);
            color: var(--primary-dark);
            transform: scale(1.1);
        }

        .chat-input-area {
            padding: 1rem 2rem 1.5rem;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid var(--border-subtle);
        }

        .chat-input-container {
            display: flex;
            gap: 1rem;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-input {
            flex: 1;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 50px;
            color: var(--text-light);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input:focus {
            border-color: var(--accent-gold);
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent-gold);
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: var(--shadow-glow);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-button svg {
            width: 20px;
            height: 20px;
        }

        .chat-confidentiality-notice {
            max-width: 800px;
            margin: 0.75rem auto 0;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
        }

        /* Loading Screen */
        #loading-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .loading-content {
            text-align: center;
            max-width: 500px;
        }

        .loading-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: var(--accent-gold);
            margin-bottom: 2rem;
        }

        .loading-stages {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .loading-stage {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .loading-stage.active {
            opacity: 1;
            border-color: var(--accent-gold);
        }

        .loading-stage.complete {
            opacity: 1;
            border-color: var(--success);
        }

        .loading-stage-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bg-card);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-gold);
        }

        .loading-stage.complete .loading-stage-icon {
            background: var(--success);
            color: white;
        }

        .loading-stage-text {
            text-align: left;
        }

        .loading-stage-text h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .loading-stage-text p {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .loading-progress {
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--gradient-gold);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Results Screen - Green */
        #results-screen {
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            overflow-y: auto;
        }

        .results-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .results-logo {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .results-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .results-subtitle {
            color: var(--text-muted);
        }

        .results-content {
            max-width: 800px;
            width: 100%;
        }

        .routing-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .routing-badge.green {
            background: rgba(72, 187, 120, 0.2);
            border: 2px solid var(--success);
            color: var(--success);
        }

        .routing-badge.yellow {
            background: rgba(237, 137, 54, 0.2);
            border: 2px solid var(--warning);
            color: var(--warning);
        }

        .factors-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .factors-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--accent-gold);
        }

        .factors-list {
            list-style: none;
        }

        .factor-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .factor-item:last-child {
            border-bottom: none;
        }

        .factor-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .factor-icon.positive { color: var(--success); }
        .factor-icon.negative { color: var(--danger); }
        .factor-icon.neutral { color: var(--text-muted); }

        .next-steps-section {
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.1) 0%, rgba(72, 187, 120, 0.05) 100%);
            border: 1px solid rgba(72, 187, 120, 0.3);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .next-steps-title {
            font-size: 1.1rem;
            color: var(--success);
            margin-bottom: 1rem;
        }

        .next-steps-text {
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .actions-section {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
        }

        .action-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            border-radius: 50px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .action-button.primary {
            background: var(--gradient-gold);
            color: var(--primary-dark);
            border: none;
        }

        .action-button.primary:hover {
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        .action-button.secondary {
            background: var(--bg-card);
            color: var(--text-light);
            border: 1px solid var(--border-subtle);
        }

        .action-button.secondary:hover {
            border-color: var(--accent-gold);
        }

        .action-button svg {
            width: 20px;
            height: 20px;
        }

        .results-disclaimer {
            max-width: 800px;
            margin-top: 2rem;
            padding: 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            opacity: 0.7;
        }

        /* Decline Screen - Red */
        #decline-screen {
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .decline-content {
            max-width: 600px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
        }

        .decline-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.75rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .decline-message {
            color: var(--text-muted);
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        .resources-section {
            text-align: left;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .resources-title {
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
        }

        .resources-list {
            list-style: none;
        }

        .resources-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .resources-list li svg {
            width: 16px;
            height: 16px;
            color: var(--accent-gold);
            flex-shrink: 0;
            margin-top: 3px;
        }

        .decline-disclaimer {
            font-size: 0.8rem;
            color: var(--text-muted);
            padding: 1rem;
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.2);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .decline-button {
            padding: 1rem 2rem;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 50px;
            color: var(--text-light);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .decline-button:hover {
            border-color: var(--accent-gold);
        }

        /* Help Modal */
        .help-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .help-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .help-modal {
            background: var(--primary-dark);
            border: 1px solid var(--accent-gold);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg), var(--shadow-glow);
        }

        .help-modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            color: var(--accent-gold);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .help-modal-content {
            color: var(--text-light);
            line-height: 1.7;
            font-size: 0.95rem;
        }

        .help-modal-close {
            margin-top: 1.5rem;
            padding: 0.75rem 2rem;
            background: var(--accent-gold);
            color: var(--primary-dark);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
        }

        .help-modal-close:hover {
            box-shadow: var(--shadow-glow);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .progress-sidebar {
                display: none;
            }

            .chat-header-disclosure {
                display: none;
            }

            .message {
                max-width: 95%;
            }

            .consent-content,
            .decline-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Landing Screen -->
    <div id="landing-screen" class="screen active">
        <div class="landing-content">
            <div class="logo-text" id="firm-logo">YOUR LAW FIRM</div>
            <h1 class="landing-headline">Free Case Evaluation</h1>
            <p class="landing-subheadline">
                Find out if you have a case in under 5 minutes. Our AI-powered intake helps us understand your situation quickly and confidentially.
            </p>
            <button class="cta-button" onclick="showConsentScreen()">
                Start My Evaluation
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                </svg>
            </button>
            <div class="landing-features">
                <div class="feature">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3>Quick & Easy</h3>
                    <p>Complete in under 5 minutes</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                        </svg>
                    </div>
                    <h3>Confidential</h3>
                    <p>Your information is secure</p>
                </div>
                <div class="feature">
                    <div class="feature-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3>No Obligation</h3>
                    <p>Free to complete</p>
                </div>
            </div>
            <p class="disclaimer">
                This evaluation is for informational purposes only and does not create an attorney-client relationship.
            </p>
        </div>
    </div>

    <!-- Consent Screen -->
    <div id="consent-screen" class="screen">
        <div class="consent-content">
            <h2 class="consent-title">Before We Begin</h2>
            <div class="consent-items">
                <div class="consent-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>This evaluation uses AI to help us understand your situation quickly</span>
                </div>
                <div class="consent-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <span>Your information is kept confidential and will only be reviewed by our legal team</span>
                </div>
                <div class="consent-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                    <span>Information shared before representation is confidential but not privileged</span>
                </div>
            </div>
            <div class="consent-checkbox-container">
                <input type="checkbox" id="consent-checkbox" class="consent-checkbox" onchange="toggleConsentButton()">
                <label for="consent-checkbox" class="consent-checkbox-label">
                    <strong>I understand that no attorney-client relationship is formed by submitting this information.</strong>
                </label>
            </div>
            <button id="consent-button" class="consent-button" onclick="startAssessment()">
                Continue to Evaluation
            </button>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chat-screen" class="screen">
        <header class="chat-header">
            <div class="chat-header-logo" id="chat-logo">YOUR LAW FIRM</div>
            <div class="chat-header-disclosure">AI-assisted intake | No attorney-client relationship</div>
        </header>
        <div class="chat-main">
            <aside class="progress-sidebar">
                <h3 class="progress-title">Evaluation Progress</h3>
                <div class="progress-steps">
                    <div class="progress-step active" data-step="1">
                        <div class="step-indicator">1<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <span class="step-text">Basic Information</span>
                    </div>
                    <div class="progress-step" data-step="2">
                        <div class="step-indicator">2<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <span class="step-text">Incident Details</span>
                    </div>
                    <div class="progress-step" data-step="3">
                        <div class="step-indicator">3<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <span class="step-text">Liability Assessment</span>
                    </div>
                    <div class="progress-step" data-step="4">
                        <div class="step-indicator">4<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <span class="step-text">Injuries & Treatment</span>
                    </div>
                    <div class="progress-step" data-step="5">
                        <div class="step-indicator">5<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" /></svg></div>
                        <span class="step-text">Insurance Details</span>
                    </div>
                </div>
            </aside>
            <div class="chat-area">
                <div id="chat-messages" class="chat-messages">
                    <!-- Messages will be inserted here -->
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Type your response..." onkeypress="handleKeyPress(event)">
                        <button id="send-button" class="send-button" onclick="sendMessage()">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                            </svg>
                        </button>
                    </div>
                    <p class="chat-confidentiality-notice">Your information is kept confidential. This tool uses AI to assist with your evaluation and does not constitute legal advice or create an attorney-client relationship.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loading-screen" class="screen">
        <div class="loading-content">
            <h2 class="loading-title">Evaluating Your Case</h2>
            <div class="loading-stages">
                <div class="loading-stage" data-stage="incident">
                    <div class="loading-stage-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                        </svg>
                    </div>
                    <div class="loading-stage-text">
                        <h4>Reviewing Incident Details</h4>
                        <p>Analyzing your situation</p>
                    </div>
                </div>
                <div class="loading-stage" data-stage="liability">
                    <div class="loading-stage-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
                        </svg>
                    </div>
                    <div class="loading-stage-text">
                        <h4>Assessing Liability</h4>
                        <p>Evaluating fault factors</p>
                    </div>
                </div>
                <div class="loading-stage" data-stage="damages">
                    <div class="loading-stage-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="loading-stage-text">
                        <h4>Calculating Potential Value</h4>
                        <p>Reviewing damages factors</p>
                    </div>
                </div>
            </div>
            <div class="loading-progress">
                <div id="loading-progress-bar" class="loading-progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- Results Screen (Green/Yellow) -->
    <div id="results-screen" class="screen">
        <header class="results-header">
            <div class="results-logo" id="results-logo">YOUR LAW FIRM</div>
            <h1 class="results-title">Your Case Evaluation</h1>
            <p class="results-subtitle">Thank you for completing your free case evaluation</p>
        </header>
        <div class="results-content">
            <div style="text-align: center;">
                <div id="routing-badge" class="routing-badge green">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="routing-text">We'd Like to Speak With You</span>
                </div>
            </div>

            <div class="factors-section">
                <h3 class="factors-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                    </svg>
                    Key Factors in Your Case
                </h3>
                <ul id="factors-list" class="factors-list">
                    <!-- Factors will be inserted here -->
                </ul>
            </div>

            <div id="next-steps-section" class="next-steps-section">
                <h3 class="next-steps-title">What Happens Next</h3>
                <p id="next-steps-text" class="next-steps-text">
                    Based on the information you provided, we believe you may have a case worth discussing.
                    A member of our team will contact you within 24 hours to schedule a free consultation.
                </p>
            </div>

            <div class="actions-section">
                <a href="#" id="schedule-button" class="action-button primary" target="_blank">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Schedule Consultation
                </a>
                <button class="action-button secondary" onclick="startOver()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Start Over
                </button>
            </div>
        </div>
        <p class="results-disclaimer">
            This evaluation is provided for informational purposes only and does not constitute legal advice.
            Every case is unique, and you should consult with a qualified attorney for advice specific to your situation.
            Past results do not guarantee future outcomes.
        </p>
    </div>

    <!-- Decline Screen (Red) -->
    <div id="decline-screen" class="screen">
        <div class="decline-content">
            <h2 class="decline-title">Thank You for Your Submission</h2>
            <p class="decline-message">
                Based on the information provided, <span id="decline-firm-name">our firm</span> may not be the right fit for your situation at this time.
            </p>

            <div class="resources-section">
                <h3 class="resources-title">General Resources</h3>
                <ul class="resources-list">
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                        <span>California State Bar Lawyer Referral Service: <strong>1-866-442-2529</strong></span>
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>Keep records of any medical treatment you receive</span>
                    </li>
                    <li>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <span>Note important dates related to your incident</span>
                    </li>
                </ul>
            </div>

            <div class="decline-disclaimer">
                This is not legal advice. Time limits may apply to your situation. Consider consulting with a licensed attorney.
            </div>

            <button class="decline-button" onclick="startOver()">Start New Evaluation</button>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal-overlay" class="help-modal-overlay" onclick="closeHelpModal(event)">
        <div class="help-modal" onclick="event.stopPropagation()">
            <div class="help-modal-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="help-modal-title-text">Help</span>
            </div>
            <div id="help-modal-content" class="help-modal-content"></div>
            <button class="help-modal-close" onclick="closeHelpModal()">Got it</button>
        </div>
    </div>

    <!-- Load configuration -->
    <script src="pi-intake-config.js"></script>

    <script>
        // Configuration (loaded from pi-intake-config.js or defaults)
        const CONFIG = window.PI_INTAKE_CONFIG || {
            firmName: 'YOUR LAW FIRM',
            proxyUrl: 'https://your-proxy.example.com/api/chat',
            model: 'claude-sonnet-4-20250514',
            webhookUrl: null,
            webhookKey: null,
            scheduleUrl: '#',
            minDamagesThreshold: 25000,
            acceptSharedFault: true,
            acceptNoTreatment: false
        };

        // Apply firm branding
        document.getElementById('firm-logo').textContent = CONFIG.firmName;
        document.getElementById('chat-logo').textContent = CONFIG.firmName;
        document.getElementById('results-logo').textContent = CONFIG.firmName;
        document.getElementById('decline-firm-name').textContent = CONFIG.firmName;
        document.getElementById('schedule-button').href = CONFIG.scheduleUrl;

        // Rate limit retry configuration
        const MAX_RETRIES = 3;
        const INITIAL_RETRY_DELAY = 5000;

        // State
        let conversationHistory = [];
        let collectedData = {};
        let currentStep = 1;
        let isProcessing = false;
        let apiCallDepth = 0;
        let currentHelpContent = null;

        // Screen management
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showConsentScreen() {
            showScreen('consent-screen');
        }

        function toggleConsentButton() {
            const checkbox = document.getElementById('consent-checkbox');
            const button = document.getElementById('consent-button');
            if (checkbox.checked) {
                button.classList.add('enabled');
            } else {
                button.classList.remove('enabled');
            }
        }

        // Help modal functions
        function showHelpModal(title, content) {
            document.getElementById('help-modal-title-text').textContent = title;
            document.getElementById('help-modal-content').textContent = content;
            document.getElementById('help-modal-overlay').classList.add('active');
        }

        function closeHelpModal(event) {
            if (!event || event.target === event.currentTarget) {
                document.getElementById('help-modal-overlay').classList.remove('active');
            }
        }

        // System prompt for California PI intake
        const SYSTEM_PROMPT = `You are an intake specialist for a California personal injury law firm. Guide users through a case evaluation in under 5 minutes.

CRITICAL RULES:
1. Ask ONLY ONE question per response. Never ask multiple questions.
2. Do NOT use markdown formatting. Write in plain text only.
3. Wait for the user to answer before moving to the next question.
4. BUTTON RESPONSES: Users select from on-screen buttons. Accept their selection and move on.
5. DO NOT LIST OPTIONS IN YOUR TEXT. The interface generates buttons automatically.
6. CONTEXT AWARENESS: Only ask questions relevant to the incident type. Do NOT ask vehicle questions for slip and fall cases. Do NOT ask premises questions for car accidents.
7. NATURAL CONVERSATION: Reference specific details from the user's previous answers naturally. Use the actual terms they used rather than generic placeholders.

## Question Flow (strictly one question at a time):

### Phase 1: Basic Information
1. Ask for their name
2. Ask for their phone number
3. Ask for their email address

### Phase 2: Incident Screening (Gate 1 - Hard Disqualifiers)
4. Ask when the incident occurred
5. Ask if they were physically injured
6. Ask what type of medical treatment they received
7. Ask if the incident occurred in California

### Phase 3: Incident Details
8. Ask what type of incident this was

CONDITIONAL FOLLOW-UPS based on incident type (ONLY ask relevant questions):

FOR VEHICLE ACCIDENTS (Car, Motorcycle, Truck, Pedestrian hit by vehicle, Bicycle hit by vehicle):
- Car Accident: Ask what type of collision (rear-end, t-bone, etc.)
- Truck Accident: Ask what type of truck was involved
- Ask what type of injuries they suffered
- Ask who was at fault
- Ask if a police report was filed
- Ask what evidence they have (users can select multiple options)
- Ask about vehicle damage (reference their specific vehicle type with "damage" to trigger buttons; skip for pedestrian/bicycle)
- Ask if the other driver was insured
- Ask if they have auto insurance
- Ask if the other driver was working for a rideshare, delivery service, or driving a company vehicle

FOR RIDESHARE ACCIDENTS:
- Ask "What was your role in the rideshare accident?" (include "rideshare" or "Uber"/"Lyft" to trigger buttons)
- Ask "Was the rideshare app active during the incident?" (include "app" + "active" to trigger buttons)
- Ask what type of injuries they suffered
- Ask who was at fault
- Ask if a police report was filed
- Ask what evidence they have (users can select multiple options)
- Ask "How severe was the damage to your vehicle?" (use word "vehicle" to trigger buttons)
- Note: Insurance is typically covered by rideshare company's policy

FOR SLIP AND FALL (Premises Liability):
- Ask where the slip and fall occurred (include "slip" or "fall" to trigger buttons)
- Ask what caused the slip or fall (include "slip" or "fall" to trigger buttons)
- Ask what type of injuries they suffered
- Ask who was at fault
- Ask if an incident report was filed (reference the specific location; include "incident report" to trigger buttons)
- Ask what evidence they have (users can select multiple options)
- Ask if the property owner or business has insurance (include "business" or "property owner" with "insurance" to trigger buttons)
- DO NOT ask about vehicle damage or auto insurance - not relevant for premises liability

FOR DOG BITE:
- Ask where the dog bite occurred (include "dog" and "bite" to trigger buttons)
- Ask if the dog has a history of aggression or has bitten before (include "dog" with "aggressive" or "history" to trigger buttons)
- Ask what type of injuries they suffered
- Ask who was at fault
- Ask if a report was filed with police or animal control (include "animal control" or "report" + "dog" to trigger buttons)
- Ask what evidence they have (users can select multiple options)
- Ask if the dog owner has homeowner's or renter's insurance (include "homeowner" or "renter" with "insurance" to trigger buttons)
- DO NOT ask about vehicle damage or auto insurance - not relevant for dog bite

FOR WRONGFUL DEATH:
- Ask "What was your relationship to the deceased?" (include "relationship" and "deceased" to trigger buttons)
- Ask about the circumstances of death (what type of incident caused the death)
- Continue with relevant liability questions based on incident type

FOR WORKPLACE INJURY:
- Note: Workers' compensation cases have special rules
- Ask what type of injuries they suffered
- Ask if they have filed a workers' comp claim
- Ask if their employer has disputed the claim
- Ask if they have an attorney for the workers' comp case
- Consider referring to workers' comp specialist if appropriate

### Phase 4: Common Questions (ALL case types)
- Ask "Did you go to the emergency room?" (include "emergency room" to trigger buttons)
- Ask "Were you hospitalized overnight?" (include "hospital" and "overnight" to trigger buttons) - ASK SEPARATELY from ER question
- Ask "Are you currently receiving treatment?" (include "currently" and "receiving" to trigger buttons)
- Ask "Has surgery been recommended?" (include "surgery" to trigger buttons)
- Ask "Did you miss work due to your injuries?" (include "miss" and "work" to trigger buttons)
- Ask "Have you already filed an insurance claim?" (include "claim" and "filed" to trigger buttons)
- Ask "Are you currently represented by an attorney?" (include "attorney" to trigger buttons)

### After All Questions
Call complete_pi_intake with the assessment results.

## Response Style
- Keep responses brief (1-2 sentences max before your ONE question)
- Be empathetic but professional
- After user answers, provide brief acknowledgment, then ask the NEXT question
- NEVER ask multiple questions

## AI Reasoning Guidelines
You are a sophisticated AI capable of natural conversation. Use your judgment to:
- Reference specific details the user provided (locations, vehicle types, injury descriptions)
- Acknowledge their responses with appropriate empathy based on severity
- Adapt your language naturally to match the context of their situation
- Recognize when information provided makes certain questions unnecessary

The button system requires certain keywords to display response options. When asking questions, naturally include the trigger words noted in parentheses while maintaining conversational flow. Trust your ability to have a natural conversation - you don't need explicit rules for every scenario.

## Disqualification Rules (call complete_pi_intake with routing="red")
- Incident more than 2 years ago (SOL expired)
- No physical injury AND no medical treatment
- Incident outside California
- User admits 100% fault
- User is currently represented by another attorney`;

        // Tools definition for PI intake
        const TOOLS = [
            {
                name: "collect_contact_info",
                description: "Collect basic contact information from the user",
                input_schema: {
                    type: "object",
                    properties: {
                        name: { type: "string", description: "User's name" },
                        phone: { type: "string", description: "Phone number" },
                        email: { type: "string", description: "Email address" }
                    },
                    required: ["name", "phone", "email"]
                }
            },
            {
                name: "collect_incident_info",
                description: "Collect information about the incident",
                input_schema: {
                    type: "object",
                    properties: {
                        incident_date_range: {
                            type: "string",
                            enum: ["less_than_1_year", "1_to_2_years", "more_than_2_years"]
                        },
                        injured: { type: "boolean" },
                        treatment_type: {
                            type: "string",
                            enum: ["er", "hospital_admission", "urgent_care", "doctor", "specialist", "chiropractor", "physical_therapy", "none"]
                        },
                        in_california: { type: "boolean" },
                        incident_type: {
                            type: "string",
                            enum: ["car_accident", "motorcycle", "truck", "rideshare", "pedestrian", "bicycle", "slip_and_fall", "dog_bite", "wrongful_death", "workplace_injury", "other"]
                        },
                        accident_type: {
                            type: "string",
                            enum: ["rear_end", "t_bone", "head_on", "sideswipe", "hit_and_run", "multi_vehicle", "single_vehicle"]
                        },
                        truck_type: {
                            type: "string",
                            enum: ["semi", "delivery", "box_truck", "construction", "garbage_utility", "other_commercial"]
                        },
                        rideshare_role: {
                            type: "string",
                            enum: ["passenger", "hit_by_driver", "driver", "other"]
                        },
                        rideshare_app_active: {
                            type: "string",
                            enum: ["during_trip", "waiting", "app_off", "not_sure"]
                        },
                        slip_fall_location: {
                            type: "string",
                            enum: ["grocery_retail", "restaurant", "parking_lot", "sidewalk", "apartment", "workplace", "private_residence", "other"]
                        },
                        slip_fall_cause: {
                            type: "string",
                            enum: ["wet_floor", "uneven_surface", "poor_lighting", "debris", "ice_snow", "broken_stairs", "loose_carpet", "other"]
                        },
                        dog_bite_location: {
                            type: "string",
                            enum: ["public_place", "owner_property_invited", "owner_property_uninvited", "my_property", "other"]
                        },
                        dog_bite_aggressive_history: {
                            type: "string",
                            enum: ["yes_known_aggressive", "no_prior_incidents", "not_sure"]
                        },
                        wrongful_death_relationship: {
                            type: "string",
                            enum: ["spouse", "child", "parent", "sibling", "other_family"]
                        },
                        injury_type: {
                            type: "string",
                            enum: ["whiplash", "back_spine", "broken_bones", "head_injury", "soft_tissue", "cuts", "internal", "multiple"]
                        }
                    },
                    required: ["incident_date_range", "injured", "in_california"]
                }
            },
            {
                name: "collect_liability_info",
                description: "Collect liability assessment information",
                input_schema: {
                    type: "object",
                    properties: {
                        fault_assessment: {
                            type: "string",
                            enum: ["other_party", "shared", "self", "not_sure"]
                        },
                        police_report: {
                            type: "string",
                            enum: ["yes", "no", "not_sure"]
                        },
                        evidence_types: {
                            type: "array",
                            items: { type: "string" }
                        }
                    },
                    required: ["fault_assessment"]
                }
            },
            {
                name: "collect_damages_info",
                description: "Collect damages and insurance information",
                input_schema: {
                    type: "object",
                    properties: {
                        er_visit: { type: "boolean" },
                        hospitalized_overnight: { type: "boolean" },
                        currently_treating: {
                            type: "string",
                            enum: ["still_in_treatment", "treatment_completed", "not_started"]
                        },
                        surgery_recommended: { type: "boolean" },
                        missed_work: { type: "boolean" },
                        property_damage: {
                            type: "string",
                            enum: ["minor", "moderate", "severe", "total_loss", "none"]
                        },
                        other_party_insured: { type: "string", enum: ["yes", "no", "not_sure"] },
                        has_auto_insurance: { type: "boolean" },
                        commercial_defendant: { type: "string", enum: ["yes", "no", "not_sure"] },
                        insurance_claim_filed: { type: "string", enum: ["yes", "no", "not_sure"] },
                        attorney_representation: {
                            type: "string",
                            enum: ["no", "yes_currently", "previously_not_now"]
                        }
                    }
                }
            },
            {
                name: "show_question_help",
                description: "Provide help text for complex questions",
                input_schema: {
                    type: "object",
                    properties: {
                        help_title: { type: "string" },
                        help_content: { type: "string" }
                    },
                    required: ["help_title", "help_content"]
                }
            },
            {
                name: "complete_pi_intake",
                description: "Complete the PI intake and determine routing",
                input_schema: {
                    type: "object",
                    properties: {
                        routing: {
                            type: "string",
                            enum: ["green", "yellow", "red"],
                            description: "Lead routing: green=immediate consult, yellow=needs docs, red=decline"
                        },
                        urgency: {
                            type: "string",
                            enum: ["immediate", "standard", "none"]
                        },
                        confidence_level: {
                            type: "string",
                            enum: ["high", "medium", "low"]
                        },
                        recommended_next_action: {
                            type: "string",
                            enum: ["schedule_consult", "request_documents", "decline_with_resources"]
                        },
                        primary_disqualifier: {
                            type: "string",
                            description: "Main reason for red routing (if applicable)"
                        },
                        primary_strength_factor: {
                            type: "string",
                            description: "Main positive factor (e.g., 'Police report on file, clear liability')"
                        },
                        urgency_reason: {
                            type: "string",
                            description: "Reason for urgency (e.g., 'SOL approaches in 6 months')"
                        },
                        key_factors: {
                            type: "array",
                            items: {
                                type: "object",
                                properties: {
                                    factor: { type: "string" },
                                    impact: { type: "string", enum: ["positive", "negative", "neutral"] }
                                }
                            }
                        }
                    },
                    required: ["routing", "urgency", "recommended_next_action", "key_factors"]
                }
            }
        ];

        // Start assessment
        function startAssessment() {
            showScreen('chat-screen');
            conversationHistory = [];
            collectedData = {};
            currentStep = 1;
            isProcessing = false;
            apiCallDepth = 0;
            currentHelpContent = null;
            updateProgressSteps();

            const initialMessage = { role: "user", content: "I'd like to get a free case evaluation for a personal injury matter in California." };
            conversationHistory.push(initialMessage);
            sendToAPI(conversationHistory);
        }

        // Update progress steps
        function updateProgressSteps() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum < currentStep) {
                    step.classList.add('completed');
                } else if (stepNum === currentStep) {
                    step.classList.add('active');
                }
            });
        }

        // Detect question type and return appropriate button options
        function detectQuestionButtons(text) {
            const questionMatch = text.match(/[^.!?]*\?[^.!?]*/g);
            if (!questionMatch || questionMatch.length === 0) return null;

            const questionText = questionMatch[questionMatch.length - 1];
            const lowerText = questionText.toLowerCase();

            // Incident timing
            if (lowerText.includes('when') && (lowerText.includes('incident') || lowerText.includes('accident') || lowerText.includes('occur'))) {
                return [
                    { label: "Less than 1 year ago", value: "Less than 1 year ago" },
                    { label: "1-2 years ago", value: "1-2 years ago" },
                    { label: "More than 2 years ago", value: "More than 2 years ago" }
                ];
            }

            // Injured yes/no
            if (lowerText.includes('physical') && lowerText.includes('injur')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" }
                ];
            }

            // Medical treatment type - comprehensive options
            // IMPORTANT: Must NOT match "currently receiving treatment" (handled by separate pattern)
            if ((lowerText.includes('treatment') || lowerText.includes('medical care')) &&
                !lowerText.includes('currently') && !lowerText.includes('still')) {
                return [
                    { label: "Emergency Room", value: "Emergency Room" },
                    { label: "Hospital (admitted)", value: "Hospital Admission" },
                    { label: "Urgent Care", value: "Urgent Care" },
                    { label: "Doctor's Office", value: "Doctor's Office" },
                    { label: "Specialist/Orthopedist", value: "Specialist/Orthopedist" },
                    { label: "Chiropractor", value: "Chiropractor" },
                    { label: "Physical Therapy", value: "Physical Therapy" },
                    { label: "No treatment yet", value: "No treatment yet" }
                ];
            }

            // California location
            if (lowerText.includes('california') && (lowerText.includes('occur') || lowerText.includes('happen') || lowerText.includes('take place') || lowerText.includes('located') || lowerText.includes('in california'))) {
                return [
                    { label: "Yes, in California", value: "Yes, in California" },
                    { label: "No, outside California", value: "No, outside California" }
                ];
            }

            // Incident type - comprehensive list of PI case types
            if (lowerText.includes('type of incident') || lowerText.includes('what happened') || lowerText.includes('kind of accident') || lowerText.includes('type of case')) {
                return [
                    { label: "Car Accident", value: "Car Accident" },
                    { label: "Motorcycle Accident", value: "Motorcycle Accident" },
                    { label: "Truck Accident", value: "Truck Accident" },
                    { label: "Rideshare (Uber/Lyft)", value: "Rideshare Accident" },
                    { label: "Pedestrian Accident", value: "Pedestrian Accident" },
                    { label: "Bicycle Accident", value: "Bicycle Accident" },
                    { label: "Slip and Fall", value: "Slip and Fall" },
                    { label: "Dog Bite", value: "Dog Bite" },
                    { label: "Wrongful Death", value: "Wrongful Death" },
                    { label: "Workplace Injury", value: "Workplace Injury" },
                    { label: "Other", value: "Other" }
                ];
            }

            // Accident type (for car accidents) - matches "type of car accident", "type of collision", "type of crash"
            if (lowerText.includes('type of') && (lowerText.includes('collision') || lowerText.includes('crash') || lowerText.includes('car accident') || lowerText.includes('auto accident') || lowerText.includes('vehicle accident'))) {
                return [
                    { label: "Rear-end", value: "Rear-end" },
                    { label: "T-bone / Side impact", value: "T-bone" },
                    { label: "Head-on", value: "Head-on" },
                    { label: "Sideswipe", value: "Sideswipe" },
                    { label: "Hit-and-run", value: "Hit-and-run" },
                    { label: "Multi-vehicle pileup", value: "Multi-vehicle" },
                    { label: "Single vehicle", value: "Single vehicle" }
                ];
            }

            // Fault assessment
            if (lowerText.includes('fault') || lowerText.includes('responsible')) {
                return [
                    { label: "Other party was at fault", value: "Other party was at fault" },
                    { label: "Shared fault", value: "Shared fault" },
                    { label: "I was at fault", value: "I was at fault" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Police report - standard vehicle accidents
            // IMPORTANT: Must NOT match dog bite questions that combine police + animal control
            if (lowerText.includes('police') && lowerText.includes('report') &&
                !lowerText.includes('animal control') && !lowerText.includes('dog')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Evidence types - MULTI-SELECT
            if (lowerText.includes('evidence') || lowerText.includes('documentation')) {
                return {
                    multiSelect: true,
                    buttons: [
                        { label: "Photos/Videos", value: "Photos/Videos" },
                        { label: "Witness Information", value: "Witness Information" },
                        { label: "Police Report", value: "Police Report" },
                        { label: "Incident Report", value: "Incident Report" },
                        { label: "Medical Records", value: "Medical Records" },
                        { label: "None of these", value: "None of these" }
                    ]
                };
            }

            // ER visit - must match "ER" as a word, not as part of other words like "number"
            if (lowerText.includes('emergency room') || /\bthe er\b|\bto er\b|\bvisit er\b|\bwent to er\b|\ber visit\b/.test(lowerText)) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" }
                ];
            }

            // Surgery
            if (lowerText.includes('surgery')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" }
                ];
            }

            // Missed work
            if (lowerText.includes('miss') && lowerText.includes('work')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" }
                ];
            }

            // Other party/driver insured
            if ((lowerText.includes('other party') || lowerText.includes('other driver') || lowerText.includes('at-fault driver') || lowerText.includes('at fault driver')) && lowerText.includes('insur')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Has auto insurance - matches "your auto insurance" or "do you have auto insurance"
            if ((lowerText.includes('your') || lowerText.includes('do you')) && lowerText.includes('auto insurance')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" }
                ];
            }

            // Commercial defendant - must be asking IF they were working, not about rideshare role
            // Check for "driving for work" or specific work context, avoid matching rideshare role questions
            if (lowerText.includes('driving for work') || lowerText.includes('company vehicle') ||
                lowerText.includes('working for') || lowerText.includes('on the job') ||
                ((lowerText.includes('uber') || lowerText.includes('delivery') || lowerText.includes('lyft')) &&
                 (lowerText.includes('other driver') || lowerText.includes('at-fault') || lowerText.includes('other party') || lowerText.includes('working')))) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Premises liability insurance (slip and fall) - property owner/business insurance
            // Supports location-specific questions: restaurant, store, parking lot, apartment, etc.
            if ((lowerText.includes('property owner') || lowerText.includes('business') || lowerText.includes('store') || lowerText.includes('premises') || lowerText.includes('restaurant') || lowerText.includes('parking') || lowerText.includes('apartment') || lowerText.includes('landlord')) && lowerText.includes('insurance')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Homeowner/renter insurance (dog bite)
            if ((lowerText.includes('homeowner') || lowerText.includes('renter') || lowerText.includes('dog owner')) && lowerText.includes('insurance')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Incident report filed (for premises liability - separate from police report)
            // Supports location-specific questions: restaurant, store, parking lot, apartment, etc.
            if (lowerText.includes('incident report') && (lowerText.includes('filed') || lowerText.includes('property') || lowerText.includes('store') || lowerText.includes('business') || lowerText.includes('restaurant') || lowerText.includes('parking') || lowerText.includes('apartment') || lowerText.includes('sidewalk'))) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Animal control report (for dog bite)
            if (lowerText.includes('animal control') || (lowerText.includes('report') && lowerText.includes('dog'))) {
                return [
                    { label: "Yes, police report", value: "Yes, police report" },
                    { label: "Yes, animal control report", value: "Yes, animal control report" },
                    { label: "Both police and animal control", value: "Both reports" },
                    { label: "No report filed", value: "No report filed" }
                ];
            }

            // Slip and fall location
            if (lowerText.includes('where') && (lowerText.includes('slip') || lowerText.includes('fall') || lowerText.includes('trip'))) {
                return [
                    { label: "Grocery/Retail Store", value: "Grocery/Retail Store" },
                    { label: "Restaurant/Bar", value: "Restaurant/Bar" },
                    { label: "Parking Lot", value: "Parking Lot" },
                    { label: "Sidewalk/Public Area", value: "Sidewalk/Public Area" },
                    { label: "Apartment/Rental Property", value: "Apartment/Rental Property" },
                    { label: "Workplace", value: "Workplace" },
                    { label: "Private Residence", value: "Private Residence" },
                    { label: "Other", value: "Other" }
                ];
            }

            // Slip and fall cause
            if ((lowerText.includes('cause') || lowerText.includes('why') || lowerText.includes('what made')) && (lowerText.includes('slip') || lowerText.includes('fall') || lowerText.includes('trip'))) {
                return [
                    { label: "Wet/Slippery Floor", value: "Wet/Slippery Floor" },
                    { label: "Uneven Surface/Pothole", value: "Uneven Surface/Pothole" },
                    { label: "Poor Lighting", value: "Poor Lighting" },
                    { label: "Debris/Obstacle", value: "Debris/Obstacle" },
                    { label: "Ice/Snow", value: "Ice/Snow" },
                    { label: "Broken Stairs/Handrail", value: "Broken Stairs/Handrail" },
                    { label: "Loose Carpet/Rug", value: "Loose Carpet/Rug" },
                    { label: "Other/Not Sure", value: "Other/Not Sure" }
                ];
            }

            // Dog bite location (where it occurred)
            if (lowerText.includes('where') && (lowerText.includes('bite') || lowerText.includes('attack') || lowerText.includes('dog'))) {
                return [
                    { label: "Public Place (park, sidewalk)", value: "Public Place" },
                    { label: "Owner's Property (invited)", value: "Owner's Property - Invited" },
                    { label: "Owner's Property (uninvited)", value: "Owner's Property - Uninvited" },
                    { label: "My Property", value: "My Property" },
                    { label: "Other Location", value: "Other Location" }
                ];
            }

            // Dog bite - known aggressive
            if ((lowerText.includes('aggressive') || lowerText.includes('bitten before') || lowerText.includes('history')) && lowerText.includes('dog')) {
                return [
                    { label: "Yes, known aggressive", value: "Yes, known aggressive" },
                    { label: "No prior incidents known", value: "No prior incidents known" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Truck accident sub-type
            if (lowerText.includes('type of truck') || (lowerText.includes('truck') && lowerText.includes('what kind'))) {
                return [
                    { label: "Semi/18-Wheeler", value: "Semi/18-Wheeler" },
                    { label: "Delivery (Amazon, FedEx, UPS)", value: "Delivery Truck" },
                    { label: "Box Truck/Moving Van", value: "Box Truck" },
                    { label: "Construction Vehicle", value: "Construction Vehicle" },
                    { label: "Garbage/Utility Truck", value: "Garbage/Utility Truck" },
                    { label: "Other Commercial Truck", value: "Other Commercial Truck" }
                ];
            }

            // Rideshare role (were you passenger or hit by rideshare)
            // Must check for "role" or "involvement" to distinguish from commercial defendant question
            if ((lowerText.includes('rideshare') || lowerText.includes('uber') || lowerText.includes('lyft')) &&
                (lowerText.includes('role') || lowerText.includes('involvement') || lowerText.includes('were you') || lowerText.includes('passenger'))) {
                return [
                    { label: "I was a passenger", value: "Passenger in Rideshare" },
                    { label: "I was hit by a rideshare driver", value: "Hit by Rideshare Driver" },
                    { label: "I was the rideshare driver", value: "Rideshare Driver" },
                    { label: "Other involvement", value: "Other Rideshare Involvement" }
                ];
            }

            // Rideshare app active
            if (lowerText.includes('app') && (lowerText.includes('active') || lowerText.includes('logged in') || lowerText.includes('on a trip'))) {
                return [
                    { label: "Yes, during a trip", value: "Yes, during a trip" },
                    { label: "Yes, waiting for a ride", value: "Yes, waiting for a ride" },
                    { label: "No, app was off", value: "No, app was off" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Wrongful death - relationship to deceased
            if (lowerText.includes('relationship') && (lowerText.includes('deceased') || lowerText.includes('passed') || lowerText.includes('loved one') || lowerText.includes('family member'))) {
                return [
                    { label: "Spouse/Domestic Partner", value: "Spouse/Domestic Partner" },
                    { label: "Child", value: "Child" },
                    { label: "Parent", value: "Parent" },
                    { label: "Sibling", value: "Sibling" },
                    { label: "Other Family Member", value: "Other Family Member" }
                ];
            }

            // Injury type/severity
            if (lowerText.includes('type of injur') || lowerText.includes('what injur') || lowerText.includes('injuries did you')) {
                return [
                    { label: "Whiplash/Neck Pain", value: "Whiplash/Neck Pain" },
                    { label: "Back/Spine Injury", value: "Back/Spine Injury" },
                    { label: "Broken Bones", value: "Broken Bones" },
                    { label: "Head Injury/Concussion", value: "Head Injury/Concussion" },
                    { label: "Soft Tissue (sprains, strains)", value: "Soft Tissue Injury" },
                    { label: "Cuts/Lacerations", value: "Cuts/Lacerations" },
                    { label: "Internal Injuries", value: "Internal Injuries" },
                    { label: "Multiple Injuries", value: "Multiple Injuries" }
                ];
            }

            // Hospitalized overnight
            if (lowerText.includes('hospital') && (lowerText.includes('overnight') || lowerText.includes('admitted') || lowerText.includes('stay'))) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" }
                ];
            }

            // Currently treating
            if (lowerText.includes('currently') && (lowerText.includes('treating') || lowerText.includes('receiving') || lowerText.includes('seeing'))) {
                return [
                    { label: "Yes, still in treatment", value: "Yes, still in treatment" },
                    { label: "No, treatment completed", value: "No, treatment completed" },
                    { label: "No, haven't started yet", value: "No, haven't started yet" }
                ];
            }

            // Vehicle damage severity (ONLY for vehicle accidents - must mention car/vehicle/motorcycle/truck)
            if ((lowerText.includes('vehicle') || lowerText.includes('car') || lowerText.includes('motorcycle') || lowerText.includes('truck')) &&
                (lowerText.includes('damage') || lowerText.includes('condition'))) {
                return [
                    { label: "Minor damage", value: "Minor damage" },
                    { label: "Moderate damage", value: "Moderate damage" },
                    { label: "Severe damage", value: "Severe damage" },
                    { label: "Total loss", value: "Total loss" },
                    { label: "No vehicle damage", value: "No vehicle damage" }
                ];
            }

            // Attorney representation
            if (lowerText.includes('attorney') || lowerText.includes('lawyer') || lowerText.includes('legal represent')) {
                return [
                    { label: "No, not yet", value: "No, not yet" },
                    { label: "Yes, currently represented", value: "Yes, currently represented" },
                    { label: "Previously, but no longer", value: "Previously, but no longer" }
                ];
            }

            // Insurance claim filed (general - NOT workers' comp)
            // IMPORTANT: Must NOT match workers' comp questions (handled by separate pattern)
            if (lowerText.includes('claim') && lowerText.includes('filed') &&
                !lowerText.includes('workers') && !lowerText.includes('comp')) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure", value: "Not sure" }
                ];
            }

            // Workers' comp claim filed
            if (lowerText.includes('workers') && (lowerText.includes('comp') || lowerText.includes('compensation'))) {
                return [
                    { label: "Yes, claim filed", value: "Yes, claim filed" },
                    { label: "No, not yet", value: "No, not yet" },
                    { label: "Claim was denied", value: "Claim was denied" }
                ];
            }

            // Employer disputed claim
            if (lowerText.includes('employer') && (lowerText.includes('disputed') || lowerText.includes('denied') || lowerText.includes('fighting'))) {
                return [
                    { label: "Yes", value: "Yes" },
                    { label: "No", value: "No" },
                    { label: "Not sure yet", value: "Not sure yet" }
                ];
            }

            // No buttons for unrecognized questions - show text input instead
            return null;
        }

        // Add message to chat
        function addMessage(content, role, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            // Scales of justice image for assistant avatar
            const scalesIcon = `<img src="/assets/images/scales-of-justice.png" alt="Legal Assistant" style="width: 28px; height: 28px; object-fit: contain;">`;

            if (isTyping) {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${role === 'assistant' ? scalesIcon : 'You'}</div>
                    <div class="typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                `;
                messageDiv.id = 'typing-indicator';
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">${role === 'assistant' ? scalesIcon : 'You'}</div>
                    <div class="message-content">${content}</div>
                `;

                if (role === 'assistant') {
                    const detectedResult = detectQuestionButtons(content);
                    if (detectedResult) {
                        document.querySelector('.chat-input-area').style.display = 'none';

                        const helpContent = currentHelpContent;
                        currentHelpContent = null;

                        // Handle both old array format and new object format
                        const isMultiSelect = detectedResult.multiSelect === true;
                        const detectedButtons = isMultiSelect ? detectedResult.buttons : detectedResult;

                        setTimeout(() => {
                            const messageContent = messageDiv.querySelector('.message-content');
                            if (messageContent) {
                                const optionsDiv = document.createElement('div');
                                optionsDiv.className = 'response-options';

                                if (isMultiSelect) {
                                    optionsDiv.dataset.multiSelect = 'true';
                                    const selectedValues = new Set();

                                    detectedButtons.forEach(option => {
                                        const button = document.createElement('button');
                                        button.className = 'response-button multi-select-btn';
                                        button.textContent = option.label;
                                        button.dataset.value = option.value;
                                        button.onclick = () => {
                                            if (isProcessing) return;

                                            // Handle "None of these" as exclusive option
                                            if (option.value === 'None of these') {
                                                if (button.classList.contains('selected')) {
                                                    button.classList.remove('selected');
                                                    selectedValues.delete(option.value);
                                                } else {
                                                    // Deselect all others
                                                    optionsDiv.querySelectorAll('.multi-select-btn').forEach(btn => {
                                                        btn.classList.remove('selected');
                                                    });
                                                    selectedValues.clear();
                                                    button.classList.add('selected');
                                                    selectedValues.add(option.value);
                                                }
                                            } else {
                                                // Deselect "None of these" if selecting another option
                                                optionsDiv.querySelectorAll('.multi-select-btn').forEach(btn => {
                                                    if (btn.dataset.value === 'None of these') {
                                                        btn.classList.remove('selected');
                                                        selectedValues.delete('None of these');
                                                    }
                                                });

                                                button.classList.toggle('selected');
                                                if (button.classList.contains('selected')) {
                                                    selectedValues.add(option.value);
                                                } else {
                                                    selectedValues.delete(option.value);
                                                }
                                            }

                                            // Enable/disable done button based on selection
                                            const doneBtn = optionsDiv.querySelector('.done-button');
                                            if (doneBtn) {
                                                doneBtn.disabled = selectedValues.size === 0;
                                                doneBtn.style.opacity = selectedValues.size === 0 ? '0.5' : '1';
                                            }
                                        };
                                        optionsDiv.appendChild(button);
                                    });

                                    // Add "Done" button for multi-select
                                    const doneBtn = document.createElement('button');
                                    doneBtn.className = 'response-button done-button';
                                    doneBtn.textContent = 'Done';
                                    doneBtn.disabled = true;
                                    doneBtn.style.opacity = '0.5';
                                    doneBtn.style.marginTop = '10px';
                                    doneBtn.style.backgroundColor = 'var(--accent-gold)';
                                    doneBtn.onclick = () => {
                                        if (isProcessing || selectedValues.size === 0) return;

                                        // Disable all buttons
                                        optionsDiv.querySelectorAll('button').forEach(btn => {
                                            btn.disabled = true;
                                            if (!btn.classList.contains('selected') && !btn.classList.contains('done-button')) {
                                                btn.style.opacity = '0.4';
                                            }
                                        });

                                        const combinedValue = Array.from(selectedValues).join(', ');
                                        addMessage(combinedValue, 'user');
                                        conversationHistory.push({ role: "user", content: combinedValue });
                                        sendToAPI(conversationHistory);
                                    };
                                    optionsDiv.appendChild(doneBtn);
                                } else {
                                    // Single-select mode (original behavior)
                                    detectedButtons.forEach(option => {
                                        const button = document.createElement('button');
                                        button.className = 'response-button';
                                        button.textContent = option.label;
                                        button.onclick = () => selectOption(button, option.value);
                                        optionsDiv.appendChild(button);
                                    });
                                }

                                if (helpContent) {
                                    const infoBtn = document.createElement('button');
                                    infoBtn.className = 'info-help-button';
                                    infoBtn.title = 'Click for help';
                                    infoBtn.textContent = 'i';
                                    infoBtn.onclick = (e) => {
                                        e.stopPropagation();
                                        showHelpModal(helpContent.title, helpContent.content);
                                    };
                                    optionsDiv.appendChild(infoBtn);
                                }
                                messageContent.appendChild(optionsDiv);

                                setTimeout(() => {
                                    messagesContainer.scrollTo({
                                        top: messagesContainer.scrollHeight,
                                        behavior: 'smooth'
                                    });
                                }, 50);
                            }
                        }, 100);
                    } else {
                        document.querySelector('.chat-input-area').style.display = 'block';
                    }
                }
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTo({
                top: messagesContainer.scrollHeight,
                behavior: 'smooth'
            });
            return messageDiv;
        }

        function removeTypingIndicator() {
            const typing = document.getElementById('typing-indicator');
            if (typing) typing.remove();
        }

        function updateTypingMessage(message) {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.innerHTML = `<span style="color: var(--accent-gold);">${message}</span>`;
            }
        }

        function selectOption(button, value) {
            if (isProcessing) return;

            button.classList.add('selected');
            document.querySelectorAll('.response-button').forEach(btn => {
                btn.disabled = true;
                if (btn !== button) btn.style.opacity = '0.4';
            });
            document.querySelectorAll('.info-help-button').forEach(btn => {
                btn.disabled = true;
            });

            addMessage(value, 'user');
            conversationHistory.push({ role: "user", content: value });
            sendToAPI(conversationHistory);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message || isProcessing) return;

            input.value = '';
            addMessage(message, 'user');
            conversationHistory.push({ role: "user", content: message });
            sendToAPI(conversationHistory);
        }

        async function sendToAPI(messages, retryCount = 0) {
            apiCallDepth++;
            isProcessing = true;
            document.getElementById('send-button').disabled = true;

            if (retryCount === 0 && !document.getElementById('typing-indicator')) {
                addMessage('', 'assistant', true);
            }

            try {
                const response = await fetch(CONFIG.proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: CONFIG.model,
                        max_tokens: 4096,
                        system: SYSTEM_PROMPT,
                        tools: TOOLS,
                        messages: messages
                    })
                });

                if (response.status === 429 && retryCount < MAX_RETRIES) {
                    const delay = INITIAL_RETRY_DELAY * Math.pow(2, retryCount);
                    updateTypingMessage(`High demand - waiting ${Math.ceil(delay / 1000)}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return sendToAPI(messages, retryCount + 1);
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error ${response.status}: ${errorData.error?.message || JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                removeTypingIndicator();
                await processResponse(data);

            } catch (error) {
                console.error('API Error:', error);
                removeTypingIndicator();
                addMessage(`I apologize, but I encountered an error. Please refresh and try again.`, 'assistant');
            } finally {
                apiCallDepth--;
                if (apiCallDepth === 0) {
                    isProcessing = false;
                    document.getElementById('send-button').disabled = false;
                }
            }
        }

        async function processResponse(data) {
            let textContent = '';
            let toolUses = [];

            for (const block of data.content) {
                if (block.type === 'text' && block.text) {
                    textContent += block.text;
                } else if (block.type === 'tool_use') {
                    toolUses.push(block);
                }
            }

            const toolResults = [];
            if (toolUses.length > 0) {
                for (const tool of toolUses) {
                    const result = processToolUse(tool);
                    toolResults.push({
                        type: "tool_result",
                        tool_use_id: tool.id,
                        content: result || "Acknowledged"
                    });
                }
            }

            if (textContent) {
                addMessage(textContent, 'assistant');
            }

            const filteredContent = data.content.filter(block => {
                if (block.type === 'text') return block.text && block.text.trim().length > 0;
                return true;
            });

            if (filteredContent.length > 0) {
                conversationHistory.push({ role: "assistant", content: filteredContent });
            }

            if (toolUses.length > 0) {
                const hasComplete = toolUses.some(t => t.name === 'complete_pi_intake');
                if (hasComplete) return;

                if (toolResults.length > 0) {
                    conversationHistory.push({ role: "user", content: toolResults });
                    await sendToAPI(conversationHistory);
                }
            }
        }

        function processToolUse(tool) {
            const { name, input } = tool;

            switch (name) {
                case 'collect_contact_info':
                    collectedData.contact = input;
                    if (currentStep === 1) { currentStep = 2; updateProgressSteps(); }
                    return "Contact information collected.";

                case 'collect_incident_info':
                    collectedData.incident = input;
                    if (currentStep <= 2) { currentStep = 3; updateProgressSteps(); }
                    return "Incident information collected.";

                case 'collect_liability_info':
                    collectedData.liability = input;
                    if (currentStep <= 3) { currentStep = 4; updateProgressSteps(); }
                    return "Liability information collected.";

                case 'collect_damages_info':
                    collectedData.damages = input;
                    if (currentStep <= 4) { currentStep = 5; updateProgressSteps(); }
                    return "Damages information collected.";

                case 'show_question_help':
                    currentHelpContent = {
                        title: input.help_title,
                        content: input.help_content
                    };
                    return "Help content stored.";

                case 'complete_pi_intake':
                    collectedData.assessment = input;
                    sendWebhook(input);
                    showLoadingScreen(input);
                    return "Assessment complete.";

                default:
                    return "Tool not recognized.";
            }
        }

        // Send webhook with lead data
        async function sendWebhook(assessment) {
            if (!CONFIG.webhookUrl) return;

            const payload = {
                lead: collectedData.contact || {},
                incident: collectedData.incident || {},
                liability: collectedData.liability || {},
                damages: collectedData.damages || {},
                routing: assessment.routing,
                urgency: assessment.urgency,
                confidence_level: assessment.confidence_level,
                recommended_next_action: assessment.recommended_next_action,
                primary_disqualifier: assessment.primary_disqualifier || null,
                primary_strength_factor: assessment.primary_strength_factor || null,
                urgency_reason: assessment.urgency_reason || null,
                key_factors: assessment.key_factors || [],
                timestamp: new Date().toISOString(),
                source: 'pi-intake-v1'
            };

            try {
                await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': CONFIG.webhookKey || ''
                    },
                    body: JSON.stringify(payload)
                });
            } catch (error) {
                console.error('Webhook error:', error);
            }
        }

        function showLoadingScreen(assessment) {
            showScreen('loading-screen');

            const stages = ['incident', 'liability', 'damages'];
            let currentStage = 0;
            let progress = 0;

            const progressBar = document.getElementById('loading-progress-bar');

            const stageInterval = setInterval(() => {
                if (currentStage > 0) {
                    document.querySelector(`.loading-stage[data-stage="${stages[currentStage-1]}"]`).classList.remove('active');
                    document.querySelector(`.loading-stage[data-stage="${stages[currentStage-1]}"]`).classList.add('complete');
                }
                if (currentStage < stages.length) {
                    document.querySelector(`.loading-stage[data-stage="${stages[currentStage]}"]`).classList.add('active');
                    currentStage++;
                }
            }, 1000);

            const progressInterval = setInterval(() => {
                progress += 2;
                progressBar.style.width = `${Math.min(progress, 100)}%`;

                if (progress >= 100) {
                    clearInterval(progressInterval);
                    clearInterval(stageInterval);
                    setTimeout(() => showResults(assessment), 500);
                }
            }, 60);
        }

        function showResults(assessment) {
            if (assessment.routing === 'red') {
                showScreen('decline-screen');
                return;
            }

            showScreen('results-screen');

            // Update routing badge
            const routingBadge = document.getElementById('routing-badge');
            const routingText = document.getElementById('routing-text');

            if (assessment.routing === 'green') {
                routingBadge.className = 'routing-badge green';
                routingText.textContent = "We'd Like to Speak With You";
            } else if (assessment.routing === 'yellow') {
                routingBadge.className = 'routing-badge yellow';
                routingText.textContent = "We Need More Information";
            }

            // Update next steps
            const nextStepsText = document.getElementById('next-steps-text');
            if (assessment.routing === 'green') {
                nextStepsText.textContent = "Based on the information you provided, we believe you may have a case worth discussing. A member of our team will contact you within 24 hours to schedule a free consultation.";
            } else {
                nextStepsText.textContent = "We'd like to learn more about your case before scheduling a consultation. Please gather any medical records, photos, or police reports you may have. We'll reach out to discuss next steps.";
            }

            // Add factors
            const factorsList = document.getElementById('factors-list');
            factorsList.innerHTML = '';

            if (assessment.key_factors) {
                assessment.key_factors.forEach((factor, index) => {
                    setTimeout(() => {
                        const li = document.createElement('li');
                        li.className = 'factor-item';
                        const iconClass = factor.impact === 'positive' ? 'positive' :
                                         factor.impact === 'negative' ? 'negative' : 'neutral';
                        const iconPath = factor.impact === 'positive' ? 'M5 13l4 4L19 7' :
                                        factor.impact === 'negative' ? 'M6 18L18 6M6 6l12 12' :
                                        'M20 12H4';
                        li.innerHTML = `
                            <svg class="factor-icon ${iconClass}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconPath}" />
                            </svg>
                            <span class="factor-text">${factor.factor}</span>
                        `;
                        factorsList.appendChild(li);
                    }, index * 150);
                });
            }
        }

        function startOver() {
            showScreen('landing-screen');
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('consent-checkbox').checked = false;
            document.getElementById('consent-button').classList.remove('enabled');
            conversationHistory = [];
            collectedData = {};
            currentStep = 1;
            isProcessing = false;
            apiCallDepth = 0;
            currentHelpContent = null;
            updateProgressSteps();

            document.querySelectorAll('.loading-stage').forEach(stage => {
                stage.classList.remove('active', 'complete');
            });
            document.getElementById('loading-progress-bar').style.width = '0%';
        }
    </script>
</body>
</html>
