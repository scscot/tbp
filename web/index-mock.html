<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Build Pro | Recruit Better. Build Faster. Direct Sales Team Building App</title>
    <meta name="description" content="Smart technology built for relationship-driven success. Help recruiting prospects build momentum before Day 1. Accelerate growth across your entire team. Free for 30 days, then $4.99/mo.">
    <meta name="keywords" content="direct sales team building, recruiting app, momentum builder, relationship-driven sales, network marketing software, team management app, pre-launch recruiting, team growth accelerator, direct sales tools">
    <meta name="author" content="Team Build Pro">
    <meta name="robots" content="index, follow">
    <meta property="og:title" content="Team Build Pro | Recruit Better. Build Faster.">
    <meta property="og:description" content="Smart technology built for relationship-driven success. Help prospects build momentum before Day 1. Accelerate growth across your team. Free for 30 days, then $4.99/mo.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://teambuildpro.com">
    <meta property="og:image" content="https://teambuildpro.com/assets/icons/team-build-pro.png">
    <meta property="og:site_name" content="Team Build Pro">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Team Build Pro | Recruit Better. Build Faster.">
    <meta name="twitter:description" content="Recruit better. Build faster. Smart team building for direct sales professionals. Free for 30 days, then $4.99/mo.">
    <meta name="twitter:image" content="https://teambuildpro.com/assets/icons/team-build-pro.png">
    <meta name="twitter:site" content="@teambuildpro">

    <link rel="stylesheet" href="css/style-mock.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link rel="icon" href="assets/icons/team-build-pro.png" type="image/png" />
    <link rel="apple-touch-icon" href="assets/icons/team-build-pro.png" />

    <!-- reCAPTCHA Enterprise Script -->
    <script src="https://www.google.com/recaptcha/enterprise.js?render=6Lfwj5orAAAAADS--lFfBYWuz1b4LiQVUlOHZiyE"></script>
</head>
<body>
    <!-- Top Invite Bar (populated by JavaScript when referral exists) -->
    <div id="top-invite-bar" class="top-invite-bar"></div>

    <!-- Navigation -->
    <nav class="nav">
        <div class="container">
            <div class="nav-content">
                <div class="nav-logo">
                    <img src="assets/icons/team-build-pro.png" alt="Team Build Pro" style="width: 32px; height: 32px; border-radius: 50%;">
                    <span>Team Build Pro</span>
                </div>
                <!-- Sandwich Menu Button -->
                <button id="menu-btn" class="menu-btn" aria-label="Open menu" aria-haspopup="true" aria-expanded="false">
                    <span class="material-symbols-outlined">menu</span>
                </button>
                <!-- Dropdown Menu -->
                <div id="mobile-menu" class="mobile-menu" role="menu">
                    <a href="#solution" role="menuitem">Solution</a>
                    <a href="#platform" role="menuitem">Platform</a>
                    <a href="#pricing" role="menuitem">Pricing</a>
                    <a href="/faq.html" role="menuitem">FAQ</a>
                    <a href="/contact_us.html" role="menuitem">Contact Us</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <div id="personal-invite-container"></div>

                <!-- Trust badge row -->
                <div class="hero-trust">
                    <span class="platform-badge" id="hero-badge" aria-label="Compatibility badge">
                        Recruit Better. Build Faster.
                    </span>
                </div>

                <h1 class="hero-title" id="hero-headline">
                    Build teams<br>
                    that last
                </h1>
                <p class="hero-subtitle" id="hero-subheadline">
                    AI-driven recruiting meets mobile-first design.<br>
                    The modern system for direct sales professionals.
                </p>

                <!-- Trial offer badge -->
                <div class="hero-trial-badge">
                    <span class="trial-badge" aria-label="Trial offer">
                        Free for 30 days, then $4.99/mo. Cancel anytime.
                    </span>
                </div>

                <div class="hero-cta">
                    <div class="download-buttons" id="download-container">
                        <!-- Dynamically populated based on device detection -->
                    </div>
                    <div class="secondary-download" id="secondary-container">
                        <!-- Secondary option with smaller styling -->
                    </div>

                    <!-- Microcopy under primary CTA -->
                    <p class="hero-microcopy" role="note">
                        Team Build Pro is an app for your <strong>existing</strong> business—not an invitation to join one.
                    </p>
                </div>
            </div>
        </div>
        <div class="hero-gradient"></div>
    </section>

    <!-- Stats Section -->
    <section class="stats">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-item reveal-on-scroll">
                    <div class="stat-number">90%</div>
                    <div class="stat-label">Struggle with recruiting</div>
                </div>
                <div class="stat-item reveal-on-scroll">
                    <div class="stat-number">$4.99</div>
                    <div class="stat-label">Per month after trial</div>
                </div>
                <div class="stat-item reveal-on-scroll">
                    <div class="stat-number">30 days</div>
                    <div class="stat-label">Free trial period</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Problem Statement -->
    <section id="solution" class="problem">
        <div class="container">
            <div class="section-header">
                <h2>The challenge</h2>
                <p class="section-description">
                    Most direct sales representatives struggle—not from lack of ability,<br>
                    but from lack of system.
                </p>
            </div>
            <div class="problem-solution">
                <p class="solution-text">
                    Team Build Pro brings an innovative, mobile-first approach to creating and<br>
                    sustaining real momentum—no matter your experience level or opportunity.
                </p>
            </div>
        </div>
    </section>

    <!-- How It Works -->
    <section id="platform" class="how-it-works">
        <div class="container">
            <div class="section-header">
                <h2>How it works</h2>
                <p class="section-description">
                    Four simple steps to build unstoppable momentum.
                </p>
            </div>
            <div class="features-grid">
                <div class="feature-card reveal-on-scroll">
                    <div class="feature-number">01</div>
                    <h3>Set Your Foundation</h3>
                    <p>Customize the app with your opportunity details and referral link. This sets the stage for immediate and sustained growth.</p>
                </div>
                <div class="feature-card reveal-on-scroll">
                    <div class="feature-number">02</div>
                    <h3>AI Coach Guides You</h3>
                    <p>Get suggested messages, timing cues, and next steps. One tap to send targeted messages to recruiting prospects.</p>
                </div>
                <div class="feature-card reveal-on-scroll">
                    <div class="feature-number">03</div>
                    <h3>Build Smart, Not Hard</h3>
                    <p>Share with your recruiting prospects and current team members. Momentum quickly builds as messages and follow-ups stay on track.</p>
                </div>
                <div class="feature-card reveal-on-scroll">
                    <div class="feature-number">04</div>
                    <h3>Automatic Qualification</h3>
                    <p>When recruiting prospects hit achievable growth milestones, they're automatically invited to join your opportunity under you.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Platform -->
    <section class="platform">
        <div class="container">
            <div class="section-header">
                <h2>Your complete team building system</h2>
                <p class="section-description">
                    Fully customizable for your opportunity.<br>
                    Built to grow with you at every stage.
                </p>
            </div>
            <div class="platform-features">
                <div class="platform-item reveal-on-scroll">
                    <h3>Mobile-first design</h3>
                    <p>Work from anywhere, anytime. Built for iOS and Android with enterprise-grade security.</p>
                </div>
                <div class="platform-item reveal-on-scroll">
                    <h3>AI-powered insights</h3>
                    <p>Get personalized coaching and recommendations based on your team's activity and goals.</p>
                </div>
                <div class="platform-item reveal-on-scroll">
                    <h3>Real-time analytics</h3>
                    <p>Track progress, monitor milestones, and understand your team's growth with powerful dashboards.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Pricing -->
    <section id="pricing" class="pricing">
        <div class="container">
            <div class="section-header">
                <h2>Simple, transparent pricing</h2>
                <p class="section-description">
                    One plan. All features. No credit card required.
                </p>
            </div>
            <div class="pricing-card">
                <div class="pricing-header">
                    <div class="pricing-badge">30-Day Free Trial</div>
                    <div class="pricing-price">
                        <span class="price-amount">$4.99</span>
                        <span class="price-period">/month</span>
                    </div>
                </div>
                <ul class="pricing-features">
                    <li>Unlimited team members</li>
                    <li>AI-powered coaching</li>
                    <li>Real-time analytics</li>
                    <li>Secure messaging</li>
                    <li>Global team building</li>
                    <li>24/7 support</li>
                </ul>
                <a href="#" id="cta-pricing" class="btn btn-primary btn-full">Start free trial</a>
            </div>
        </div>
    </section>

    <!-- FAQ Section -->
    <section id="faq" class="faq-section">
        <div class="container">
            <div class="section-header">
                <h2>Frequently Asked Questions</h2>
                <p class="section-description">
                    Have questions? We've got answers. If you have other questions, feel free to reach out.
                </p>
            </div>
            <div class="faq">
                <div class="faq-item">
                    <button class="faq-button" onclick="toggleFAQ(1)">
                        <span>Is Team Build Pro a business opportunity?</span>
                        <span class="material-symbols-outlined faq-icon" id="icon-1">expand_more</span>
                    </button>
                    <div class="faq-content" id="content-1">
                        No. Team Build Pro is not a business opportunity or income platform of any kind. We are a
                        software tool designed exclusively to help professionals build and track their teams. We do
                        not provide any form of user compensation.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-button" onclick="toggleFAQ(2)">
                        <span>Who is this platform for?</span>
                        <span class="material-symbols-outlined faq-icon" id="icon-2">expand_more</span>
                    </button>
                    <div class="faq-content" id="content-2">
                        Our platform is perfect for direct sales professionals, affiliate marketers, team leaders,
                        and any entrepreneur looking to build a collaborative organization. Whether you're just
                        starting or you're a seasoned mentor, our tools scale with you.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-button" onclick="toggleFAQ(3)">
                        <span>Do I need a credit card for the free trial?</span>
                        <span class="material-symbols-outlined faq-icon" id="icon-3">expand_more</span>
                    </button>
                    <div class="faq-content" id="content-3">
                        No. You can enjoy full access to all premium features for 30 days completely free, with no
                        credit card required to start. You can decide to subscribe at any point during or after your
                        trial.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-button" onclick="toggleFAQ(4)">
                        <span>Can I cancel my subscription at any time?</span>
                        <span class="material-symbols-outlined faq-icon" id="icon-4">expand_more</span>
                    </button>
                    <div class="faq-content" id="content-4">
                        Yes. You can cancel your subscription at any time with no long-term commitments or
                        cancellation fees. You will retain access until the end of your current billing period.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-button" onclick="toggleFAQ(5)">
                        <span>What exactly does AI Coach do?</span>
                        <span class="material-symbols-outlined faq-icon" id="icon-5">expand_more</span>
                    </button>
                    <div class="faq-content" id="content-5">
                        AI Coach helps you navigate the Team Build Pro app, answers questions about features and qualification requirements, provides team building guidance, and can suggest which app sections to visit for specific tasks.
                    </div>
                </div>
                <div class="faq-item">
                    <button class="faq-button" onclick="toggleFAQ(6)">
                        <span>Is my data private?</span>
                        <span class="material-symbols-outlined faq-icon" id="icon-6">expand_more</span>
                    </button>
                    <div class="faq-content" id="content-6">
                        Yes. AI Coach works within your workspace context. Messages are only used to generate your responses and suggestions; nothing is shared with any company you recruit for.
                    </div>
                </div>
            </div>

            <!-- Link to comprehensive FAQ page -->
            <div class="section-footer" style="text-align: center; margin-top: 40px;">
                <a href="/faq.html" class="btn btn-secondary" style="display: inline-block;">
                    View All Questions & Answers →
                </a>
            </div>
        </div>
    </section>

    <!-- CTA -->
    <section class="cta">
        <div class="container">
            <h2 id="cta-final-headline">Ready to build your empire?</h2>
            <p id="cta-final-subheadline">Join thousands of professionals building teams faster than ever before.</p>
            <a href="#" id="cta-final" class="btn btn-primary">Get started free</a>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo">
                        <img src="assets/icons/team-build-pro.png" alt="Team Build Pro" style="width: 32px; height: 32px; border-radius: 50%;">
                        <span>Team Build Pro</span>
                    </div>
                    <p>&copy; <span id="currentYear"></span> Team Build Pro. All rights reserved.</p>
                </div>
                <div class="footer-links">
                    <a href="/#pricing">Pricing</a>
                    <a href="/faq.html">FAQ</a>
                    <a href="/contact_us.html">Contact</a>
                    <a href="/privacy_policy.html">Privacy Policy</a>
                    <a href="/terms_of_service.html">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- COMING SOON MODAL -->
    <div id="comingSoonModal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="signup-form">
                <h2 id="modal-header">🚀 Available Soon!</h2>
                <p id="modal-description">
                    Launching soon on Google Play<br>Get notified when it's available!
                </p>
                <form id="notificationForm" onsubmit="handleNotificationSignup(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="notificationFirstName" placeholder="First Name" required>
                        </div>
                        <div class="form-group">
                            <input type="text" id="notificationLastName" placeholder="Last Name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <input type="email" id="notificationEmail" placeholder="Enter your email address" required>
                    </div>
                    <!-- Demo Interest Section -->
                    <div class="form-group demo-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="demoInterest" tabindex="-1">
                            <span class="checkmark"></span>
                            <span class="checkbox-text">Check the box to preview the app on your Android device before it's officially available on Google Play</span>
                        </label>
                    </div>

                    <button type="submit" class="signup-btn" tabindex="0">
                        <span id="signup-btn-text">Notify Me When It's Ready!</span>
                    </button>
                </form>
                <button class="modal-close-btn" onclick="closeModal()">Maybe Later</button>
            </div>

            <div id="success-message" style="display: none;">
                <h2>✅ You're All Set!</h2>
                <div id="success-content">
                    <!-- Content will be dynamically inserted -->
                </div>
                <button class="modal-close-btn" onclick="closeModal()">Awesome!</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA45ZN9KUuaYT0OHYZ9DmX2Jc8028Ftcvc",
            authDomain: "teambuilder-plus-fe74d.firebaseapp.com",
            projectId: "teambuilder-plus-fe74d",
            storageBucket: "teambuilder-plus-fe74d.firebasestorage.app",
            messagingSenderId: "312163687148",
            appId: "1:312163687148:web:43385dff773dab0b3763c9",
            measurementId: "G-G4E4TBBPZ7"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ============================================================================
        // FIREBASE AUTH ACTION HANDLER FOR CUSTOM DOMAIN
        // ============================================================================

        function handleFirebaseAuthActions() {
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const actionCode = urlParams.get('oobCode');
            const continueUrl = urlParams.get('continueUrl');

            if (mode && actionCode) {
                console.log('Firebase Auth action detected:', mode);

                const mainElement = document.querySelector('main');
                const headerElement = document.querySelector('header');
                const footerElement = document.querySelector('footer');
                const comingSoonModal = document.getElementById('comingSoonModal');
                const bodyChildren = document.body.children;

                for (let i = 0; i < bodyChildren.length; i++) {
                    const child = bodyChildren[i];
                    if (child.tagName !== 'SCRIPT' && child.id !== 'auth-action-container') {
                        child.style.display = 'none';
                    }
                }

                if (mainElement) mainElement.style.display = 'none';
                if (headerElement) headerElement.style.display = 'none';
                if (footerElement) footerElement.style.display = 'none';
                if (comingSoonModal) comingSoonModal.style.display = 'none';

                const authContainer = document.createElement('div');
                authContainer.id = 'auth-action-container';
                authContainer.style.cssText = `
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    padding: 20px;
                `;

                const authCard = document.createElement('div');
                authCard.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    padding: 40px;
                    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
                    max-width: 500px;
                    width: 100%;
                    text-align: center;
                `;

                authCard.innerHTML = `
                    <img src="assets/icons/team-build-pro.png" alt="Team Build Pro" style="width: 64px; height: 64px; border-radius: 50%; margin-bottom: 20px;">
                    <h2 style="color: #333; margin-bottom: 20px;">Team Build Pro</h2>
                    <div id="auth-message">Processing your request...</div>
                `;

                authContainer.appendChild(authCard);
                document.body.appendChild(authContainer);

                switch (mode) {
                    case 'resetPassword':
                        handlePasswordReset(actionCode, continueUrl);
                        break;
                    case 'verifyEmail':
                        handleEmailVerification(actionCode, continueUrl);
                        break;
                    case 'recoverEmail':
                        handleEmailRecovery(actionCode, continueUrl);
                        break;
                    default:
                        showAuthError('Unknown action type. Please contact support.');
                }

                return true;
            }

            return false;
        }

        function handlePasswordReset(actionCode, continueUrl) {
            const messageDiv = document.getElementById('auth-message');

            auth.verifyPasswordResetCode(actionCode)
                .then((email) => {
                    messageDiv.innerHTML = `
                        <h3 style="color: #333; margin-bottom: 20px;">Reset Your Password</h3>
                        <p style="color: #666; margin-bottom: 20px;">Enter a new password for ${email}</p>
                        <form id="password-reset-form">
                            <input type="password" id="new-password" placeholder="New Password" required
                                   style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                            <input type="password" id="confirm-password" placeholder="Confirm Password" required
                                   style="width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box;">
                            <button type="submit" style="width: 100%; padding: 12px; margin: 20px 0 10px 0; background: #4F46E5; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                Update Password
                            </button>
                        </form>
                        <p style="color: #666; font-size: 14px;">After updating your password, you can sign in to the Team Build Pro app.</p>
                    `;

                    document.getElementById('password-reset-form').addEventListener('submit', (e) => {
                        e.preventDefault();

                        const newPassword = document.getElementById('new-password').value;
                        const confirmPassword = document.getElementById('confirm-password').value;

                        if (newPassword !== confirmPassword) {
                            alert('Passwords do not match. Please try again.');
                            return;
                        }

                        if (newPassword.length < 6) {
                            alert('Password must be at least 6 characters long.');
                            return;
                        }

                        auth.confirmPasswordReset(actionCode, newPassword)
                            .then(() => {
                                showAuthSuccess('Password updated successfully! You can now sign in to the Team Build Pro app with your new password.');
                            })
                            .catch((error) => {
                                console.error('Password reset error:', error);
                                showAuthError('Failed to update password. The link may have expired. Please request a new password reset.');
                            });
                    });
                })
                .catch((error) => {
                    console.error('Invalid action code:', error);
                    showAuthError('Invalid or expired reset link. Please request a new password reset from the app.');
                });
        }

        function handleEmailVerification(actionCode, continueUrl) {
            auth.applyActionCode(actionCode)
                .then(() => {
                    showAuthSuccess('Email verified successfully! You can now use all features of Team Build Pro.');
                })
                .catch((error) => {
                    console.error('Email verification error:', error);
                    showAuthError('Invalid or expired verification link. Please request a new verification email from the app.');
                });
        }

        function handleEmailRecovery(actionCode, continueUrl) {
            auth.checkActionCode(actionCode)
                .then((info) => {
                    const restoredEmail = info.data.email;

                    return auth.applyActionCode(actionCode).then(() => {
                        showAuthSuccess(`Email address ${restoredEmail} has been restored to your account.`);
                    });
                })
                .catch((error) => {
                    console.error('Email recovery error:', error);
                    showAuthError('Invalid or expired recovery link. Please contact support.');
                });
        }

        function showAuthSuccess(message) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.innerHTML = `
                <div style="color: #10B981; font-size: 48px; margin-bottom: 20px;">✅</div>
                <h3 style="color: #333; margin-bottom: 20px;">Success!</h3>
                <p style="color: #666; margin-bottom: 30px;">${message}</p>
                <button onclick="window.close()" style="padding: 12px 24px; background: #4F46E5; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 10px;">
                    Close
                </button>
                <a href="https://teambuildpro.com" style="padding: 12px 24px; background: #F3F4F6; color: #4F46E5; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; display: inline-block;">
                    Visit Website
                </a>
            `;
        }

        function showAuthError(message) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.innerHTML = `
                <div style="color: #EF4444; font-size: 48px; margin-bottom: 20px;">❌</div>
                <h3 style="color: #333; margin-bottom: 20px;">Action Failed</h3>
                <p style="color: #666; margin-bottom: 30px;">${message}</p>
                <a href="https://teambuildpro.com" style="padding: 12px 24px; background: #4F46E5; color: white; border: none; border-radius: 6px; font-weight: 600; text-decoration: none; display: inline-block;">
                    Back to Website
                </a>
            `;
        }

        // ============================================================================
        // DEVICE DETECTION & DOWNLOAD BUTTONS
        // ============================================================================

        function getDeviceType() {
            const userAgent = navigator.userAgent;
            const isIOS = /iPad|iPhone|iPod/.test(userAgent);
            const isAndroid = /Android/.test(userAgent);
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent);

            return {
                isIOS,
                isAndroid,
                isMobile,
                isDesktop: !isMobile
            };
        }

        function getReferralInfo() {
            if (window.location.protocol === "file:") return null;
            const urlParams = new URLSearchParams(window.location.search);
            const newProspectCode = urlParams.get("new");
            const partnerCode = urlParams.get("ref");
            const targetingParam = urlParams.get("t");

            if (newProspectCode && isValidReferralCode(newProspectCode)) {
                return { code: newProspectCode, type: "new", targeting: targetingParam };
            }
            if (partnerCode && isValidReferralCode(partnerCode)) {
                return { code: partnerCode, type: "partner", targeting: targetingParam };
            }
            return null;
        }

        function isValidReferralCode(code) {
            return (
                code &&
                code.trim().length >= 3 &&
                code.length <= 50 &&
                !/[:/\\]/.test(code) &&
                !/^(file|C:)/.test(code)
            );
        }

        function createInviteSection(firstName, lastName, referralType, bizOppName, photoUrl) {
            const inviteContainer = document.getElementById('personal-invite-container');
            const heroHeadline = document.getElementById('hero-headline');
            const heroSubheadline = document.getElementById('hero-subheadline');

            const avatarUrl = photoUrl || 'assets/images/default_avatar.png';
            const referrerFullName = `${firstName} ${lastName}`;
            const opportunityName = `<strong>${bizOppName || 'their opportunity'}</strong>`;

            const topInviteBar = document.getElementById('top-invite-bar');
            if (topInviteBar) {
                topInviteBar.innerHTML = `
                    <img src="${avatarUrl}" alt="${referrerFullName}" class="top-invite-avatar" onerror="this.src='assets/images/default_avatar.png';">
                    <span class="top-invite-text">Invited by ${referrerFullName}</span>
                `;
                topInviteBar.classList.add('visible');
            }

            inviteContainer.style.display = 'none';

            if (referralType === "new") {
                heroHeadline.innerHTML = `Pre-Build Your Foundation <br> <span class="accent">Before Launch!</span>`;
                heroSubheadline.innerHTML = `${referrerFullName} is inviting you to get a head start. Use the Team Build Pro app to pre-build your ${opportunityName} team before you officially join!`;
            } else {
                heroHeadline.innerHTML = `Most Direct Sales Professionals Struggle with Team Building<br><span class="accent">Old methods fade. AI-driven recruiting builds teams that last.</span>`;
                heroSubheadline.innerHTML = `Help recruiting prospects build momentum before Day 1.<br />Help existing team members accelerate their growth.`;
            }

            const heroBadge = document.getElementById('hero-badge');
            if (heroBadge) {
                heroBadge.style.display = 'none';
            }
        }

        async function fetchUserAndDisplayInvite(referralInfo) {
            try {
                const url = `https://us-central1-teambuilder-plus-fe74d.cloudfunctions.net/getUserByReferralCode?code=${referralInfo.code}`;
                const response = await fetch(url);

                if (!response.ok) {
                    console.error("Sponsor not found or server error:", response.status);
                    return;
                }

                const userData = await response.json();
                console.log("User data received:", userData);

                const photoUrl = userData.photoUrl || userData.photoURL || userData.profilePhotoUrl || null;
                console.log("Photo URL from database:", photoUrl);

                if (userData.firstName && userData.lastName) {
                    const bizOppName = userData.bizOppName || "their opportunity";
                    const validPhotoUrl = photoUrl && photoUrl.trim() !== '' ? photoUrl : null;
                    createInviteSection(
                        userData.firstName,
                        userData.lastName,
                        referralInfo.type,
                        bizOppName,
                        validPhotoUrl
                    );
                }
            } catch (error) {
                console.error("Error fetching user data by referral code:", error);
            }
        }

        (function () {
            if (typeof window.openAppOrStore === 'function') return;

            window.openAppOrStore = function openAppOrStore() {
                const APP_STORE_URL = 'https://apps.apple.com/app/team-build-pro/id6751211622';

                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

                if (!isIOS) {
                    window.location.href = APP_STORE_URL;
                    return;
                }

                const url = new URL(location.href);
                url.searchParams.delete('_ul');
                const params = url.search || '';
                const sep = params ? '&' : '?';
                const UNIVERSAL_LINK = 'https://teambuildpro.com/claim.html' + params + sep + '_ul=1';

                console.log('🔗 Navigating to UL:', UNIVERSAL_LINK);
                window.location.href = UNIVERSAL_LINK;
            };
        })();

        async function createAppStoreBadge(isPrimary = true) {
            return `
                <a href="https://apps.apple.com/app/team-build-pro/id6751211622" class="app-store-badge ${isPrimary ? 'primary' : 'secondary'}" onclick="openAppOrStore(); return false;" rel="noopener" style="display: inline-block; vertical-align: top;">
                    <img src="https://developer.apple.com/assets/elements/badges/download-on-the-app-store.svg"
                         alt="Download on the App Store" style="height: 60px;" />
                </a>
            `;
        }

        function createAndroidPreviewButton(isPrimary = true) {
            return `
                <a href="#" class="google-play-badge" onclick="event.preventDefault(); openModal();">
                    <img src="assets/images/Google-Play.png" alt="Get it on Google Play" />
                </a>
            `;
        }

        async function setupDownloadButtons() {
            const primaryContainer = document.getElementById('download-container');
            const secondaryContainer = document.getElementById('secondary-container');
            const device = getDeviceType();

            secondaryContainer.innerHTML = '';

            primaryContainer.style.display = 'flex';
            primaryContainer.style.flexWrap = 'wrap';
            primaryContainer.style.justifyContent = 'center';
            primaryContainer.style.alignItems = 'center';
            primaryContainer.style.gap = '12px';

            if (device.isIOS) {
                primaryContainer.innerHTML = await createAppStoreBadge(true) + createAndroidPreviewButton(false);
            } else if (device.isAndroid) {
                primaryContainer.innerHTML = createAndroidPreviewButton(true) + await createAppStoreBadge(false);
            } else {
                primaryContainer.innerHTML = await createAppStoreBadge(true) + createAndroidPreviewButton(false);
            }
        }

        async function setupBottomCTAs() {
            const ctaIds = ["cta-pricing", "cta-final"];

            for (const id of ctaIds) {
                const button = document.getElementById(id);
                if (!button) continue;

                const buttonsContainer = `
                    <div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 12px;">
                        <div style="height: 60px; display: flex; align-items: center;">
                            ${await createAppStoreBadge(true)}
                        </div>
                        <div style="height: 60px; display: flex; align-items: center;">
                            ${createAndroidPreviewButton(false)}
                        </div>
                    </div>
                `;

                button.outerHTML = buttonsContainer;
            }
        }

        async function updateCTAs() {
            await setupDownloadButtons();
            await setupBottomCTAs();
        }

        // ============================================================================
        // MODAL FUNCTIONALITY
        // ============================================================================

        const modal = document.getElementById("comingSoonModal");

        function openModal() {
            if (modal) {
                modal.style.display = "flex";
                setTimeout(() => {
                    const firstInput = document.getElementById('notificationFirstName');
                    if (firstInput) firstInput.focus();
                }, 100);
            }
        }

        function closeModal() {
            if (modal) {
                modal.style.display = "none";
                setTimeout(resetModal, 300);
            }
        }

        window.addEventListener("keydown", (event) => {
            if (event.key === "Escape") closeModal();
        });

        function trapTabInModal(event) {
            if (!modal || modal.style.display === "none") return;

            if (event.key === "Tab") {
                const focusableElements = modal.querySelectorAll(
                    'input:not([disabled]), button:not([disabled]), [tabindex]:not([tabindex="-1"]):not([disabled])'
                );
                const firstElement = focusableElements[0];
                const lastElement = focusableElements[focusableElements.length - 1];

                if (event.shiftKey) {
                    if (document.activeElement === firstElement) {
                        event.preventDefault();
                        lastElement.focus();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        event.preventDefault();
                        firstElement.focus();
                    }
                }
            }
        }

        document.addEventListener("keydown", trapTabInModal);

        async function handleNotificationSignup(event) {
            event.preventDefault();

            const firstNameInput = document.getElementById('notificationFirstName');
            const lastNameInput = document.getElementById('notificationLastName');
            const emailInput = document.getElementById('notificationEmail');
            const demoCheckbox = document.getElementById('demoInterest');
            const submitBtn = document.querySelector('.signup-btn');
            const btnText = document.getElementById('signup-btn-text');
            const signupForm = document.getElementById('signup-form');
            const successMessage = document.getElementById('success-message');

            const firstName = firstNameInput.value.trim();
            const lastName = lastNameInput.value.trim();
            const email = emailInput.value.trim();
            const wantDemo = demoCheckbox.checked;
            const deviceType = 'android';

            if (!firstName || !lastName) {
                alert('Please enter your first and last name.');
                return;
            }

            if (!email || !isValidEmail(email)) {
                alert('Please enter a valid email address.');
                return;
            }

            submitBtn.disabled = true;
            btnText.textContent = 'Verifying...';

            grecaptcha.enterprise.ready(async () => {
                try {
                    const token = await grecaptcha.enterprise.execute('6Lfwj5orAAAAADS--lFfBYWuz1b4LiQVUlOHZiyE', { action: 'notification_signup' });

                    btnText.textContent = 'Signing you up...';

                    await processNotificationSignup(firstName, lastName, email, wantDemo, deviceType, token, submitBtn, btnText, signupForm, successMessage);

                } catch (error) {
                    console.error('reCAPTCHA error:', error);
                    alert('Security verification failed. Please try again.');
                    submitBtn.disabled = false;
                    btnText.textContent = 'Notify Me When It\'s Ready!';
                }
            });
        }

        async function processNotificationSignup(firstName, lastName, email, wantDemo, deviceType, recaptchaToken, submitBtn, btnText, signupForm, successMessage) {
            try {
                const existingQuery = await db.collection('launch_notifications')
                    .where('email', '==', email)
                    .limit(1)
                    .get();

                let isNewSignup = false;
                let shouldSendEmail = false;
                let existingDoc = null;

                if (existingQuery.empty) {
                    const signupData = {
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        wantDemo: wantDemo,
                        deviceType: deviceType,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        source: 'website_modal',
                        userAgent: navigator.userAgent,
                        referrer: document.referrer || 'direct',
                        refUrl: window.location.href,
                        emailSent: false,
                        recaptchaToken: recaptchaToken
                    };

                    const docRef = await db.collection('launch_notifications').add(signupData);
                    console.log('New signup successful:', `${firstName} ${lastName} (${email})` + (wantDemo ? ` - Demo requested (${deviceType})` : ''));
                    isNewSignup = true;
                    shouldSendEmail = true;

                    if (wantDemo) {
                        try {
                            const notificationResponse = await fetch('https://us-central1-teambuilder-plus-fe74d.cloudfunctions.net/sendDemoNotification', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    firstName: firstName,
                                    lastName: lastName,
                                    email: email,
                                    deviceType: deviceType
                                })
                            });

                            const notificationResult = await notificationResponse.json();
                            if (notificationResult.success) {
                                console.log('✅ Demo notification email sent to admin');
                            } else {
                                console.warn('Failed to send notification:', notificationResult.error);
                            }
                        } catch (notificationError) {
                            console.error('Error sending demo notification:', notificationError);
                        }
                    }

                } else {
                    existingDoc = existingQuery.docs[0];
                    const existingData = existingDoc.data();
                    const existingWantDemo = existingData.wantDemo || false;

                    if (wantDemo && !existingWantDemo && deviceType) {
                        await existingDoc.ref.update({
                            wantDemo: true,
                            deviceType: deviceType,
                            demoRequestDate: firebase.firestore.FieldValue.serverTimestamp(),
                            refUrl: window.location.href,
                            emailSent: false,
                            recaptchaToken: recaptchaToken
                        });
                        console.log('Demo access added for existing user:', `${email} (${deviceType})`);
                        shouldSendEmail = true;

                        try {
                            const notificationResponse = await fetch('https://us-central1-teambuilder-plus-fe74d.cloudfunctions.net/sendDemoNotification', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    firstName: firstName,
                                    lastName: lastName,
                                    email: email,
                                    deviceType: deviceType
                                })
                            });

                            const notificationResult = await notificationResponse.json();
                            if (notificationResult.success) {
                                console.log('✅ Demo notification email sent to admin for existing user');
                            } else {
                                console.warn('Failed to send notification for existing user:', notificationResult.error);
                            }
                        } catch (notificationError) {
                            console.error('Error sending demo notification for existing user:', notificationError);
                        }

                    } else {
                        console.log('User already registered:', email);
                        showAlreadyRegisteredMessage();
                        signupForm.style.display = 'none';
                        successMessage.style.display = 'block';
                        return;
                    }
                }

                if (isNewSignup) {
                    showSuccessMessage(wantDemo, deviceType);
                } else {
                    showDemoAddedMessage(deviceType);
                }

                signupForm.style.display = 'none';
                successMessage.style.display = 'block';

                if (shouldSendEmail) {
                    try {
                        const response = await fetch('https://us-central1-teambuilder-plus-fe74d.cloudfunctions.net/sendLaunchNotificationConfirmation', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                firstName: firstName,
                                lastName: lastName,
                                email: email,
                                wantDemo: wantDemo,
                                deviceType: deviceType || null
                            })
                        });

                        if (response.ok) {
                            console.log('Confirmation email sent successfully');
                        }
                    } catch (confirmationError) {
                        console.log('Confirmation email failed, but signup was saved:', confirmationError);
                    }
                }

            } catch (error) {
                console.error('Error signing up for notifications:', error);
                alert('Sorry, there was an error. Please try again later.');

                submitBtn.disabled = false;
                btnText.textContent = 'Notify Me When It\'s Ready!';
            }
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showSuccessMessage(wantDemo, deviceType) {
            const successContent = document.getElementById('success-content');

            if (wantDemo && deviceType) {
                const deviceName = deviceType === 'ios' ? 'iPhone' : 'Android';
                successContent.innerHTML = `
                    <p><strong>Perfect! You're all set!</strong></p>
                    <p>📧 <strong>Your demo access email will be sent shortly!</strong> Check your inbox for step-by-step instructions on how to download and preview the app on your Android device.</p>
                    <p style="margin: 15px 0;">We'll also notify you when Team Build Pro officially launches on Google Play.</p>
                    <p><strong>Thanks for being an early supporter!</strong></p>
                `;
            } else {
                successContent.innerHTML = `
                    <p>Thanks for your interest! We'll send you an email as soon as Team Build Pro is officially available on Google Play.</p>
                `;
            }
        }

        function showDemoAddedMessage(deviceType) {
            const successContent = document.getElementById('success-content');
            const deviceName = deviceType === 'ios' ? 'iPhone' : 'Android';

            successContent.innerHTML = `
                <p><strong>Great news!</strong> You're all set!</p>
                <p style="margin: 15px 0;">📧 <strong>Demo access email sent!</strong> Check your inbox for step-by-step instructions on how to download and preview the app on your Android device.</p>
                <p><strong>Thanks for your interest!</strong></p>
            `;
        }

        function showAlreadyRegisteredMessage() {
            const successContent = document.getElementById('success-content');

            successContent.innerHTML = `
                <p><strong>You've already registered - we've got you covered!</strong></p>
                <p style="margin: 15px 0;">We'll notify you as soon as Team Build Pro is officially available on App Store and Google Play.</p>
                <p>Thanks for your continued interest! 🎉</p>
            `;
        }

        function resetModal() {
            const signupForm = document.getElementById('signup-form');
            const successMessage = document.getElementById('success-message');
            const firstNameInput = document.getElementById('notificationFirstName');
            const lastNameInput = document.getElementById('notificationLastName');
            const emailInput = document.getElementById('notificationEmail');
            const demoCheckbox = document.getElementById('demoInterest');
            const submitBtn = document.querySelector('.signup-btn');
            const btnText = document.getElementById('signup-btn-text');
            const demoSection = document.querySelector('.demo-section');

            signupForm.style.display = 'block';
            successMessage.style.display = 'none';

            firstNameInput.value = '';
            lastNameInput.value = '';
            emailInput.value = '';
            demoCheckbox.checked = false;
            submitBtn.disabled = false;
            btnText.textContent = 'Notify Me When It\'s Ready!';

            if (demoSection) {
                demoSection.classList.remove('show');
                const demoText = demoSection.querySelector('.checkbox-text');
                if (demoText) {
                    demoText.textContent = "Check the box to preview the app on your Android device before it's officially available on Google Play";
                }
            }

            const modalHeader = document.getElementById('modal-header');
            const modalDescription = document.getElementById('modal-description');
            if (modalHeader) {
                modalHeader.textContent = '🚀 Available Soon!';
            }
            if (modalDescription) {
                modalDescription.innerHTML = 'Launching soon on Google Play<br>Get notified when it\'s available!';
            }
        }

        // ============================================================================
        // FAQ TOGGLE
        // ============================================================================

        function toggleFAQ(index) {
            const content = document.getElementById(`content-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            for (let i = 1; i <= 6; i++) {
                if (i !== index) {
                    const otherContent = document.getElementById(`content-${i}`);
                    const otherIcon = document.getElementById(`icon-${i}`);
                    if (otherContent && otherIcon) {
                        otherContent.classList.remove("open");
                        otherIcon.textContent = 'expand_more';
                    }
                }
            }
            content.classList.toggle("open");
            icon.textContent = content.classList.contains('open') ? 'expand_less' : 'expand_more';
        }

        // ============================================================================
        // MENU FUNCTIONALITY
        // ============================================================================

        const menuBtn = document.getElementById('menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');
        const menuIcon = menuBtn.querySelector('.material-symbols-outlined');

        menuBtn.addEventListener('click', () => {
            const isOpen = mobileMenu.classList.toggle('open');
            menuBtn.setAttribute('aria-expanded', isOpen);
            menuIcon.textContent = isOpen ? 'close' : 'menu';
        });

        document.addEventListener('click', (event) => {
            if (!mobileMenu.contains(event.target) && !menuBtn.contains(event.target)) {
                if (mobileMenu.classList.contains('open')) {
                    mobileMenu.classList.remove('open');
                    menuBtn.setAttribute('aria-expanded', 'false');
                    menuIcon.textContent = 'menu';
                }
            }
        });

        // ============================================================================
        // SCROLL ANIMATIONS
        // ============================================================================

        const observer = new IntersectionObserver(
            (entries) => {
                entries.forEach((entry) => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add("revealed");
                    }
                });
            },
            { threshold: 0.1 }
        );

        document.querySelectorAll(".reveal-on-scroll").forEach((el) => observer.observe(el));

        // ============================================================================
        // INITIALIZATION
        // ============================================================================

        async function initializePage() {
            const referralInfo = getReferralInfo();

            if (referralInfo) {
                console.log("Processing referral:", referralInfo);
                await fetchUserAndDisplayInvite(referralInfo);
            } else {
                console.log("No referral code found. Displaying default content.");
            }

            await updateCTAs();
        }

        document.addEventListener("DOMContentLoaded", () => {
            if (!handleFirebaseAuthActions()) {
                (async () => {
                    await initializePage();
                })();
            }

            const currentYearEl = document.getElementById("currentYear");
            if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();

            const menuLinks = mobileMenu.querySelectorAll('a[role="menuitem"]');
            menuLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (mobileMenu.classList.contains('open')) {
                        mobileMenu.classList.remove('open');
                        menuBtn.setAttribute('aria-expanded', 'false');
                        menuIcon.textContent = 'menu';
                    }
                });
            });
        });

    </script>

    <!-- Fallback modal (shows when clipboard write is blocked) -->
    <style>
      #tbp-attrib-modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:9999}
      #tbp-attrib-card{width:min(520px,92vw);background:#fff;border-radius:12px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.2);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
      #tbp-toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111;color:#fff;padding:10px 16px;border-radius:8px;display:none;z-index:10000}
      .tbp-row{display:flex;gap:12px;align-items:center;margin-top:10px}
      .tbp-btn{background:#0a66ff;color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
      .tbp-btn.secondary{background:#eee;color:#111}
      code.tbp-code{user-select:all;display:block;background:#f6f6f6;padding:8px;border-radius:6px;font-size:13px}
      img#tbp-qr{width:180px;height:180px;border:1px solid #eee;border-radius:8px}
    </style>

    <div id="tbp-attrib-modal" role="dialog" aria-modal="true" aria-labelledby="tbp-title">
      <div id="tbp-attrib-card">
        <h3 id="tbp-title" style="margin:0 0 8px">Copy invite to your phone</h3>
        <p style="margin:0 0 8px">Copy the invite below or send it to your phone. After you install, the app will offer to apply it.</p>
        <code id="tbp-code" class="tbp-code">TBP_REF:—;TKN:—;T:—</code>
        <div class="tbp-row">
          <button id="tbp-copy" class="tbp-btn">Copy</button>
          <a id="tbp-sms" class="tbp-btn secondary" href="#">Send via SMS</a>
        </div>
        <div class="tbp-row" style="margin-top:14px">
          <img id="tbp-qr" alt="QR code for invite">
          <div style="font-size:13px;color:#444">Scan on your iPhone to auto-copy and open the App Store.</div>
        </div>
        <div class="tbp-row" style="justify-content:flex-end;margin-top:16px">
          <button id="tbp-cancel" class="tbp-btn secondary">Cancel</button>
          <button id="tbp-open-store" class="tbp-btn">Continue to App Store</button>
        </div>
      </div>
    </div>

    <div id="tbp-toast" role="status" aria-live="polite">Invite copied. Opening App Store…</div>

    <!-- Hardened attribution script -->
    <script>
      const TBP_FN_BASE   = 'https://us-central1-teambuilder-plus-fe74d.cloudfunctions.net';
      const APP_STORE_URL = 'https://apps.apple.com/app/team-build-pro/id6751211622';

      const QP = new URLSearchParams(location.search);
      const qp = k => QP.get(k) || '';

      let __toastTimeout = null;
      const toast = msg => {
        const el = document.getElementById('tbp-toast');
        if (__toastTimeout) {
          clearTimeout(__toastTimeout);
        }
        el.textContent = msg;
        el.style.display = 'block';
        __toastTimeout = setTimeout(() => {
          el.style.display = 'none';
          __toastTimeout = null;
        }, 2200);
      };

      const $modal = () => document.getElementById('tbp-attrib-modal');

      function openFallbackModal(payload){
        const code = document.getElementById('tbp-code');
        const sms  = document.getElementById('tbp-sms');
        const qr   = document.getElementById('tbp-qr');

        code.textContent = payload;

        const smsText = encodeURIComponent(`Team Build Pro invite\n\n${payload}\n\nOpen the app after install and accept the prompt to set your sponsor.`);
        const isAndroid = /Android/i.test(navigator.userAgent);
        sms.href = `sms:${isAndroid ? '?' : '&'}body=${smsText}`;

        const token   = (payload.match(/TKN:([A-Fa-f0-9]{32})/)||[])[1] || '';
        const t       = (payload.match(/T:([^;]*)$/)||[])[1] || '';
        const sponsor = qp('ref') || qp('new') || '';
        const claimUrl = `${location.origin}/claim.html?token=${encodeURIComponent(token)}&ref=${encodeURIComponent(sponsor)}&t=${encodeURIComponent(t)}`;
        qr.src = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(claimUrl)}`;

        document.getElementById('tbp-copy').onclick = async ()=> {
          try { await navigator.clipboard.writeText(payload); toast('Invite copied'); } catch(_) {}
        };
        document.getElementById('tbp-open-store').onclick = ()=> window.location.href = APP_STORE_URL;
        document.getElementById('tbp-cancel').onclick = ()=> $modal().style.display = 'none';

        $modal().style.display = 'flex';
      }

      (async function autoRedeemFromQuery(){
        const token = qp('token') || qp('tkn');
        if (!token) return;
        const sponsor = qp('ref') || qp('new') || '';
        const t = qp('t') || '1';
        const payload = `TBP_REF:${sponsor};TKN:${token};T:${t}`;
        try {
          await navigator.clipboard.writeText(payload);
          const debug = (new URLSearchParams(location.search).get('debug') === '1');
          if (debug) {
            const claimUrl = `${location.origin}/claim.html?tkn=${encodeURIComponent(token)}&ref=${encodeURIComponent(sponsor)}&t=${encodeURIComponent(t)}`;
            toast('Invite copied. Opening claim page…');
            setTimeout(() => window.location.href = claimUrl, 600);
          } else {
            toast('Invite copied. Opening App Store…');
            setTimeout(() => window.location.href = APP_STORE_URL, 600);
          }
        } catch {
          openFallbackModal(payload);
        }
      })();

      function tbpLog(event, payload = {}) {
        try {
          const url = `${TBP_FN_BASE}/tbpEventLog`;
          const body = JSON.stringify({
            e: event,
            ts: Date.now(),
            path: location.pathname,
            ref: (qp('ref') || qp('new') || ''),
            ...payload
          });
          navigator.sendBeacon(url, body);
        } catch(_) {}
      }

      async function copyAndGo(refParam, tParam){
        if (window.__tbpNavLock) {
          console.log('⚠️ Navigation already in progress, ignoring duplicate click');
          return;
        }
        window.__tbpNavLock = true;

        setTimeout(() => {
          window.__tbpNavLock = false;
          console.log('🔓 Navigation latch released');
        }, 4000);

        const sponsor = (refParam || qp('ref') || qp('new') || '').trim();
        const t = (tParam || qp('t') || '1').trim();
        const debug = (new URLSearchParams(location.search).get('debug') === '1');

        console.log('🚀 copyAndGo() called', { sponsor, t, debug });

        if (!sponsor && !debug) {
          console.log('🍎 PROD MODE: Organic install → App Store');
          toast('Opening App Store…');
          setTimeout(() => { window.location.href = APP_STORE_URL; }, 600);
          return;
        }

        const sourceType = sponsor ? 'web_button' : 'web_button_no_sponsor';
        if (!sponsor) {
          console.log('🔍 Analytics: Organic install (no sponsor code)');
        }

        const abortController = new AbortController();
        window.addEventListener('beforeunload', () => abortController.abort(), { once: true });

        console.log('📡 Starting issueReferralV2 fetch...', { sponsor, t, source: sourceType });
        const tokenPromise = fetch(`${TBP_FN_BASE}/issueReferralV2`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ sponsorCode: sponsor, t, source: sourceType }),
          signal: abortController.signal
        });

        const optimisticPayload = constructPayload(sponsor, '', t);
        const earlyClipSuccess = await tryClipboardWrite(optimisticPayload);

        tbpLog('clipboard_optimistic', {
          clipboard_optimistic_ok: earlyClipSuccess,
          payload_kind: 'ref_only',
          sponsor: sponsor || 'none'
        });

        if (earlyClipSuccess) {
          console.log('✅ Optimistic clipboard write successful (ref-only)');
        }

        try {
          const r = await tokenPromise;
          console.log('📡 issueReferralV2 response:', { ok: r.ok, status: r.status });

          if (!r.ok) {
            const errorText = await r.text();
            tbpLog('issue_failed', { status: r.status, sponsor, errorText });
            console.error('❌ issueReferralV2 failed:', r.status, errorText);

            if (debug) {
              openFallbackModal(constructPayload(sponsor, 'fallback_token', t));
            } else {
              toast('Unable to copy invite. Please try again.');
            }
            return;
          }

          const j = await r.json();
          console.log('✅ issueReferralV2 success:', { hasToken: !!j.token });

          if (!j.token) {
            tbpLog('issue_failed', { error: 'no_token', sponsor });
            console.error('❌ issueReferralV2: no token in response');

            if (debug) {
              openFallbackModal(constructPayload(sponsor, 'fallback_token', t));
            } else {
              toast('Unable to copy invite. Please try again.');
            }
            return;
          }

          const finalPayload = `TBP_REF:${sponsor};TKN:${j.token};T:${t};V:2`;
          console.log('📋 Final payload constructed:', finalPayload.substring(0, 50) + '...');

          let finalClipSuccess = false;

          const modernSuccess = await tryClipboardWrite(finalPayload);
          if (modernSuccess) {
            finalClipSuccess = true;
            console.log('✅ Final clipboard write successful (modern API)');
          } else {
            try {
              const legacySuccess = await legacyClipboardCopy(finalPayload);
              if (legacySuccess) {
                finalClipSuccess = true;
                console.log('✅ Final clipboard write successful (legacy fallback)');
              }
            } catch (e) {
              console.log('❌ Final clipboard write failed (both methods)');
            }
          }

          tbpLog('clipboard_final', {
            clipboard_final_ok: finalClipSuccess,
            payload_kind: finalClipSuccess ? 'full_token' : 'ref_only',
            sponsor: sponsor || 'none'
          });

          tbpLog('clipboard_result', {
            success: finalClipSuccess,
            method: earlyClipSuccess ? 'optimistic' : 'late',
            sponsor: sponsor || 'none'
          });

          if (debug) {
            const claimUrl = `${location.origin}/claim.html?tkn=${encodeURIComponent(j.token)}&ref=${encodeURIComponent(sponsor)}&t=${encodeURIComponent(t)}`;
            tbpLog('web_claim_redirect', { sponsor, t });
            console.log('🔍 DEBUG MODE: Redirecting to claim page');
            toast('Invite copied. Opening claim page…');
            setTimeout(() => window.location.href = claimUrl, 600);
          } else {
            if (sponsor) {
              console.log('🍎 PROD MODE: Referral install → UL → /claim.html fallback');
              toast('Invite copied. Opening app…');
              setTimeout(() => {
                try {
                  openAppOrStore();
                } catch (err) {
                  console.error('openAppOrStore failed, using fallback navigation:', err);
                  const params = window.location.search || '';
                  const UNIVERSAL_LINK = 'https://teambuildpro.com/' + (params.startsWith('?') ? params : ('?' + params));
                  const t0 = Date.now();
                  window.location.href = UNIVERSAL_LINK;
                  setTimeout(() => {
                    const elapsed = Date.now() - t0;
                    if (elapsed < 2000) {
                      window.location.replace(APP_STORE_URL);
                    }
                  }, 1500);
                }
              }, 600);
            } else {
              console.log('🍎 PROD MODE: Organic install → App Store');
              toast('Opening App Store…');
              setTimeout(() => { window.location.href = APP_STORE_URL; }, 600);
            }
          }

        } catch (err) {
          tbpLog('issue_failed', { error: String(err), sponsor });
          console.error('❌ issueReferralV2 network error:', err);

          if (debug) {
            openFallbackModal(constructPayload(sponsor, 'fallback_token', t));
          } else {
            toast('Network error. Please try again.');
          }
        }
      }

      function constructPayload(sponsor, token, t) {
        return `TBP_REF:${sponsor};TKN:${token};T:${t};V:2`;
      }

      async function legacyClipboardCopy(text) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
          const success = document.execCommand('copy');
          document.body.removeChild(textarea);
          return success;
        } catch (err) {
          document.body.removeChild(textarea);
          throw err;
        }
      }

      async function tryClipboardWrite(text) {
        if (!window.isSecureContext || !document.hasFocus()) {
          console.log('Clipboard blocked: insecure context or no focus');
          return false;
        }

        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e1) {
          console.log('Modern clipboard blocked, trying legacy method...');
          try {
            return await legacyClipboardCopy(text);
          } catch (e2) {
            console.error('Both clipboard methods failed:', e1, e2);
            return false;
          }
        }
      }

      document.addEventListener('click', (e) => {
        if (e.metaKey || e.ctrlKey || e.shiftKey || e.button !== 0) return;
        if (e.target.closest('#openApp')) return;

        const target = e.target.closest('.js-appstore-btn, [data-appstore], #cta-hero, #cta-pricing, #cta-final, #cta-footer, .app-store-badge');
        if (!target) return;

        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        const q = new URLSearchParams(location.search);
        const sponsor = q.get('ref') || q.get('new') || '';
        const ctaIdentifier = target.id || target.className || 'unknown-cta';

        tbpLog('web_cta_click', {
          sponsorPresent: sponsor !== '',
          cta: ctaIdentifier,
          capturePhase: true
        });

        copyAndGo();
      }, { capture: true });

      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          const ctaCount = document.querySelectorAll('.js-appstore-btn, [data-appstore], #cta-hero, #cta-pricing, #cta-final, #cta-footer, .app-store-badge').length;
          tbpLog('web_cta_binding_success', { ctaCount });
          console.log(`✅ Capture-phase handler bound to ${ctaCount} CTAs`);
        }, 1000);
      });

      document.addEventListener('DOMContentLoaded', () => {
        const Q = new URLSearchParams(location.search);
        const sponsor = Q.get('ref') || Q.get('new') || '';
        const t = Q.get('t') || '1';

        function setBanner(url) {
          let tag = document.querySelector('meta[name="apple-itunes-app"]');
          if (!tag) {
            tag = document.createElement('meta');
            tag.setAttribute('name', 'apple-itunes-app');
            document.head.appendChild(tag);
          }
          tag.setAttribute('content', `app-id=6751211622, app-argument=${url}`);
          console.log('✅ Smart App Banner configured:', url);
        }

        const argUrlRefOnly = `https://teambuildpro.com/claim.html?ref=${encodeURIComponent(sponsor)}&t=${encodeURIComponent(t)}&_ul=1`;
        setBanner(argUrlRefOnly);

        if (sponsor) {
          fetch(`${TBP_FN_BASE}/issueReferralV2`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ sponsorCode: sponsor, t, source: 'smart_app_banner' })
          })
          .then(r => r.json())
          .then(j => {
            if (j && j.token) {
              const argUrlWithToken = `${argUrlRefOnly}&tkn=${encodeURIComponent(j.token)}`;
              setBanner(argUrlWithToken);
            }
          })
          .catch(() => {});
        }
      });
    </script>

    <!-- Internal test banner (shows only with ?debug=1) -->
    <style>
      #tbp-debug-banner {
        position: fixed; top: 0; left: 0; right: 0;
        background: #1a3cff; color: #fff; z-index: 10001;
        font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
        padding: 8px 12px; display: none;
        box-shadow: 0 2px 10px rgba(0,0,0,.15);
      }
      #tbp-debug-banner a { color:#fff; text-decoration: underline; }
    </style>
    <div id="tbp-debug-banner">
      <strong>Internal Test Mode</strong> — CTAs will open <code>/claim.html</code> (not the App Store) to exercise referral handling.
      <span style="margin-left:10px">Remove <code>?debug=1</code> to return to normal.</span>
      <span style="float:right"><a href="#" id="tbp-exit-debug">Exit</a></span>
    </div>
    <script>
      (function(){
        const Q = new URLSearchParams(location.search);
        const isDebug = Q.get('debug') === '1';
        if (!isDebug) return;
        const bar = document.getElementById('tbp-debug-banner');
        bar.style.display = 'block';
        document.getElementById('tbp-exit-debug').onclick = (e)=>{
          e.preventDefault();
          Q.delete('debug');
          const base = location.origin + location.pathname + (Q.toString() ? ('?' + Q.toString()) : '');
          history.replaceState(null, '', base);
          location.reload();
        };
      })();
    </script>

</body>
</html>
