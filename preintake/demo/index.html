<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-V5DR80KWBP"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-V5DR80KWBP');
    </script>
    <meta name="robots" content="noindex, nofollow">
    <title>Your Demo | PreIntake.ai</title>
    <meta name="description" content="Experience AI-powered legal intake for your firm.">
    <link rel="icon" type="image/svg+xml" href="/images/icon.svg">
    <link rel="apple-touch-icon" href="/images/icon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <script src="/js/components.js"></script>
    <style>
        /* Demo page specific styles */
        :root {
            --header-h: 72px; /* fallback, overwritten by JS measurement */
        }

        html, body {
            overflow-x: hidden;
        }

        body {
            background: var(--primary-dark, #0a1628); /* mask any tiny rounding gaps */
        }

        /* Iframe container (full width below header) */
        .demo-iframe-container {
            width: 100%;
            height: calc(100vh - var(--header-h));
            height: calc(100dvh - var(--header-h));
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-blue) 50%, var(--primary-dark) 100%);
        }

        .demo-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Exit confirmation modal */
        .exit-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 22, 40, 0.95);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            padding: 1.5rem;
        }

        .exit-modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .exit-modal {
            background: white;
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 480px;
            width: 100%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .exit-modal-icon {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
        }

        .exit-modal-icon svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .exit-modal h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--primary-dark);
            margin-bottom: 1rem;
        }

        .exit-modal p {
            color: #64748b;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .exit-modal-email {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .exit-modal-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .exit-modal-btn-continue {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-light) 50%, var(--accent-gold) 100%);
            color: var(--primary-dark);
            font-size: 1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .exit-modal-btn-continue:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 169, 98, 0.4);
        }

        .exit-modal-btn-leave {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem 2rem;
            background: transparent;
            color: #64748b;
            font-size: 0.95rem;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .exit-modal-btn-leave:hover {
            background: #f8fafc;
            color: #475569;
            border-color: #cbd5e1;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .exit-modal {
                padding: 2rem 1.5rem;
            }

            .exit-modal h2 {
                font-size: 1.25rem;
            }
        }
    </style>
    <script>
    // Dynamically measure header height and set CSS variable
    (function() {
        function setHeaderH() {
            const host = document.getElementById('preintake-header');
            if (!host) return false;

            // components.js injects a <header> inside the container
            const headerEl = host.querySelector('header') || host.firstElementChild || host;
            if (!headerEl) return false;

            const cs = getComputedStyle(headerEl);
            const mb = parseFloat(cs.marginBottom) || 0;
            const h = Math.ceil(headerEl.getBoundingClientRect().height + mb);

            if (h > 0) {
                document.documentElement.style.setProperty('--header-h', h + 'px');
                return true;
            }
            return false;
        }

        // Retry until header is rendered
        const trySet = () => setHeaderH() || setTimeout(trySet, 50);

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', trySet);
        } else {
            trySet();
        }

        window.addEventListener('load', setHeaderH);
        window.addEventListener('resize', setHeaderH);
    })();
    </script>
</head>
<body>
    <div id="preintake-header"></div>

    <!-- Demo Iframe Container (loads immediately) -->
    <div class="demo-iframe-container visible" id="demo-iframe-container">
        <iframe class="demo-iframe" id="demo-iframe" src="" title="PreIntake Demo"></iframe>
    </div>

    <!-- Exit Confirmation Modal -->
    <div class="exit-modal-overlay" id="exit-modal">
        <div class="exit-modal">
            <div class="exit-modal-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2>Complete the Demo?</h2>
            <p>To see the full value of PreIntake.ai, complete the intake conversation. You'll receive a sample lead notification at:</p>
            <p class="exit-modal-email" id="exit-modal-email">your email</p>
            <p style="margin-top: 1rem; font-size: 0.9rem;">This shows exactly what your team receives for every inquiry.</p>
            <div class="exit-modal-buttons">
                <button class="exit-modal-btn-continue" id="exit-modal-continue">
                    Continue Demo
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                </button>
                <button class="exit-modal-btn-leave" id="exit-modal-leave">
                    Leave Anyway
                </button>
            </div>
        </div>
    </div>

    <script>
    (function() {
        'use strict';

        // =========================================================================
        // CONFIGURATION
        // =========================================================================
        const STATUS_ENDPOINT = 'https://us-west1-teambuilder-plus-fe74d.cloudfunctions.net/getPreIntakeFirmStatus';
        const TRACK_ENDPOINT = 'https://us-west1-teambuilder-plus-fe74d.cloudfunctions.net/trackDemoView';

        // =========================================================================
        // STATE
        // =========================================================================
        let demoLeadId = null;
        let firmName = null;
        let deliveryEmail = null;
        let demoStarted = false;
        let intakeCompleted = false;
        let pendingNavUrl = null;

        // =========================================================================
        // INITIALIZATION
        // =========================================================================
        function init() {
            // Parse URL params
            const urlParams = new URLSearchParams(window.location.search);
            demoLeadId = urlParams.get('demo');

            // If no demo ID, redirect to homepage
            if (!demoLeadId) {
                window.location.href = '/';
                return;
            }

            // Track visit AND view together (demo auto-loads now)
            fetch(`${TRACK_ENDPOINT}?firmId=${demoLeadId}&type=visit`).catch(() => {});
            fetch(`${TRACK_ENDPOINT}?firmId=${demoLeadId}&type=view`).catch(() => {});

            // Fetch firm status to get firm name and delivery email
            fetchFirmStatus();

            // Update header button to "Get Started"
            updateHeaderButton();

            // Auto-load the demo immediately
            loadDemo();

            // Setup event listeners (exit modal only now)
            setupEventListeners();

            // Intercept header navigation clicks
            interceptHeaderNavigation();

            // Listen for postMessages from iframe
            window.addEventListener('message', handlePostMessage);
        }

        // =========================================================================
        // FIRM STATUS
        // =========================================================================
        function fetchFirmStatus() {
            const exitModalEmailEl = document.getElementById('exit-modal-email');

            fetch(`${STATUS_ENDPOINT}?leadId=${demoLeadId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data) return;

                    // Store firm name for internal use
                    if (data.firmName) {
                        firmName = cleanFirmNameForDisplay(data.firmName);
                    }

                    // Update delivery email for exit modal
                    if (data.deliveryEmail) {
                        deliveryEmail = data.deliveryEmail;
                        exitModalEmailEl.textContent = deliveryEmail;
                    }

                    // If already subscribed, could show different messaging
                    if (data.subscriptionStatus === 'active') {
                        console.log('Account already active');
                    }
                })
                .catch(err => {
                    console.warn('Status check failed:', err);
                });
        }

        // =========================================================================
        // HEADER CUSTOMIZATION
        // =========================================================================
        function updateHeaderButton() {
            // Wait for header to render
            setTimeout(() => {
                const accountBtn = document.querySelector('.nav-account');
                if (accountBtn) {
                    accountBtn.href = `/create-account.html?firm=${demoLeadId}`;
                    accountBtn.textContent = 'Get Started â†’';
                    accountBtn.classList.add('nav-get-started');
                }

                // Remove "Demo" link - redundant on demo page
                const demoLink = document.querySelector('.nav-menu a[href*="demo"]');
                if (demoLink) {
                    demoLink.remove();
                }
            }, 100);
        }

        function interceptHeaderNavigation() {
            // Wait for header to render
            setTimeout(() => {
                const navLinks = document.querySelectorAll('.nav-menu a:not(.nav-get-started)');
                navLinks.forEach(link => {
                    link.addEventListener('click', handleNavClick);
                });

                // Also intercept logo click
                const logo = document.querySelector('.logo');
                if (logo) {
                    logo.addEventListener('click', handleNavClick);
                }
            }, 100);
        }

        function handleNavClick(e) {
            // If intake completed, allow normal navigation (user finished demo)
            if (intakeCompleted) return;

            e.preventDefault();

            // ALWAYS store demo context for the destination page
            sessionStorage.setItem('tbp_demo_id', demoLeadId);
            if (firmName) sessionStorage.setItem('tbp_demo_firm', firmName);
            if (deliveryEmail) sessionStorage.setItem('tbp_demo_email', deliveryEmail);

            // If demo started but not completed, show exit confirmation
            if (demoStarted) {
                pendingNavUrl = e.currentTarget.href;
                showExitModal();
                return;
            }

            // Demo not started - navigate directly with explore flag
            navigateWithExploreFlag(e.currentTarget.href);
        }

        function navigateWithExploreFlag(url) {
            // Parse URL to handle hash fragments correctly
            // Query string must come BEFORE hash: /?explore=1#pricing (not /#pricing?explore=1)
            try {
                const urlObj = new URL(url, window.location.origin);
                urlObj.searchParams.set('explore', '1');
                window.location.href = urlObj.toString();
            } catch (err) {
                // Fallback for relative URLs
                if (url.includes('?')) {
                    window.location.href = url + '&explore=1';
                } else if (url.includes('#')) {
                    // Insert query before hash
                    const hashIndex = url.indexOf('#');
                    window.location.href = url.slice(0, hashIndex) + '?explore=1' + url.slice(hashIndex);
                } else {
                    window.location.href = url + '?explore=1';
                }
            }
        }

        // =========================================================================
        // DEMO FLOW
        // =========================================================================
        function loadDemo() {
            demoStarted = true;

            // Store in sessionStorage for header button state
            sessionStorage.setItem('tbp_demo_viewed', demoLeadId);

            // Load iframe immediately
            const iframe = document.getElementById('demo-iframe');
            iframe.src = `https://preintake.ai/demo/${demoLeadId}?embed=true&skip_onboarding=true&_t=${Date.now()}`;
        }

        // =========================================================================
        // EXIT CONFIRMATION MODAL
        // =========================================================================
        function showExitModal() {
            document.getElementById('exit-modal').classList.add('show');
        }

        function hideExitModal() {
            document.getElementById('exit-modal').classList.remove('show');
            pendingNavUrl = null;
        }

        function handleContinueDemo() {
            hideExitModal();
        }

        function handleLeaveDemo() {
            hideExitModal();

            // Track explore event (user chose to explore site instead of starting demo)
            fetch(`${TRACK_ENDPOINT}?firmId=${demoLeadId}&type=explore`).catch(() => {});

            // Store demo context in sessionStorage for destination page
            // (needed for "I'll explore" link which doesn't go through handleNavClick)
            sessionStorage.setItem('tbp_demo_id', demoLeadId);
            if (firmName) sessionStorage.setItem('tbp_demo_firm', firmName);
            if (deliveryEmail) sessionStorage.setItem('tbp_demo_email', deliveryEmail);

            // Navigate with explore flag
            navigateWithExploreFlag(pendingNavUrl || '/');
        }

        // =========================================================================
        // POSTMESSAGE HANDLER
        // =========================================================================
        function handlePostMessage(e) {
            if (!e.data || !e.data.type) return;

            switch (e.data.type) {
                case 'demo-started':
                    // Capture delivery email from iframe
                    if (e.data.firmEmail) {
                        deliveryEmail = e.data.firmEmail;
                        document.getElementById('exit-modal-email').textContent = deliveryEmail;
                    }
                    break;

                case 'intake-completed':
                    // Mark intake as completed - disable exit confirmation
                    intakeCompleted = true;
                    break;

                case 'demo-complete':
                    // Demo fully completed (user clicked OK on success modal)
                    intakeCompleted = true;
                    // Demo page has no floating buttons - iframe stays visible
                    // User can navigate away via header or Get Started button
                    break;

                case 'demo-complete-redirect':
                    // User wants to go somewhere after demo
                    intakeCompleted = true;
                    if (e.data.redirectUrl && e.data.redirectUrl !== '/') {
                        window.location.href = e.data.redirectUrl;
                    }
                    // If no redirect URL, iframe stays visible
                    break;
            }
        }

        // =========================================================================
        // EVENT LISTENERS
        // =========================================================================
        function setupEventListeners() {
            // Exit modal buttons
            document.getElementById('exit-modal-continue').addEventListener('click', handleContinueDemo);
            document.getElementById('exit-modal-leave').addEventListener('click', handleLeaveDemo);
        }

        // =========================================================================
        // UTILITY
        // =========================================================================
        function cleanFirmNameForDisplay(name) {
            if (!name) return '';
            // Strip ", Attorney at Law" suffix for cleaner display in banner
            return name.trim().replace(/,?\s*Attorney at Law$/i, '');
        }

        // =========================================================================
        // RUN
        // =========================================================================
        document.addEventListener('DOMContentLoaded', init);
    })();
    </script>
</body>
</html>
